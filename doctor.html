<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Portal - MyMedPH</title>
    
    <!-- Clinic Configuration -->
    <script src="config.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0066cc',
                        secondary: '#00cc66',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast { animation: slideIn 0.3s ease-out; }
        .sidebar { transition: transform 0.3s ease-out; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
        }
        .nav-btn.active { background-color: rgba(255, 255, 255, 0.1); }
        .sortable-ghost { opacity: 0.4; background: #e0e7ff; }
        .sortable-drag { opacity: 1; cursor: grabbing !important; transform: rotate(2deg); }
        .sortable-chosen { background: #f3f4f6; }
        .kanban-column { min-height: 200px; transition: background-color 0.2s ease; }
        .kanban-column.drag-over { background-color: rgba(59, 130, 246, 0.1); }
        
        /* Flatpickr Custom Styles */
        .flatpickr-calendar {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            border: none;
        }
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange {
            background: #0066cc !important;
            border-color: #0066cc !important;
        }
        .flatpickr-day.inRange {
            background: rgba(0, 102, 204, 0.1);
            border-color: rgba(0, 102, 204, 0.2);
        }
        .flatpickr-day:hover {
            background: rgba(0, 102, 204, 0.2);
        }
        .flatpickr-months .flatpickr-month {
            background: #0066cc;
            color: white;
        }
        .flatpickr-current-month .flatpickr-monthDropdown-months {
            background: #0066cc;
        }
        .flatpickr-weekdays {
            background: #f3f4f6;
        }
        
        
    </style>
</head>
<body class="bg-gray-100">
    <div class="bg-white shadow-md sticky top-0 z-40">
        <div class="flex items-center justify-between px-6 py-4">
            <div class="flex items-center space-x-4">
                <button onclick="toggleSidebar()" class="md:hidden text-gray-700 text-2xl"><i class="fas fa-bars"></i></button>
                <div class="flex items-center space-x-3">
                    <i class="fas fa-heartbeat text-primary text-2xl"></i>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">MyMedPH</h1>
                        <p class="text-xs text-gray-600">Doctor Portal</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-gray-700 font-semibold hidden md:inline" id="user-name"></span>
                
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">
                    <i class="fas fa-sign-out-alt mr-2"></i><span class="hidden md:inline">Logout</span>
                </button>
            </div>
        </div>
    </div>
    
    <div class="flex">
        <div id="sidebar" class="sidebar fixed md:static inset-y-0 left-0 z-50 w-64 bg-gray-800 text-white md:block h-screen overflow-y-auto">
            <nav class="p-4 space-y-2 mt-16 md:mt-4">
                <button onclick="showSection('kanban')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition active">
                    <i class="fas fa-columns mr-3"></i><span>Appointment Board</span>
                </button>
                <button onclick="showSection('profile')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-user-circle mr-3"></i><span>Profile</span>
                </button>
                <button onclick="showSection('services')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-briefcase-medical mr-3"></i><span>Services</span>
                </button>
                <button onclick="showSection('availability')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-calendar-alt mr-3"></i><span>Availability</span>
                </button>
                <button onclick="showSection('patients')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-user-injured mr-3"></i><span>My Patients</span>
                </button>
            </nav>
        </div>
        
        <div class="flex-1 p-6 overflow-y-auto">
            <!-- Kanban Board -->
            <div id="section-kanban" class="section">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-gray-800" id="kanban-title">Appointment Board</h2>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2 text-sm">
                            <i class="fas fa-calendar-alt text-primary mr-2"></i><span>Filter by Date Range</span>
                        </label>
                        <input type="text" id="kanban-date-filter" placeholder="Select date range (optional)" class="px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition cursor-pointer" readonly>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-blue-800">Booked</h3>
                            <span class="bg-blue-200 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold" id="count-booked">0</span>
                        </div>
                        <div id="kanban-booked" class="kanban-column space-y-2"></div>
                    </div>
                    
                    <div class="bg-purple-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-purple-800">Approve</h3>
                            <span class="bg-purple-200 text-purple-800 px-2 py-1 rounded-full text-xs font-semibold" id="count-approve">0</span>
                        </div>
                        <div id="kanban-approve" class="kanban-column space-y-2"></div>
                    </div>
                    
                    <div class="bg-green-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-green-800">Appointment</h3>
                            <span class="bg-green-200 text-green-800 px-2 py-1 rounded-full text-xs font-semibold" id="count-appointment">0</span>
                        </div>
                        <div id="kanban-appointment" class="kanban-column space-y-2"></div>
                    </div>
                    
                    <div class="bg-orange-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-orange-800">Missed</h3>
                            <span class="bg-orange-200 text-orange-800 px-2 py-1 rounded-full text-xs font-semibold" id="count-missed">0</span>
                        </div>
                        <div id="kanban-missed" class="kanban-column space-y-2"></div>
                    </div>
                    
                    <div class="bg-red-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-red-800">Cancelled</h3>
                            <span class="bg-red-200 text-red-800 px-2 py-1 rounded-full text-xs font-semibold" id="count-cancelled">0</span>
                        </div>
                        <div id="kanban-cancelled" class="kanban-column space-y-2"></div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-gray-800">Completed</h3>
                            <span class="bg-gray-200 text-gray-800 px-2 py-1 rounded-full text-xs font-semibold" id="count-completed">0</span>
                        </div>
                        <div id="kanban-completed" class="kanban-column space-y-2"></div>
                    </div>
                </div>
            </div>
            
            <!-- Profile Section -->
            <div id="section-profile" class="section hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">
                    <i class="fas fa-user-circle text-primary mr-2"></i>My Profile
                </h2>
                
                <div class="max-w-4xl mx-auto space-y-6">
                    
                    <!-- Doctor UID Card -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-primary rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-key text-primary mr-2"></i>Your Doctor UID
                        </h3>
                        <div class="bg-white rounded-lg p-4 border-2 border-primary">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600 mb-1">Your Unique Identifier</p>
                                    <code id="doctor-uid" class="text-2xl font-mono font-bold text-primary block">Loading...</code>
                                </div>
                                <button onclick="copyUID()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold shadow-md">
                                    <i class="fas fa-copy mr-2"></i>Copy UID
                                </button>
                            </div>
                        </div>
                        <div class="mt-4 bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                            <p class="text-sm text-yellow-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                <strong>Important:</strong> Share this UID with clinic administrators to join additional clinics. Keep it private and secure.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Personal Information -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-user text-primary mr-2"></i>Personal Information
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Full Name</label>
                                <input type="text" id="profile-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Email</label>
                                <input type="email" id="profile-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Phone</label>
                                <input type="tel" id="profile-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Specialty</label>
                                <input type="text" id="profile-specialty" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Professional Information -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-briefcase text-primary mr-2"></i>Professional Information
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">License Number</label>
                                <input type="text" id="profile-license" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Years of Experience</label>
                                <input type="number" id="profile-experience" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-gray-700 font-semibold mb-2">Education</label>
                                <textarea id="profile-education" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" placeholder="e.g., DDS from University of..."></textarea>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-gray-700 font-semibold mb-2">Bio / About Me</label>
                                <textarea id="profile-bio" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" placeholder="Tell patients about yourself..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Social Media Links -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-share-alt text-primary mr-2"></i>Social Media & Links
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fab fa-facebook text-blue-600 mr-2"></i>Facebook
                                </label>
                                <input type="url" id="profile-facebook" placeholder="https://facebook.com/..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fab fa-instagram text-pink-600 mr-2"></i>Instagram
                                </label>
                                <input type="url" id="profile-instagram" placeholder="https://instagram.com/..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fab fa-linkedin text-blue-700 mr-2"></i>LinkedIn
                                </label>
                                <input type="url" id="profile-linkedin" placeholder="https://linkedin.com/in/..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-globe text-green-600 mr-2"></i>Website
                                </label>
                                <input type="url" id="profile-website" placeholder="https://..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Save Button -->
                    <div class="flex justify-end space-x-3">
                        <button onclick="saveProfile()" class="bg-primary text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition font-semibold shadow-lg">
                            <i class="fas fa-save mr-2"></i>Save Profile
                        </button>
                    </div>
                    
                </div>
            </div>
            
            <!-- Services Section -->
            <div id="section-services" class="section hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Manage Services</h2>
                
                <!-- Tab Navigation -->
                <div class="bg-white rounded-xl shadow-lg mb-6">
                    <div class="flex border-b">
                        <button onclick="switchServiceTab('my-services')" id="tab-my-services" class="service-tab flex-1 px-6 py-4 font-semibold text-gray-700 border-b-2 border-primary bg-blue-50 transition">
                            <i class="fas fa-list mr-2"></i><span>My Services</span>
                        </button>
                        <button onclick="switchServiceTab('browse-global')" id="tab-browse-global" class="service-tab flex-1 px-6 py-4 font-semibold text-gray-500 border-b-2 border-transparent hover:bg-gray-50 transition">
                            <i class="fas fa-globe mr-2"></i><span>Browse Global Services</span>
                        </button>
                    </div>
                </div>
                
                <!-- My Services Tab Content -->
                <div id="tab-content-my-services" class="tab-content">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <button onclick="showAddServiceModal()" class="bg-gradient-to-r from-primary to-blue-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition">
                            <i class="fas fa-plus mr-2"></i><span>Create Custom Service</span>
                        </button>
                    </div>
                    <div id="services-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
                
                <!-- Browse Global Services Tab Content -->
                <div id="tab-content-browse-global" class="tab-content hidden">
                    <div class="bg-blue-50 border-l-4 border-primary p-4 mb-6 rounded-lg">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-primary text-xl mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-bold text-gray-800 mb-1">Global Services</h4>
                                <p class="text-sm text-gray-700">
                                    These are clinic-wide services created by the administrator. You can add them to your profile and customize pricing or duration.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search and Filter -->
                    <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <input type="text" id="global-service-search" placeholder="Search services..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                            </div>
                            <div>
                                <select id="global-service-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                    <option value="">All Categories</option>
                                    <option value="Consultation">ü©∫ Consultation</option>
                                    <option value="Dental">ü¶∑ Dental</option>
                                    <option value="Procedure">üíâ Procedure</option>
                                    <option value="Follow-up">üìÖ Follow-up</option>
                                    <option value="Surgery">üë®‚Äç‚öïÔ∏è Surgery</option>
                                    <option value="Therapy">‚ù§Ô∏è Therapy</option>
                                    <option value="General Checkup">üìã General Checkup</option>
                                    <option value="Emergency">üöë Emergency</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="global-services-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            </div>
            
            <!-- Availability Section -->
            <div id="section-availability" class="section hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6"><span>‚öôÔ∏è Manage Availability</span></h2>
                
                <!-- Appointment Settings -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-cog text-primary mr-2"></i><span>Appointment Settings</span>
                    </h3>
                    
                    <!-- Duration Selection -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-3 flex items-center">
                            <i class="fas fa-clock text-primary mr-2"></i><span>Appointment Duration</span>
                        </label>
                        <div class="grid grid-cols-3 md:grid-cols-6 gap-3">
                            <button onclick="selectDuration(15)" data-duration="15" class="duration-btn px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-primary hover:bg-blue-50 transition text-center">
                                <div class="text-2xl font-bold text-gray-800">15</div>
                                <div class="text-xs text-gray-600">minutes</div>
                            </button>
                            <button onclick="selectDuration(20)" data-duration="20" class="duration-btn px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-primary hover:bg-blue-50 transition text-center">
                                <div class="text-2xl font-bold text-gray-800">20</div>
                                <div class="text-xs text-gray-600">minutes</div>
                            </button>
                            <button onclick="selectDuration(30)" data-duration="30" class="duration-btn px-4 py-3 border-2 border-primary bg-blue-50 rounded-lg transition text-center">
                                <div class="text-2xl font-bold text-primary">30</div>
                                <div class="text-xs text-primary">minutes</div>
                            </button>
                            <button onclick="selectDuration(45)" data-duration="45" class="duration-btn px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-primary hover:bg-blue-50 transition text-center">
                                <div class="text-2xl font-bold text-gray-800">45</div>
                                <div class="text-xs text-gray-600">minutes</div>
                            </button>
                            <button onclick="selectDuration(60)" data-duration="60" class="duration-btn px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-primary hover:bg-blue-50 transition text-center">
                                <div class="text-2xl font-bold text-gray-800">60</div>
                                <div class="text-xs text-gray-600">minutes</div>
                            </button>
                            <button onclick="selectDuration(90)" data-duration="90" class="duration-btn px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-primary hover:bg-blue-50 transition text-center">
                                <div class="text-2xl font-bold text-gray-800">90</div>
                                <div class="text-xs text-gray-600">minutes</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Buffer Time Selection -->
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-3 flex items-center">
                            <i class="fas fa-hourglass-half text-primary mr-2"></i><span>Buffer Time Between Appointments</span>
                        </label>
                        <div class="grid grid-cols-5 gap-3">
                            <button onclick="selectBuffer(0)" data-buffer="0" class="buffer-btn px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-primary hover:bg-blue-50 transition text-center">
                                <div class="text-2xl font-bold text-gray-800">0</div>
                                <div class="text-xs text-gray-600">min</div>
                            </button>
                            <button onclick="selectBuffer(5)" data-buffer="5" class="buffer-btn px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-primary hover:bg-blue-50 transition text-center">
                                <div class="text-2xl font-bold text-gray-800">5</div>
                                <div class="text-xs text-gray-600">min</div>
                            </button>
                            <button onclick="selectBuffer(10)" data-buffer="10" class="buffer-btn px-4 py-3 border-2 border-primary bg-blue-50 rounded-lg transition text-center">
                                <div class="text-2xl font-bold text-primary">10</div>
                                <div class="text-xs text-primary">min</div>
                            </button>
                            <button onclick="selectBuffer(15)" data-buffer="15" class="buffer-btn px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-primary hover:bg-blue-50 transition text-center">
                                <div class="text-2xl font-bold text-gray-800">15</div>
                                <div class="text-xs text-gray-600">min</div>
                            </button>
                            <button onclick="selectBuffer(20)" data-buffer="20" class="buffer-btn px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-primary hover:bg-blue-50 transition text-center">
                                <div class="text-2xl font-bold text-gray-800">20</div>
                                <div class="text-xs text-gray-600">min</div>
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border-l-4 border-primary p-4 rounded">
                        <p class="text-sm text-gray-700">
                            <i class="fas fa-lightbulb text-primary mr-2"></i>
                            <strong>Tip</strong>: <span>Buffer time helps you prepare between appointments and avoid running late.</span>
                        </p>
                    </div>
                </div>
                
                <!-- Weekly Schedule -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-calendar-week text-primary mr-2"></i><span>Weekly Schedule</span>
                        </h3>
                        <div class="flex space-x-2">
                            <button onclick="copyToWeekdays()" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 transition text-sm font-semibold">
                                <i class="fas fa-copy mr-1"></i><span>Copy to Weekdays</span>
                            </button>
                            <button onclick="copyToAll()" class="bg-purple-100 text-purple-700 px-4 py-2 rounded-lg hover:bg-purple-200 transition text-sm font-semibold">
                                <i class="fas fa-clone mr-1"></i>Copy to All
                            </button>
                        </div>
                    </div>
                    
                    <div id="weekly-schedule" class="space-y-4"></div>
                    
                    <!-- Weekly Summary -->
                    <div class="mt-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 border border-blue-200">
                        <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-chart-bar text-primary mr-2"></i>Weekly Summary
                        </h4>
                        <div class="grid md:grid-cols-4 gap-4 text-sm">
                            <div class="bg-white rounded-lg p-3 shadow-sm">
                                <div class="text-gray-600 mb-1">Working Days</div>
                                <div class="text-2xl font-bold text-primary" id="summary-days">
                                    <i class="fas fa-spinner fa-spin text-gray-300"></i>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-3 shadow-sm">
                                <div class="text-gray-600 mb-1">Total Hours</div>
                                <div class="text-2xl font-bold text-green-600" id="summary-hours">
                                    <i class="fas fa-spinner fa-spin text-gray-300"></i>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-3 shadow-sm">
                                <div class="text-gray-600 mb-1">Est. Appointments</div>
                                <div class="text-2xl font-bold text-purple-600" id="summary-appointments">
                                    <i class="fas fa-spinner fa-spin text-gray-300"></i>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-3 shadow-sm">
                                <div class="text-gray-600 mb-1">Off Days</div>
                                <div class="text-2xl font-bold text-gray-600" id="summary-off">
                                    <i class="fas fa-spinner fa-spin text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="saveWeeklySchedule()" id="save-schedule-btn" class="mt-6 w-full bg-gradient-to-r from-primary to-blue-600 text-white px-6 py-3 rounded-lg hover:from-blue-600 hover:to-blue-700 transition font-semibold shadow-md">
                        <span id="save-schedule-text"><i class="fas fa-save mr-2"></i>Save Schedule</span>
                        <span id="save-schedule-spinner" class="hidden"><i class="fas fa-spinner fa-spin mr-2"></i>Saving...</span>
                    </button>
                </div>
                
                <!-- Off Dates -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-ban text-red-500 mr-2"></i>Off Dates & Holidays
                    </h3>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Select Date</label>
                            <input type="date" id="off-date-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Reason (Optional)</label>
                            <input type="text" id="off-date-reason" placeholder="e.g., Vacation, Conference" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                        </div>
                    </div>
                    
                    <button onclick="addOffDate()" class="w-full bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-lg hover:from-red-600 hover:to-red-700 transition font-semibold shadow-md mb-4">
                        <i class="fas fa-plus mr-2"></i>Add Off Date
                    </button>
                    
                    <div id="off-dates-list" class="space-y-2"></div>
                </div>
            </div>
            
            <!-- Patient Database Section -->
            <div id="section-patients" class="section hidden">
                <!-- Patient List View -->
                <div id="patient-list-view">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">My Patients</h2>
                    </div>
                    
                    <!-- Search & Filters -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2 text-sm">Search</label>
                                <input type="text" id="patient-search" onkeyup="searchPatients()" placeholder="Name, email, phone..." class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2 text-sm">Status</label>
                                <select id="patient-filter-status" onchange="filterPatients()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="new">New</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button onclick="clearPatientFilters()" class="w-full bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                                    <i class="fas fa-times mr-2"></i> Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Patient Table -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Patient ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contact</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Visits</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Visit</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="patients-table-body" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Patient Profile View (Hidden by default) -->
                <div id="patient-profile-view" class="hidden">
                    <button onclick="closePatientProfile()" class="mb-6 text-purple-600 hover:text-purple-700 font-semibold">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Patient List
                    </button>
                    
                    <!-- Patient Header -->
                    <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl shadow-lg p-8 text-white mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 id="profile-patient-name" class="text-3xl font-bold mb-2">Loading...</h2>
                                <p id="profile-patient-id" class="text-lg opacity-90"></p>
                            </div>
                            <div id="profile-patient-status" class="text-right">
                                <!-- Status badge will be inserted here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Patient Tabs -->
                    <div class="bg-white rounded-xl shadow-lg mb-6">
                        <div class="border-b border-gray-200">
                            <nav class="flex flex-wrap space-x-4 px-6" id="patient-tabs">
                                <button onclick="showPatientTab('overview')" class="patient-tab-btn py-4 px-2 border-b-2 border-purple-600 text-purple-600 font-semibold text-sm">
                                    <i class="fas fa-home mr-1"></i>Overview
                                </button>
                                <button onclick="showPatientTab('medical')" class="patient-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-semibold text-sm">
                                    <i class="fas fa-heartbeat mr-1"></i>Medical History
                                </button>
                                <button onclick="showPatientTab('blood')" class="patient-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-semibold text-sm">
                                    <i class="fas fa-tint mr-1"></i>Blood Profile
                                </button>
                                <button onclick="showPatientTab('dental')" class="patient-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-semibold text-sm">
                                    <i class="fas fa-tooth mr-1"></i>Dental Chart
                                </button>
                                <button onclick="showPatientTab('files')" class="patient-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-semibold text-sm">
                                    <i class="fas fa-images mr-1"></i>Files & Images
                                </button>
                                <button onclick="showPatientTab('treatment')" class="patient-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-semibold text-sm">
                                    <i class="fas fa-procedures mr-1"></i>Treatment Plans
                                </button>
                                <button onclick="showPatientTab('forms')" class="patient-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-semibold text-sm">
                                    <i class="fas fa-file-alt mr-1"></i>Forms
                                </button>
                                <button onclick="showPatientTab('visits')" class="patient-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-semibold text-sm">
                                    <i class="fas fa-calendar-check mr-1"></i>Visit History
                                </button>
                                <button onclick="showPatientTab('activity')" class="patient-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-semibold text-sm">
                                    <i class="fas fa-history mr-1"></i>Activity Log
                                </button>
                            </nav>
                        </div>
                    </div>
                    
                    <!-- Tab Content -->
                    <div id="patient-tab-content">
                        <!-- Content will be loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="modal-container"></div>
    <div id="toast-container" class="fixed top-4 right-4 z-50"></div>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCjJLE_Mgrv3HONhkkgApmUNVlGdnAIcvI",
            authDomain: "clinic-a17bc.firebaseapp.com",
            projectId: "clinic-a17bc",
            storageBucket: "clinic-a17bc.firebasestorage.app",
            messagingSenderId: "5214960983",
            appId: "1:5214960983:web:4da52f47c510a50b3cd212",
            measurementId: "G-7YM2Z0BY98"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Current user
        let currentUser = null;
        
        // Simple translation function (returns text as-is for now)
        function t(text) {
            return text;
        }
        
        // Check if user is logged in
        function checkAuth() {
            const currentUserStr = localStorage.getItem('currentUser');
            
            if (!currentUserStr) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const userData = JSON.parse(currentUserStr);
                
                // CHECK: User belongs to THIS clinic (support both clinicId and clinicIds for multi-clinic doctors)
                const belongsToClinic = userData.clinicId === CLINIC_ID || 
                    (userData.clinicIds && userData.clinicIds.includes(CLINIC_ID));
                if (!belongsToClinic) {
                    alert(`Access denied. You do not have access to ${CLINIC_NAME}`);
                    localStorage.removeItem('currentUser');
                    window.location.href = 'login.html';
                    return;
                }
                
                // CHECK: User is doctor
                if (userData.role !== 'doctor') {
                    alert('Access denied. Doctor access required.');
                    localStorage.removeItem('currentUser');
                    window.location.href = 'login.html';
                    return;
                }
                
                currentUser = userData;
                document.getElementById('user-name').textContent = userData.name || 'Doctor';
                
                console.log('‚úÖ Doctor authenticated:', userData.name, '- Clinic:', CLINIC_NAME);
                
                // Initialize page
                initializePage();
                
            } catch (error) {
                console.error('Error:', error);
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            }
        }
        
        // Logout function
        function logout() {
            showConfirmModal('Logout', 'Are you sure you want to logout?', () => {
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            }, 'Logout', 'red');
        }
        
        // GoHighLevel API v2 Configuration
        const GHL_API_KEY = 'pit-5b612d16-1609-43c6-a669-322e9197a9a9';
        const GHL_LOCATION_ID = 'xzA6eU8kOYmBuwFdr3CF';
        const GHL_API_BASE_URL = 'https://services.leadconnectorhq.com';
        
        // Stage to Tag Mapping
        const stageTagMapping = {
            'booked': 'patient',
            'approve': 'approve',
            'appointment': 'appointment',
            'missed': 'missed',
            'cancelled': 'cancel',
            'completed': 'complete'
        };
        
        // Helper function to upsert (create or update) contact in GoHighLevel
        async function upsertGHLContact(contactData) {
            try {
                const payload = {
                    locationId: GHL_LOCATION_ID,
                    email: contactData.email || '',
                    phone: contactData.phone || '',
                    tags: contactData.tags || [],
                    customFields: contactData.customFields || []
                };
                
                if (contactData.name) {
                    const nameParts = contactData.name.trim().split(' ');
                    payload.firstName = nameParts[0] || '';
                    payload.lastName = nameParts.slice(1).join(' ') || '';
                    payload.name = contactData.name;
                }
                
                console.log('Upserting GHL Contact:', payload);
                
                const response = await fetch(`${GHL_API_BASE_URL}/contacts/upsert`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${GHL_API_KEY}`,
                        'Content-Type': 'application/json',
                        'Version': '2021-07-28'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('GHL API Error:', response.status, errorText);
                    throw new Error(`GHL API Error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('GHL Contact Upserted Successfully:', data);
                return data;
            } catch (error) {
                console.error('Error upserting GHL contact:', error);
                return null;
            }
        }
        
        // currentUser already declared above
        let doctorProfile = null;
        let sortableInstances = [];
        let kanbanDateRangePicker;
        let currentTransferAppointmentId = null;
        let currentTransferAppointment = null;
        
        // Service category mappings
        const serviceCategories = {
            'Consultation': { icon: 'fa-stethoscope', color: 'blue', gradient: 'from-blue-500 to-blue-600' },
            'Dental': { icon: 'fa-tooth', color: 'cyan', gradient: 'from-cyan-500 to-cyan-600' },
            'Procedure': { icon: 'fa-syringe', color: 'purple', gradient: 'from-purple-500 to-purple-600' },
            'Follow-up': { icon: 'fa-calendar-check', color: 'green', gradient: 'from-green-500 to-green-600' },
            'Surgery': { icon: 'fa-user-md', color: 'red', gradient: 'from-red-500 to-red-600' },
            'Therapy': { icon: 'fa-heart', color: 'pink', gradient: 'from-pink-500 to-pink-600' },
            'General Checkup': { icon: 'fa-clipboard-check', color: 'indigo', gradient: 'from-indigo-500 to-indigo-600' },
            'Emergency': { icon: 'fa-ambulance', color: 'orange', gradient: 'from-orange-500 to-orange-600' }
        };
        
        // Helper functions
        function getCategoryIcon(category) {
            return serviceCategories[category]?.icon || 'fa-briefcase-medical';
        }
        
        function getCategoryGradient(category) {
            return serviceCategories[category]?.gradient || 'from-gray-500 to-gray-600';
        }
        
        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }
        
        function formatPrice(price, currency = 'SAR') {
            if (!price) return 'Free';
            const symbols = { SAR: 'SR', USD: '$', EUR: '‚Ç¨', GBP: '¬£', AED: 'AED' };
            return `${symbols[currency] || 'SR'}${price}`;
        }
        
        function showToast(message, type = 'success') {
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
            const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
            const toast = document.createElement('div');
            toast.className = `toast ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg mb-2`;
            toast.innerHTML = `<div class="flex items-center space-x-2"><i class="fas ${icons[type]}"></i><span>${message}</span></div>`;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Modern Confirm Modal (replaces browser confirm)
        function showConfirmModal(title, message, onConfirm, confirmText = 'Confirm', confirmColor = 'red') {
            const colors = {
                red: 'bg-red-600 hover:bg-red-700',
                green: 'bg-green-600 hover:bg-green-700',
                blue: 'bg-blue-600 hover:bg-blue-700',
                yellow: 'bg-yellow-600 hover:bg-yellow-700'
            };
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.id = 'confirm-modal';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden transform transition-all animate-fade-in">
                    <div class="bg-gradient-to-r from-gray-800 to-gray-900 px-6 py-4">
                        <h3 class="text-xl font-bold text-white flex items-center"><i class="fas fa-exclamation-triangle mr-2 text-yellow-400"></i>${title}</h3>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-700 mb-6">${message}</p>
                        <div class="flex space-x-3">
                            <button id="confirm-modal-btn" onclick="confirmModalAction(true)" class="flex-1 ${colors[confirmColor]} text-white px-6 py-3 rounded-xl transition-all font-semibold shadow-lg">
                                <i class="fas fa-check mr-2"></i>${confirmText}
                            </button>
                            <button id="confirm-modal-cancel" onclick="confirmModalAction(false)" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-xl hover:bg-gray-300 transition-all font-semibold">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window.confirmModalCallback = onConfirm;
        }
        
        async function confirmModalAction(confirmed) {
            if (confirmed && window.confirmModalCallback) {
                // Show loading on confirm button
                const btn = document.getElementById('confirm-modal-btn');
                const cancelBtn = document.getElementById('confirm-modal-cancel');
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
                    btn.disabled = true;
                }
                if (cancelBtn) cancelBtn.disabled = true;
                
                try {
                    await window.confirmModalCallback();
                } finally {
                    const modal = document.getElementById('confirm-modal');
                    if (modal) modal.remove();
                    window.confirmModalCallback = null;
                }
            } else {
                const modal = document.getElementById('confirm-modal');
                if (modal) modal.remove();
                window.confirmModalCallback = null;
            }
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
        
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${section}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.nav-btn').classList.add('active');
            
            if (section === 'kanban') {
                loadKanban();
            } else if (section === 'profile') {
                loadProfile();
            } else if (section === 'services') {
                loadServices();
            } else if (section === 'availability') {
                // Load immediately without delay
                if (doctorProfile) {
                    loadAvailability();
                }
            } else if (section === 'patients') {
                // Patient database is already loaded on page init
                // Just show the section
            }
        }
        
        async function loadProfile() {
            try {
                console.log('üìã Loading profile for user:', currentUser);
                
                // Fetch fresh user data from Firestore to get latest phone and specialty
                const userDoc = await db.collection('users').doc(currentUser.id).get();
                if (userDoc.exists) {
                    const freshUserData = userDoc.data();
                    // Update currentUser with fresh data
                    currentUser.phone = freshUserData.phone || '';
                    currentUser.specialty = freshUserData.specialty || '';
                    console.log('üîÑ Refreshed user data from Firestore');
                }
                
                // Display Doctor UID
                document.getElementById('doctor-uid').textContent = currentUser.id;
                
                // Load user data
                document.getElementById('profile-name').value = currentUser.name || '';
                document.getElementById('profile-email').value = currentUser.email || '';
                document.getElementById('profile-phone').value = currentUser.phone || '';
                document.getElementById('profile-specialty').value = currentUser.specialty || '';
                
                console.log('üìû Phone:', currentUser.phone);
                console.log('üè• Specialty:', currentUser.specialty);
                
                // Load doctor profile data if exists
                if (doctorProfile) {
                    document.getElementById('profile-license').value = doctorProfile.license || '';
                    document.getElementById('profile-experience').value = doctorProfile.experience || '';
                    document.getElementById('profile-education').value = doctorProfile.education || '';
                    document.getElementById('profile-bio').value = doctorProfile.bio || '';
                    document.getElementById('profile-facebook').value = doctorProfile.facebook || '';
                    document.getElementById('profile-instagram').value = doctorProfile.instagram || '';
                    document.getElementById('profile-linkedin').value = doctorProfile.linkedin || '';
                    document.getElementById('profile-website').value = doctorProfile.website || '';
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                showToast('Error loading profile', 'error');
            }
        }
        
        function copyUID() {
            const uid = currentUser.id;
            navigator.clipboard.writeText(uid).then(() => {
                showToast('UID copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showToast('Failed to copy UID', 'error');
            });
        }
        
        async function saveProfile() {
            try {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
                
                // Update users collection
                await db.collection('users').doc(currentUser.id).update({
                    name: document.getElementById('profile-name').value,
                    phone: document.getElementById('profile-phone').value,
                    specialty: document.getElementById('profile-specialty').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update or create doctor profile
                const profileData = {
                    license: document.getElementById('profile-license').value,
                    experience: parseInt(document.getElementById('profile-experience').value) || 0,
                    education: document.getElementById('profile-education').value,
                    bio: document.getElementById('profile-bio').value,
                    facebook: document.getElementById('profile-facebook').value,
                    instagram: document.getElementById('profile-instagram').value,
                    linkedin: document.getElementById('profile-linkedin').value,
                    website: document.getElementById('profile-website').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (doctorProfile) {
                    await db.collection('doctors').doc(doctorProfile.id).update(profileData);
                } else {
                    profileData.userId = currentUser.id;
                    profileData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    const newProfile = await db.collection('doctors').add(profileData);
                    doctorProfile = { id: newProfile.id, ...profileData };
                }
                
                // Update current user object
                currentUser.name = document.getElementById('profile-name').value;
                currentUser.phone = document.getElementById('profile-phone').value;
                currentUser.specialty = document.getElementById('profile-specialty').value;
                
                btn.disabled = false;
                btn.innerHTML = originalText;
                showToast('Profile updated successfully!', 'success');
            } catch (error) {
                console.error('Error saving profile:', error);
                showToast('Error saving profile', 'error');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        async function initializePage() {
            try {
                // Load clinic-specific profile from doctorClinicProfiles
                const profileId = `${currentUser.id}_${CLINIC_ID}`;
                const profileDoc = await db.collection('doctorClinicProfiles').doc(profileId).get();
                
                if (profileDoc.exists) {
                    doctorProfile = { id: profileDoc.id, ...profileDoc.data() };
                } else {
                    // Fallback: Create profile if it doesn't exist (for backward compatibility)
                    console.log('Creating missing doctorClinicProfile...');
                    const newProfile = {
                        doctorId: currentUser.id,
                        clinicId: CLINIC_ID,
                        doctorName: currentUser.name,
                        services: [],
                        weeklySchedule: {
                            monday: [],
                            tuesday: [],
                            wednesday: [],
                            thursday: [],
                            friday: [],
                            saturday: [],
                            sunday: []
                        },
                        appointmentDuration: 30,
                        bufferTime: 10,
                        offDates: [],
                        active: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await db.collection('doctorClinicProfiles').doc(profileId).set(newProfile);
                    doctorProfile = { id: profileId, ...newProfile };
                }
                
                // Update kanban title with doctor name
                document.getElementById('kanban-title').textContent = `${currentUser.name} Appointment Board`;
                
                // Initialize Flatpickr for kanban date filter
                initializeKanbanDateRangePicker();
                
                loadKanban();
                
                // Load doctor's patients
                await loadDoctorPatients();
            } catch (error) {
                console.error('Error initializing:', error);
                showToast('Error loading data', 'error');
            }
        }
        
        function initializeKanbanDateRangePicker() {
            kanbanDateRangePicker = flatpickr("#kanban-date-filter", {
                mode: "range",
                dateFormat: "M d, Y",
                showMonths: 2,
                onChange: function(selectedDates, dateStr, instance) {
                    loadKanban();
                },
                onReady: function(selectedDates, dateStr, instance) {
                    instance.calendarContainer.classList.add('analytics-calendar');
                }
            });
        }
        
        async function checkAndUpdateExpiredAppointments(appointments) {
            try {
                // Get today's date in YYYY-MM-DD format
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStr = today.toISOString().split('T')[0];
                
                // Find appointments that are past due and not completed/cancelled/missed
                const expiredAppointments = appointments.filter(apt => {
                    return apt.date < todayStr && 
                           apt.status !== 'completed' && 
                           apt.status !== 'cancelled' &&
                           apt.status !== 'missed';
                });
                
                if (expiredAppointments.length > 0) {
                    // Batch update to 'missed' status
                    const batch = db.batch();
                    expiredAppointments.forEach(apt => {
                        const docRef = db.collection('appointments').doc(apt.id);
                        batch.update(docRef, { status: 'missed' });
                        // Update local array
                        apt.status = 'missed';
                    });
                    
                    await batch.commit();
                    console.log(`Updated ${expiredAppointments.length} expired appointments to 'missed' status`);
                }
            } catch (error) {
                console.error('Error updating expired appointments:', error);
            }
        }
        
        async function loadKanban() {
            try {
                // CRITICAL: Filter by CLINIC_ID AND doctorId
                let query = db.collection('appointments')
                    .where('clinicId', '==', CLINIC_ID)
                    .where('doctorId', '==', currentUser.id);
                const snapshot = await query.get();
                let appointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Auto-update expired appointments to 'missed'
                await checkAndUpdateExpiredAppointments(appointments);
                
                // Filter by date range if selected
                if (kanbanDateRangePicker && kanbanDateRangePicker.selectedDates.length === 2) {
                    const fromDate = kanbanDateRangePicker.selectedDates[0];
                    const toDate = kanbanDateRangePicker.selectedDates[1];
                    appointments = appointments.filter(apt => {
                        const aptDate = new Date(apt.date);
                        return aptDate >= fromDate && aptDate <= toDate;
                    });
                }
                
                const grouped = { booked: [], approve: [], appointment: [], missed: [], cancelled: [], completed: [] };
                appointments.forEach(apt => {
                    if (grouped[apt.status]) grouped[apt.status].push(apt);
                });
                
                Object.keys(grouped).forEach(status => {
                    document.getElementById(`count-${status}`).textContent = grouped[status].length;
                });
                
                // Render appointments in each column
                document.getElementById('kanban-booked').innerHTML = grouped.booked.map(apt => `
                    <div class="bg-white p-3 rounded-lg shadow hover:shadow-md transition" data-id="${apt.id}">
                        <div onclick="viewAppointment('${apt.id}')" class="cursor-pointer">
                            <p class="font-semibold text-gray-800">${apt.patientName}</p>
                            <p class="text-sm text-gray-600"><i class="fas fa-calendar mr-1"></i>${apt.date}</p>
                            <p class="text-sm text-gray-600"><i class="fas fa-clock mr-1"></i>${apt.startTime || ''}</p>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200 flex gap-2">
                            <button onclick="event.stopPropagation(); viewAppointment('${apt.id}')" 
                                    class="flex-1 bg-gray-100 text-gray-700 px-2 py-1.5 rounded text-xs hover:bg-gray-200 transition">
                                <i class="fas fa-eye mr-1"></i>View
                            </button>
                            <button onclick="event.stopPropagation(); showTransferModal('${apt.id}')" 
                                    class="flex-1 bg-blue-500 text-white px-2 py-1.5 rounded text-xs hover:bg-blue-600 transition">
                                <i class="fas fa-exchange-alt mr-1"></i>Transfer
                            </button>
                        </div>
                    </div>
                `).join('');
                document.getElementById('kanban-approve').innerHTML = grouped.approve.map(apt => `
                    <div class="bg-white p-3 rounded-lg shadow cursor-pointer hover:shadow-md transition" data-id="${apt.id}" onclick="viewAppointment('${apt.id}')">
                        <p class="font-semibold text-gray-800">${apt.patientName}</p>
                        <p class="text-sm text-gray-600">${apt.date}</p>
                        <p class="text-sm text-gray-600">${apt.startTime || ''}</p>
                    </div>
                `).join('');
                document.getElementById('kanban-appointment').innerHTML = grouped.appointment.map(apt => `
                    <div class="bg-white p-3 rounded-lg shadow cursor-pointer hover:shadow-md transition" data-id="${apt.id}" onclick="viewAppointment('${apt.id}')">
                        <p class="font-semibold text-gray-800">${apt.patientName}</p>
                        <p class="text-sm text-gray-600">${apt.date}</p>
                        <p class="text-sm text-gray-600">${apt.startTime || ''}</p>
                    </div>
                `).join('');
                document.getElementById('kanban-missed').innerHTML = grouped.missed.map(apt => `
                    <div class="bg-white p-3 rounded-lg shadow cursor-pointer hover:shadow-md transition" data-id="${apt.id}" onclick="viewAppointment('${apt.id}')">
                        <p class="font-semibold text-gray-800">${apt.patientName}</p>
                        <p class="text-sm text-gray-600">${apt.date}</p>
                        <p class="text-sm text-gray-600">${apt.startTime || ''}</p>
                    </div>
                `).join('');
                document.getElementById('kanban-cancelled').innerHTML = grouped.cancelled.map(apt => `
                    <div class="bg-white p-3 rounded-lg shadow cursor-pointer hover:shadow-md transition" data-id="${apt.id}" onclick="viewAppointment('${apt.id}')">
                        <p class="font-semibold text-gray-800">${apt.patientName}</p>
                        <p class="text-sm text-gray-600">${apt.date}</p>
                        <p class="text-sm text-gray-600">${apt.startTime || ''}</p>
                    </div>
                `).join('');
                document.getElementById('kanban-completed').innerHTML = grouped.completed.map(apt => `
                    <div class="bg-white p-3 rounded-lg shadow cursor-pointer hover:shadow-md transition" data-id="${apt.id}" onclick="viewAppointment('${apt.id}')">
                        <p class="font-semibold text-gray-800">${apt.patientName}</p>
                        <p class="text-sm text-gray-600">${apt.date}</p>
                        <p class="text-sm text-gray-600">${apt.startTime || ''}</p>
                    </div>
                `).join('');
                
                initializeDragAndDrop();
            } catch (error) {
                console.error('Error loading kanban:', error);
                showToast('Error loading appointments', 'error');
            }
        }
        
        function initializeDragAndDrop() {
            sortableInstances.forEach(instance => instance.destroy());
            sortableInstances = [];
            
            ['booked', 'approve', 'appointment', 'missed', 'cancelled', 'completed'].forEach(status => {
                const element = document.getElementById(`kanban-${status}`);
                const sortable = new Sortable(element, {
                    group: 'kanban',
                    animation: 200,
                    easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    forceFallback: false,
                    fallbackTolerance: 3,
                    scroll: true,
                    scrollSensitivity: 60,
                    scrollSpeed: 10,
                    bubbleScroll: true,
                    onEnd: async function(evt) {
                        const appointmentId = evt.item.dataset.id;
                        const newStatus = evt.to.id.replace('kanban-', '');
                        
                        console.log('=== KANBAN DRAG START ===');
                        console.log('Appointment ID:', appointmentId);
                        console.log('New Status:', newStatus);
                        
                        try {
                            // Get appointment data first
                            const aptDoc = await db.collection('appointments').doc(appointmentId).get();
                            if (!aptDoc.exists) {
                                console.error('Appointment not found:', appointmentId);
                                showToast('Appointment not found', 'error');
                                loadKanban();
                                return;
                            }
                            
                            const apt = aptDoc.data();
                            console.log('Appointment Data:', {
                                name: apt.patientName,
                                phone: apt.patientPhone,
                                email: apt.patientEmail,
                                date: apt.date,
                                time: apt.startTime
                            });
                            
                            // Update Firebase status
                            await db.collection('appointments').doc(appointmentId).update({
                                status: newStatus,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            console.log('Firebase status updated to:', newStatus);
                            
                            // Update GHL contact with full appointment details
                            if (apt.patientPhone || apt.patientEmail) {
                                const tagToAdd = stageTagMapping[newStatus];
                                console.log('Tag to add:', tagToAdd);
                                
                                if (tagToAdd) {
                                    // Build custom fields with appointment details
                                    const customFields = [
                                        {
                                            key: 'appointment_date',
                                            value: apt.date || ''
                                        },
                                        {
                                            key: 'appointment_time',
                                            value: apt.startTime || ''
                                        },
                                        {
                                            key: 'booking_time',
                                            value: apt.startTime || ''
                                        },
                                        {
                                            key: 'booking_date_and_time',
                                            value: `${apt.date || ''} at ${apt.startTime || ''}`
                                        },
                                        {
                                            key: 'patient_phone_number',
                                            value: apt.patientPhone || ''
                                        },
                                        {
                                            key: 'doctor',
                                            value: currentUser.name || ''
                                        },
                                        {
                                            key: 'doctor_email',
                                            value: currentUser.email || ''
                                        },
                                        {
                                            key: 'doctor_phone',
                                            value: currentUser.phone || ''
                                        }
                                    ];
                                    
                                    console.log('Calling GHL API with custom fields...');
                                    const ghlResult = await upsertGHLContact({
                                        name: apt.patientName,
                                        phone: apt.patientPhone,
                                        email: apt.patientEmail,
                                        tags: [tagToAdd],
                                        customFields: customFields
                                    });
                                    
                                    if (ghlResult) {
                                        console.log('GHL API Success:', ghlResult);
                                        showToast(`Status updated & tag "${tagToAdd}" added to GHL`, 'success');
                                    } else {
                                        console.error('GHL API returned null');
                                        showToast('Status updated (GHL sync failed)', 'warning');
                                    }
                                } else {
                                    console.warn('No tag mapping found for status:', newStatus);
                                    showToast('Status updated', 'success');
                                }
                            } else {
                                console.warn('No patient contact info:', {
                                    phone: apt.patientPhone,
                                    email: apt.patientEmail
                                });
                                showToast('Status updated (no contact info for GHL)', 'warning');
                            }
                            
                            console.log('=== KANBAN DRAG END ===');
                            
                            // Reload kanban to update counters
                            await loadKanban();
                            
                        } catch (error) {
                            console.error('Error in onEnd handler:', error);
                            showToast('Error updating status', 'error');
                            loadKanban();
                        }
                    }
                });
                sortableInstances.push(sortable);
            });
        }
        
        function getStatusColor(status) {
            const colors = {
                'booked': 'bg-blue-100 text-blue-800',
                'approve': 'bg-purple-100 text-purple-800',
                'appointment': 'bg-green-100 text-green-800',
                'missed': 'bg-orange-100 text-orange-800',
                'cancelled': 'bg-red-100 text-red-800',
                'completed': 'bg-gray-100 text-gray-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }
        
        async function viewAppointment(id) {
            // Show loading modal
            const loadingModal = document.createElement('div');
            loadingModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingModal.innerHTML = `
                <div class="bg-white rounded-xl p-8 text-center">
                    <i class="fas fa-spinner fa-spin text-primary text-4xl mb-4"></i>
                    <p class="text-gray-700 font-semibold">Loading appointment details...</p>
                </div>
            `;
            document.getElementById('modal-container').appendChild(loadingModal);
            
            try {
                const aptDoc = await db.collection('appointments').doc(id).get();
                if (!aptDoc.exists) {
                    showToast('Appointment not found', 'error');
                    return;
                }
                
                const apt = { id: aptDoc.id, ...aptDoc.data() };
                
                // Get service info if available
                let serviceInfo = '';
                if (apt.serviceId) {
                    try {
                        const serviceDoc = await db.collection('services').doc(apt.serviceId).get();
                        if (serviceDoc.exists) {
                            const service = serviceDoc.data();
                            const priceText = service.price ? `${service.currency || 'SAR'} ${service.price}` : 'Free';
                            serviceInfo = `
                                <div class="bg-blue-50 rounded-lg p-4 mb-4">
                                    <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                                        <i class="fas fa-briefcase-medical text-primary mr-2"></i>Service Details
                                    </h4>
                                    <p class="text-sm text-gray-700"><strong>Service:</strong> ${service.name}</p>
                                    <p class="text-sm text-gray-700"><strong>Category:</strong> ${service.category}</p>
                                    <p class="text-sm text-gray-700"><strong>Duration:</strong> ${service.duration} minutes</p>
                                    <p class="text-sm text-gray-700"><strong>Price:</strong> ${priceText}</p>
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error('Error loading service:', error);
                    }
                }
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="bg-gradient-to-r from-primary to-blue-600 text-white p-6 rounded-t-xl">
                            <div class="flex items-center justify-between">
                                <h3 class="text-2xl font-bold flex items-center">
                                    <i class="fas fa-calendar-check mr-3"></i>Appointment Details
                                </h3>
                                <button onclick="closeModal()" class="text-white hover:text-gray-200 text-2xl">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid md:grid-cols-2 gap-4 mb-4">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                        <i class="fas fa-user text-primary mr-2"></i>Patient Information
                                    </h4>
                                    <p class="text-sm text-gray-700 mb-1"><strong>Name:</strong> ${apt.patientName}</p>
                                    <p class="text-sm text-gray-700 mb-1"><strong>Phone:</strong> ${apt.patientPhone || 'N/A'}</p>
                                    <p class="text-sm text-gray-700"><strong>Email:</strong> ${apt.patientEmail || 'N/A'}</p>
                                </div>
                                
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                        <i class="fas fa-clock text-primary mr-2"></i>Appointment Schedule
                                    </h4>
                                    <p class="text-sm text-gray-700 mb-1"><strong>Date:</strong> ${apt.date}</p>
                                    <p class="text-sm text-gray-700 mb-1"><strong>Time:</strong> ${apt.startTime || 'N/A'} - ${apt.endTime || 'N/A'}</p>
                                    <p class="text-sm text-gray-700"><strong>Duration:</strong> ${apt.duration || 'N/A'} min</p>
                                </div>
                            </div>
                            
                            ${serviceInfo}
                            
                            ${apt.symptoms ? `
                                <div class="bg-yellow-50 rounded-lg p-4 mb-4">
                                    <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                                        <i class="fas fa-notes-medical text-yellow-600 mr-2"></i>Symptoms / Reason
                                    </h4>
                                    <p class="text-sm text-gray-700">${apt.symptoms}</p>
                                </div>
                            ` : ''}
                            
                            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                                    <i class="fas fa-info-circle text-primary mr-2"></i>Status Information
                                </h4>
                                <div class="flex items-center space-x-4">
                                    <span class="px-3 py-1 rounded-full text-sm font-semibold ${getStatusColor(apt.status)}">${apt.status.toUpperCase()}</span>
                                    ${apt.checkedIn ? '<span class="text-green-600 text-sm"><i class="fas fa-check-circle mr-1"></i>Checked In</span>' : '<span class="text-gray-500 text-sm"><i class="fas fa-times-circle mr-1"></i>Not Checked In</span>'}
                                </div>
                            </div>
                            
                            ${apt.notes && apt.notes.length > 0 ? `
                                <div class="bg-purple-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                                        <i class="fas fa-sticky-note text-purple-600 mr-2"></i>Notes
                                    </h4>
                                    <div class="space-y-2">
                                        ${Array.isArray(apt.notes) && apt.notes.length > 0 ? apt.notes.map(note => `
                                            <div class="bg-white p-2 rounded text-sm text-gray-700">
                                                <p class="font-semibold">${note.author || 'Doctor'} - ${note.timestamp ? new Date(note.timestamp).toLocaleString() : ''}</p>
                                                <p>${note.text}</p>
                                            </div>
                                        `).join('') : '<p class="text-gray-500 text-sm">No notes yet</p>'}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="bg-gray-50 p-6 rounded-b-xl flex justify-end">
                            <button onclick="closeModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition font-semibold">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                // Remove loading modal and show appointment modal
                loadingModal.remove();
                document.getElementById('modal-container').appendChild(modal);
            } catch (error) {
                console.error('Error viewing appointment:', error);
                loadingModal.remove();
                showToast('Error loading appointment details', 'error');
            }
        }
        
        async function loadServices() {
            try {
                // Load services from clinic-specific profile
                const services = doctorProfile?.services || [];
                
                const grid = document.getElementById('services-grid');
                if (services.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <i class="fas fa-briefcase-medical text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 text-lg">No services yet. Add your first service!</p>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = services.map((service, index) => {
                    const icon = getCategoryIcon(service.category);
                    const gradient = getCategoryGradient(service.category);
                    const description = truncateText(service.description, 80);
                    const price = formatPrice(service.price, service.currency);
                    const isActive = service.isActive !== false;
                    const sourceType = service.sourceType || 'global';
                    const sourceBadge = sourceType === 'global' 
                        ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 mr-2"><i class="fas fa-globe text-xs mr-1"></i>${t('Global')}</span>`
                        : `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-800 mr-2"><i class="fas fa-pen text-xs mr-1"></i>${t('Custom')}</span>`;
                    const translatedCategory = t(service.category);
                    
                    return `
                        <div class="bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden cursor-pointer transform hover:scale-105" onclick="viewServiceDetails(${index})">
                            <!-- Header with gradient -->
                            <div class="bg-gradient-to-r ${gradient} p-4 text-white relative">
                                <div class="flex items-center justify-between">
                                    <i class="fas ${icon} text-4xl opacity-90"></i>
                                    <div class="flex space-x-2">
                                        <button onclick="event.stopPropagation(); showEditServiceModal(${index})" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded-lg transition" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="event.stopPropagation(); deleteService(${index})" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded-lg transition" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Content -->
                            <div class="p-6">
                                <div class="flex items-center mb-2">
                                    ${sourceBadge}
                                </div>
                                <h3 class="text-xl font-bold text-gray-800 mb-2">${service.name}</h3>
                                <div class="flex items-center text-sm text-gray-600 mb-3 space-x-3">
                                    <span><i class="fas fa-folder mr-1"></i>${translatedCategory}</span>
                                    <span><i class="fas fa-clock mr-1"></i>${service.duration} ${t('minutes')}</span>
                                    <span class="font-semibold text-primary">${price}</span>
                                </div>
                                
                                ${description ? `<p class="text-gray-600 text-sm mb-4 line-clamp-2">${description}</p>` : `<p class="text-gray-400 text-sm mb-4 italic">${t('No description')}</p>`}
                                
                                <div class="flex items-center justify-between pt-4 border-t">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                        <i class="fas fa-circle text-xs mr-1"></i>
                                        ${isActive ? t('Active') : t('Inactive')}
                                    </span>
                                    <span class="text-primary text-sm font-semibold">
                                        ${t('View Details')} <i class="fas fa-arrow-right ml-1"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading services:', error);
                showToast('Error loading services', 'error');
            }
        }
        
        function showAddServiceModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">${t('Add New Service')}</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    <form id="service-form" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-gray-700 font-semibold mb-2">${t('Service Name')} *</label>
                                <input type="text" id="service-name" required placeholder="${t('e.g., Dental Cleaning')}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">${t('Category')} *</label>
                                <select id="service-category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                    <option value="">${t('Select Category')}</option>
                                    <option value="Consultation">ü©∫ ${t('Consultation')}</option>
                                    <option value="Dental">ü¶∑ ${t('Dental')}</option>
                                    <option value="Procedure">üíâ ${t('Procedure')}</option>
                                    <option value="Follow-up">üìÖ ${t('Follow-up')}</option>
                                    <option value="Surgery">üë®‚Äç‚öïÔ∏è ${t('Surgery')}</option>
                                    <option value="Therapy">‚ù§Ô∏è ${t('Therapy')}</option>
                                    <option value="General Checkup">üìã ${t('General Checkup')}</option>
                                    <option value="Emergency">üöë ${t('Emergency')}</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">${t('Duration (minutes)')} *</label>
                                <input type="number" id="service-duration" required value="30" min="5" max="480" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">${t('Price')}</label>
                                <input type="number" id="service-price" placeholder="0.00" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">${t('Currency')}</label>
                                <select id="service-currency" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                    <option value="SAR" selected>${t('SR Saudi Riyal')}</option>
                                    <option value="AED">${t('AED UAE Dirham')}</option>
                                    <option value="USD">${t('$ USD')}</option>
                                    <option value="EUR">${t('‚Ç¨ EUR')}</option>
                                    <option value="GBP">${t('¬£ GBP')}</option>
                                </select>
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-gray-700 font-semibold mb-2">${t('Description')}</label>
                                <textarea id="service-description" rows="3" placeholder="${t('Brief description of the service...')}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"></textarea>
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" id="service-active" checked class="w-5 h-5 text-primary rounded focus:ring-2 focus:ring-primary">
                                    <span class="text-gray-700 font-semibold">${t('Active (available for booking)')}</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2 pt-4 border-t">
                            <button type="submit" id="save-service-btn" class="flex-1 bg-gradient-to-r from-primary to-blue-600 text-white px-6 py-3 rounded-lg hover:from-blue-600 hover:to-blue-700 transition font-semibold shadow-md">
                                <span id="save-service-text"><i class="fas fa-save mr-2"></i>${t('Save Service')}</span>
                                <span id="save-service-spinner" class="hidden"><i class="fas fa-spinner fa-spin mr-2"></i>Saving...</span>
                            </button>
                            <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition font-semibold">
                                ${t('Cancel')}
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            
            document.getElementById('service-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Show loading spinner
                const btn = document.getElementById('save-service-btn');
                const btnText = document.getElementById('save-service-text');
                const btnSpinner = document.getElementById('save-service-spinner');
                btn.disabled = true;
                btnText.classList.add('hidden');
                btnSpinner.classList.remove('hidden');
                
                try {
                    const serviceData = {
                        name: document.getElementById('service-name').value,
                        category: document.getElementById('service-category').value,
                        duration: parseInt(document.getElementById('service-duration').value),
                        price: parseFloat(document.getElementById('service-price').value) || 0,
                        currency: document.getElementById('service-currency').value,
                        description: document.getElementById('service-description').value || '',
                        isActive: document.getElementById('service-active').checked,
                        sourceType: 'custom'
                    };
                    
                    // Add service to profile's services array
                    const updatedServices = [...(doctorProfile.services || []), serviceData];
                    
                    const profileId = `${currentUser.id}_${CLINIC_ID}`;
                    await db.collection('doctorClinicProfiles').doc(profileId).update({
                        services: updatedServices,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    doctorProfile.services = updatedServices;
                    showToast('Service added successfully', 'success');
                    closeModal();
                    loadServices();
                } catch (error) {
                    console.error('Error adding service:', error);
                    showToast('Error adding service', 'error');
                    // Hide loading spinner on error
                    btn.disabled = false;
                    btnText.classList.remove('hidden');
                    btnSpinner.classList.add('hidden');
                }
            });
        }
        
        function viewServiceDetails(index) {
            try {
                const services = doctorProfile?.services || [];
                if (index < 0 || index >= services.length) {
                    showToast('Service not found', 'error');
                    return;
                }
                
                const service = services[index];
                const icon = getCategoryIcon(service.category);
                const gradient = getCategoryGradient(service.category);
                const price = formatPrice(service.price, service.currency);
                const isActive = service.isActive !== false;
                const createdAt = 'N/A';
                const updatedAt = 'N/A';
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <!-- Header -->
                        <div class="bg-gradient-to-r ${gradient} p-6 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <i class="fas ${icon} text-5xl"></i>
                                <button onclick="closeModal()" class="text-white hover:text-gray-200">
                                    <i class="fas fa-times text-2xl"></i>
                                </button>
                            </div>
                            <h2 class="text-3xl font-bold">${service.name}</h2>
                        </div>
                        
                        <!-- Content -->
                        <div class="p-6 space-y-6">
                            <!-- Info Grid -->
                            <div class="grid md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-folder text-primary text-xl"></i>
                                    <div>
                                        <p class="text-xs text-gray-500">Category</p>
                                        <p class="font-semibold text-gray-800">${service.category}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-clock text-primary text-xl"></i>
                                    <div>
                                        <p class="text-xs text-gray-500">Duration</p>
                                        <p class="font-semibold text-gray-800">${service.duration} minutes</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-dollar-sign text-primary text-xl"></i>
                                    <div>
                                        <p class="text-xs text-gray-500">Price</p>
                                        <p class="font-semibold text-gray-800">${price}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-circle text-xl ${isActive ? 'text-green-500' : 'text-gray-400'}"></i>
                                    <div>
                                        <p class="text-xs text-gray-500">Status</p>
                                        <p class="font-semibold ${isActive ? 'text-green-600' : 'text-gray-600'}">${isActive ? 'Active' : 'Inactive'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Description -->
                            <div>
                                <h3 class="text-lg font-bold text-gray-800 mb-2 flex items-center">
                                    <i class="fas fa-file-alt text-primary mr-2"></i>Description
                                </h3>
                                <p class="text-gray-600 bg-gray-50 p-4 rounded-lg">
                                    ${service.description || '<span class="italic text-gray-400">No description provided</span>'}
                                </p>
                            </div>
                            
                            <!-- Timestamps -->
                            <div class="grid md:grid-cols-2 gap-4 text-sm">
                                <div class="flex items-center space-x-2 text-gray-600">
                                    <i class="fas fa-calendar-plus"></i>
                                    <span><strong>Created:</strong> ${createdAt}</span>
                                </div>
                                <div class="flex items-center space-x-2 text-gray-600">
                                    <i class="fas fa-calendar-check"></i>
                                    <span><strong>Updated:</strong> ${updatedAt}</span>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex space-x-2 pt-4 border-t">
                                <button onclick="closeModal(); showEditServiceModal(${index})" class="flex-1 bg-gradient-to-r from-primary to-blue-600 text-white px-6 py-3 rounded-lg hover:from-blue-600 hover:to-blue-700 transition font-semibold shadow-md">
                                    <i class="fas fa-edit mr-2"></i>Edit Service
                                </button>
                                <button onclick="deleteService(${index})" class="flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-lg hover:from-red-600 hover:to-red-700 transition font-semibold shadow-md">
                                    <i class="fas fa-trash mr-2"></i>Delete
                                </button>
                                <button onclick="closeModal()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('modal-container').appendChild(modal);
            } catch (error) {
                console.error('Error viewing service:', error);
                showToast('Error loading service details', 'error');
            }
        }
        
        function showEditServiceModal(index) {
            try {
                const services = doctorProfile?.services || [];
                if (index < 0 || index >= services.length) {
                    showToast('Service not found', 'error');
                    return;
                }
                
                const service = services[index];
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">${t('Edit Service')}</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        <form id="edit-service-form" class="space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-gray-700 font-semibold mb-2">${t('Service Name')} *</label>
                                    <input type="text" id="edit-service-name" required value="${service.name}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">${t('Category')} *</label>
                                    <select id="edit-service-category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                        <option value="Consultation" ${service.category === 'Consultation' ? 'selected' : ''}>ü©∫ ${t('Consultation')}</option>
                                        <option value="Dental" ${service.category === 'Dental' ? 'selected' : ''}>ü¶∑ ${t('Dental')}</option>
                                        <option value="Procedure" ${service.category === 'Procedure' ? 'selected' : ''}>üíâ ${t('Procedure')}</option>
                                        <option value="Follow-up" ${service.category === 'Follow-up' ? 'selected' : ''}>üìÖ ${t('Follow-up')}</option>
                                        <option value="Surgery" ${service.category === 'Surgery' ? 'selected' : ''}>üë®‚Äç‚öïÔ∏è ${t('Surgery')}</option>
                                        <option value="Therapy" ${service.category === 'Therapy' ? 'selected' : ''}>‚ù§Ô∏è ${t('Therapy')}</option>
                                        <option value="General Checkup" ${service.category === 'General Checkup' ? 'selected' : ''}>üìã ${t('General Checkup')}</option>
                                        <option value="Emergency" ${service.category === 'Emergency' ? 'selected' : ''}>üöë ${t('Emergency')}</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">${t('Duration (minutes)')} *</label>
                                    <input type="number" id="edit-service-duration" required value="${service.duration}" min="5" max="480" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">${t('Price')}</label>
                                    <input type="number" id="edit-service-price" value="${service.price || ''}" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">${t('Currency')}</label>
                                    <select id="edit-service-currency" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                        <option value="SAR" ${service.currency === 'SAR' || !service.currency ? 'selected' : ''}>${t('SR Saudi Riyal')}</option>
                                        <option value="AED" ${service.currency === 'AED' ? 'selected' : ''}>${t('AED UAE Dirham')}</option>
                                        <option value="USD" ${service.currency === 'USD' ? 'selected' : ''}>${t('$ USD')}</option>
                                        <option value="EUR" ${service.currency === 'EUR' ? 'selected' : ''}>${t('‚Ç¨ EUR')}</option>
                                        <option value="GBP" ${service.currency === 'GBP' ? 'selected' : ''}>${t('¬£ GBP')}</option>
                                    </select>
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label class="block text-gray-700 font-semibold mb-2">${t('Description')}</label>
                                    <textarea id="edit-service-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">${service.description || ''}</textarea>
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="checkbox" id="edit-service-active" ${service.isActive !== false ? 'checked' : ''} class="w-5 h-5 text-primary rounded focus:ring-2 focus:ring-primary">
                                        <span class="text-gray-700 font-semibold">${t('Active (available for booking)')}</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex space-x-2 pt-4 border-t">
                                <button type="submit" class="flex-1 bg-gradient-to-r from-primary to-blue-600 text-white px-6 py-3 rounded-lg hover:from-blue-600 hover:to-blue-700 transition font-semibold shadow-md">
                                    <i class="fas fa-save mr-2"></i>${t('Update Service')}
                                </button>
                                <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition font-semibold">
                                    ${t('Cancel')}
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                document.getElementById('modal-container').appendChild(modal);
                
                document.getElementById('edit-service-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    try {
                        const updateData = {
                            ...service,
                            name: document.getElementById('edit-service-name').value,
                            category: document.getElementById('edit-service-category').value,
                            duration: parseInt(document.getElementById('edit-service-duration').value),
                            price: parseFloat(document.getElementById('edit-service-price').value) || 0,
                            currency: document.getElementById('edit-service-currency').value,
                            description: document.getElementById('edit-service-description').value || '',
                            isActive: document.getElementById('edit-service-active').checked
                        };
                        
                        // Update service in array
                        const updatedServices = [...(doctorProfile.services || [])];
                        updatedServices[index] = updateData;
                        
                        const profileId = `${currentUser.id}_${CLINIC_ID}`;
                        await db.collection('doctorClinicProfiles').doc(profileId).update({
                            services: updatedServices,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        doctorProfile.services = updatedServices;
                        showToast('Service updated successfully', 'success');
                        closeModal();
                        loadServices();
                    } catch (error) {
                        console.error('Error updating service:', error);
                        showToast('Error updating service', 'error');
                    }
                });
            } catch (error) {
                console.error('Error loading service:', error);
                showToast('Error loading service', 'error');
            }
        }
        
        async function deleteService(index) {
            const confirmed = await showConfirmDialog(
                'Delete Service',
                'Are you sure you want to delete this service? This action cannot be undone.',
                'Delete',
                'Cancel'
            );
            
            if (!confirmed) return;
            
            try {
                // Remove service from array and update profile
                const services = [...(doctorProfile.services || [])];
                services.splice(index, 1);
                
                const profileId = `${currentUser.id}_${CLINIC_ID}`;
                await db.collection('doctorClinicProfiles').doc(profileId).update({
                    services: services,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                doctorProfile.services = services;
                showToast('Service deleted successfully', 'success');
                closeModal();
                loadServices();
            } catch (error) {
                console.error('Error deleting service:', error);
                showToast('Error deleting service', 'error');
            }
        }
        
        // ============================================
        // TAB SWITCHING AND GLOBAL SERVICES
        // ============================================
        
        function switchServiceTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.service-tab').forEach(btn => {
                btn.classList.remove('border-primary', 'bg-blue-50', 'text-gray-700');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            const activeTab = document.getElementById(`tab-${tab}`);
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-primary', 'bg-blue-50', 'text-gray-700');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(`tab-content-${tab}`).classList.remove('hidden');
            
            // Load content if needed
            if (tab === 'browse-global') {
                loadGlobalServices();
            }
        }
        
        let allGlobalServices = [];
        
        async function loadGlobalServices() {
            try {
                // Filter by CLINIC_ID and isActive - doctors only see their clinic's active services
                const snapshot = await db.collection('globalServices')
                    .where('clinicId', '==', CLINIC_ID)
                    .where('isActive', '==', true)
                    .get();
                allGlobalServices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                displayGlobalServices(allGlobalServices);
                
                // Add search and filter listeners
                document.getElementById('global-service-search').addEventListener('input', filterGlobalServices);
                document.getElementById('global-service-filter').addEventListener('change', filterGlobalServices);
            } catch (error) {
                console.error('Error loading global services:', error);
                showToast('Error loading global services', 'error');
            }
        }
        
        function filterGlobalServices() {
            const searchTerm = document.getElementById('global-service-search').value.toLowerCase();
            const categoryFilter = document.getElementById('global-service-filter').value;
            
            const filtered = allGlobalServices.filter(service => {
                const matchesSearch = service.name.toLowerCase().includes(searchTerm) || 
                                     (service.description && service.description.toLowerCase().includes(searchTerm));
                const matchesCategory = !categoryFilter || service.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });
            
            displayGlobalServices(filtered);
        }
        
        function displayGlobalServices(services) {
            const grid = document.getElementById('global-services-grid');
            
            if (services.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">No global services found</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = services.map(service => {
                const icon = getCategoryIcon(service.category);
                const gradient = getCategoryGradient(service.category);
                const description = truncateText(service.description, 80);
                const price = formatPrice(service.price, service.currency);
                const translatedCategory = t(service.category);
                
                return `
                    <div class="bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden">
                        <!-- Header with gradient -->
                        <div class="bg-gradient-to-r ${gradient} p-4 text-white relative">
                            <div class="flex items-center justify-between">
                                <i class="fas ${icon} text-4xl opacity-90"></i>
                                <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-xs font-semibold">
                                    <i class="fas fa-globe mr-1"></i>Global
                                </span>
                            </div>
                        </div>
                        
                        <!-- Content -->
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${service.name}</h3>
                            <div class="flex items-center text-sm text-gray-600 mb-3 space-x-3">
                                <span><i class="fas fa-folder mr-1"></i>${translatedCategory}</span>
                                <span><i class="fas fa-clock mr-1"></i>${service.duration} ${t('minutes')}</span>
                                <span class="font-semibold text-primary">${price}</span>
                            </div>
                            
                            ${description ? `<p class="text-gray-600 text-sm mb-4">${description}</p>` : `<p class="text-gray-400 text-sm mb-4 italic">${t('No description')}</p>`}
                            
                            <button onclick="showAddGlobalServiceToMyServices('${service.id}')" class="w-full bg-gradient-to-r from-primary to-blue-600 text-white px-4 py-3 rounded-lg hover:shadow-lg transition font-semibold">
                                <i class="fas fa-plus mr-2"></i>${t('Add to My Services')}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function showAddGlobalServiceToMyServices(globalServiceId) {
            try {
                const doc = await db.collection('globalServices').doc(globalServiceId).get();
                if (!doc.exists) {
                    showToast('Service not found', 'error');
                    return;
                }
                
                const globalService = doc.data();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                const translatedCategory = t(globalService.category);
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">${t('Add Global Service to My Services')}</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        
                        <div class="bg-blue-50 border-l-4 border-primary p-4 mb-6 rounded-lg">
                            <p class="text-sm text-gray-700">
                                <i class="fas fa-info-circle text-primary mr-2"></i>
                                ${t('You can customize the price and duration for your practice. The service name and category will be copied from the global template.')}
                            </p>
                        </div>
                        
                        <form id="add-global-service-form" class="space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="md:col-span-2 bg-gray-50 p-4 rounded-lg">
                                    <label class="block text-gray-700 font-semibold mb-2">${t('Service Name')}</label>
                                    <p class="text-lg font-bold text-gray-800">${globalService.name}</p>
                                </div>
                                
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <label class="block text-gray-700 font-semibold mb-2">${t('Category')}</label>
                                    <p class="text-gray-800">${translatedCategory}</p>
                                </div>
                                
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <label class="block text-gray-700 font-semibold mb-2">${t('Default Duration')}</label>
                                    <p class="text-gray-800">${globalService.duration} ${t('minutes')}</p>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">${t('Your Duration (minutes)')} *</label>
                                    <input type="number" id="my-duration" required value="${globalService.duration}" min="5" max="480" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">${t('Your Price')}</label>
                                    <input type="number" id="my-price" value="${globalService.price || ''}" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label class="block text-gray-700 font-semibold mb-2">${t('Currency')}</label>
                                    <select id="my-currency" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                        <option value="SAR" ${globalService.currency === 'SAR' ? 'selected' : ''}>${t('SR Saudi Riyal')}</option>
                                        <option value="AED" ${globalService.currency === 'AED' ? 'selected' : ''}>${t('AED UAE Dirham')}</option>
                                        <option value="USD" ${globalService.currency === 'USD' ? 'selected' : ''}>${t('$ USD')}</option>
                                        <option value="EUR" ${globalService.currency === 'EUR' ? 'selected' : ''}>${t('‚Ç¨ EUR')}</option>
                                        <option value="GBP" ${globalService.currency === 'GBP' ? 'selected' : ''}>${t('¬£ GBP')}</option>
                                    </select>
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label class="block text-gray-700 font-semibold mb-2">${t('Additional Notes (Optional)')}</label>
                                    <textarea id="my-description" rows="3" placeholder="${t('Add your own notes or modify the description...')}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">${globalService.description || ''}</textarea>
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="checkbox" id="my-active" checked class="w-5 h-5 text-primary rounded focus:ring-2 focus:ring-primary">
                                        <span class="text-gray-700 font-semibold">${t('Active (available for booking)')}</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex space-x-2 pt-4 border-t">
                                <button type="submit" id="add-global-service-btn" class="flex-1 bg-gradient-to-r from-primary to-blue-600 text-white px-6 py-3 rounded-lg hover:from-blue-600 hover:to-blue-700 transition font-semibold shadow-md">
                                    <span id="add-global-service-text"><i class="fas fa-plus mr-2"></i>${t('Add to My Services')}</span>
                                    <span id="add-global-service-spinner" class="hidden"><i class="fas fa-spinner fa-spin mr-2"></i>Adding...</span>
                                </button>
                                <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition font-semibold">
                                    ${t('Cancel')}
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                document.getElementById('modal-container').appendChild(modal);
                
                document.getElementById('add-global-service-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Show loading spinner
                    const btn = document.getElementById('add-global-service-btn');
                    const btnText = document.getElementById('add-global-service-text');
                    const btnSpinner = document.getElementById('add-global-service-spinner');
                    btn.disabled = true;
                    btnText.classList.add('hidden');
                    btnSpinner.classList.remove('hidden');
                    
                    try {
                        const serviceData = {
                            globalServiceId: globalServiceId,
                            name: globalService.name,
                            category: globalService.category,
                            duration: parseInt(document.getElementById('my-duration').value),
                            price: parseFloat(document.getElementById('my-price').value) || 0,
                            currency: document.getElementById('my-currency').value,
                            description: document.getElementById('my-description').value || globalService.description || '',
                            isActive: document.getElementById('my-active').checked,
                            sourceType: 'global'
                        };
                        
                        // Add service to profile's services array
                        const updatedServices = [...(doctorProfile.services || []), serviceData];
                        
                        const profileId = `${currentUser.id}_${CLINIC_ID}`;
                        await db.collection('doctorClinicProfiles').doc(profileId).update({
                            services: updatedServices,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        doctorProfile.services = updatedServices;
                        showToast('Service added to your services successfully!', 'success');
                        closeModal();
                        
                        // Switch back to My Services tab and reload
                        switchServiceTab('my-services');
                        loadServices();
                    } catch (error) {
                        console.error('Error adding service:', error);
                        showToast('Error adding service', 'error');
                        
                        // Hide loading spinner on error
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        btnSpinner.classList.add('hidden');
                    }
                });
            } catch (error) {
                console.error('Error loading global service:', error);
                showToast('Error loading service', 'error');
            }
        }
        
        function generateTimeOptions(selectedTime) {
            const times = [];
            for (let hour = 0; hour < 24; hour++) {
                for (let min = 0; min < 60; min += 30) {
                    const time24 = `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
                    const period = hour >= 12 ? 'PM' : 'AM';
                    const hour12 = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
                    const time12 = `${hour12}:${min.toString().padStart(2, '0')} ${period}`;
                    const selected = time24 === selectedTime ? 'selected' : '';
                    times.push(`<option value="${time24}" ${selected}>${time12}</option>`);
                }
            }
            return times.join('');
        }
        
        let selectedDuration = 30;
        let selectedBuffer = 10;
        
        function selectDuration(duration) {
            selectedDuration = duration;
            document.querySelectorAll('.duration-btn').forEach(btn => {
                const btnDuration = parseInt(btn.dataset.duration);
                if (btnDuration === duration) {
                    btn.classList.remove('border-gray-300', 'text-gray-800');
                    btn.classList.add('border-primary', 'bg-blue-50');
                    btn.querySelector('div:first-child').classList.remove('text-gray-800');
                    btn.querySelector('div:first-child').classList.add('text-primary');
                    btn.querySelector('div:last-child').classList.remove('text-gray-600');
                    btn.querySelector('div:last-child').classList.add('text-primary');
                } else {
                    btn.classList.remove('border-primary', 'bg-blue-50');
                    btn.classList.add('border-gray-300');
                    btn.querySelector('div:first-child').classList.remove('text-primary');
                    btn.querySelector('div:first-child').classList.add('text-gray-800');
                    btn.querySelector('div:last-child').classList.remove('text-primary');
                    btn.querySelector('div:last-child').classList.add('text-gray-600');
                }
            });
            updateWeeklySummary();
        }
        
        function selectBuffer(buffer) {
            selectedBuffer = buffer;
            document.querySelectorAll('.buffer-btn').forEach(btn => {
                const btnBuffer = parseInt(btn.dataset.buffer);
                if (btnBuffer === buffer) {
                    btn.classList.remove('border-gray-300', 'text-gray-800');
                    btn.classList.add('border-primary', 'bg-blue-50');
                    btn.querySelector('div:first-child').classList.remove('text-gray-800');
                    btn.querySelector('div:first-child').classList.add('text-primary');
                    btn.querySelector('div:last-child').classList.remove('text-gray-600');
                    btn.querySelector('div:last-child').classList.add('text-primary');
                } else {
                    btn.classList.remove('border-primary', 'bg-blue-50');
                    btn.classList.add('border-gray-300');
                    btn.querySelector('div:first-child').classList.remove('text-primary');
                    btn.querySelector('div:first-child').classList.add('text-gray-800');
                    btn.querySelector('div:last-child').classList.remove('text-primary');
                    btn.querySelector('div:last-child').classList.add('text-gray-600');
                }
            });
        }
        
        async function loadAvailability() {
            if (!doctorProfile) return;
            
            selectedDuration = doctorProfile.appointmentDuration || 30;
            selectedBuffer = doctorProfile.bufferTime || 10;
            
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const dayEmojis = {
                'monday': 'üåô',
                'tuesday': 'üî•',
                'wednesday': 'üíö',
                'thursday': '‚ö°',
                'friday': 'üéâ',
                'saturday': 'üåü',
                'sunday': '‚òÄÔ∏è'
            };
            const schedule = doctorProfile.weeklySchedule || {};
            
            const scheduleDiv = document.getElementById('weekly-schedule');
            scheduleDiv.innerHTML = days.map(day => {
                const daySchedule = schedule[day];
                let isEnabled = daySchedule && daySchedule.length > 0;
                let amSchedule = null;
                let pmSchedule = null;
                
                // Handle both old and new data structures
                if (daySchedule && daySchedule.length > 0) {
                    // Check if it's the new format (with period property)
                    if (daySchedule[0].period) {
                        amSchedule = daySchedule.find(s => s.period === 'am');
                        pmSchedule = daySchedule.find(s => s.period === 'pm');
                    } else {
                        // Old format - convert to AM schedule by default
                        amSchedule = { start: daySchedule[0].start, end: daySchedule[0].end };
                    }
                }
                
                const amEnabled = !!amSchedule;
                const pmEnabled = !!pmSchedule;
                
                return `
                    <div class="border-2 ${isEnabled ? 'border-green-300 bg-gradient-to-r from-green-50 to-blue-50' : 'border-gray-300 bg-gray-50'} rounded-xl p-5 transition-all duration-300">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-bold text-gray-800 capitalize flex items-center">
                                <span class="text-2xl mr-2">${dayEmojis[day]}</span>
                                ${day}
                            </h4>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="schedule-${day}-enabled" ${isEnabled ? 'checked' : ''} 
                                       onchange="toggleDay('${day}')" class="sr-only peer">
                                <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-500"></div>
                                <span class="ml-3 text-sm font-semibold ${isEnabled ? 'text-green-600' : 'text-gray-600'}" id="schedule-${day}-label">${isEnabled ? 'ON' : 'OFF'}</span>
                            </label>
                        </div>
                        <div id="schedule-${day}-times" ${!isEnabled ? 'style="display:none"' : ''} class="space-y-3">
                            <!-- AM Schedule -->
                            <div class="border-2 ${amEnabled ? 'border-yellow-300 bg-yellow-50' : 'border-gray-200 bg-white'} rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h5 class="text-sm font-bold text-gray-700 flex items-center">
                                        <span class="text-xl mr-2">üåÖ</span> AM Schedule
                                    </h5>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="schedule-${day}-am-enabled" ${amEnabled ? 'checked' : ''} 
                                               onchange="togglePeriod('${day}', 'am')" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-yellow-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500"></div>
                                    </label>
                                </div>
                                <div id="schedule-${day}-am-times" ${!amEnabled ? 'style="display:none"' : ''} class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-600 mb-1">Start</label>
                                        <select id="schedule-${day}-am-start" onchange="updateWeeklySummary()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 text-sm">
                                            ${generateTimeOptions(amSchedule?.start || '08:00')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-600 mb-1">End</label>
                                        <select id="schedule-${day}-am-end" onchange="updateWeeklySummary()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 text-sm">
                                            ${generateTimeOptions(amSchedule?.end || '12:00')}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- PM Schedule -->
                            <div class="border-2 ${pmEnabled ? 'border-blue-300 bg-blue-50' : 'border-gray-200 bg-white'} rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h5 class="text-sm font-bold text-gray-700 flex items-center">
                                        <span class="text-xl mr-2">üåÜ</span> PM Schedule
                                    </h5>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="schedule-${day}-pm-enabled" ${pmEnabled ? 'checked' : ''} 
                                               onchange="togglePeriod('${day}', 'pm')" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                                    </label>
                                </div>
                                <div id="schedule-${day}-pm-times" ${!pmEnabled ? 'style="display:none"' : ''} class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-600 mb-1">Start</label>
                                        <select id="schedule-${day}-pm-start" onchange="updateWeeklySummary()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400 text-sm">
                                            ${generateTimeOptions(pmSchedule?.start || '13:00')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-600 mb-1">End</label>
                                        <select id="schedule-${day}-pm-end" onchange="updateWeeklySummary()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400 text-sm">
                                            ${generateTimeOptions(pmSchedule?.end || '17:00')}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg p-3 border border-gray-200" id="schedule-${day}-stats">
                                <div class="text-xs text-gray-600">Calculating...</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Set selected duration and buffer AFTER HTML is rendered
            setTimeout(() => {
                selectDuration(selectedDuration);
                selectBuffer(selectedBuffer);
                // Force immediate update
                updateWeeklySummary();
                loadOffDates();
            }, 0);
        }
        
        function toggleDay(day) {
            const checkbox = document.getElementById(`schedule-${day}-enabled`);
            const timesDiv = document.getElementById(`schedule-${day}-times`);
            const label = document.getElementById(`schedule-${day}-label`);
            const container = checkbox.closest('.border-2');
            
            if (checkbox.checked) {
                timesDiv.style.display = 'block';
                container.classList.remove('border-gray-300', 'bg-gray-50');
                container.classList.add('border-green-300', 'bg-gradient-to-r', 'from-green-50', 'to-blue-50');
                label.textContent = 'ON';
                label.classList.remove('text-gray-600');
                label.classList.add('text-green-600');
            } else {
                timesDiv.style.display = 'none';
                container.classList.remove('border-green-300', 'bg-gradient-to-r', 'from-green-50', 'to-blue-50');
                container.classList.add('border-gray-300', 'bg-gray-50');
                label.textContent = 'OFF';
                label.classList.remove('text-green-600');
                label.classList.add('text-gray-600');
            }
            updateWeeklySummary();
        }
        
        function togglePeriod(day, period) {
            const checkbox = document.getElementById(`schedule-${day}-${period}-enabled`);
            const timesDiv = document.getElementById(`schedule-${day}-${period}-times`);
            const container = checkbox.closest('.border-2');
            
            if (checkbox.checked) {
                timesDiv.style.display = 'grid';
                if (period === 'am') {
                    container.classList.remove('border-gray-200', 'bg-white');
                    container.classList.add('border-yellow-300', 'bg-yellow-50');
                } else {
                    container.classList.remove('border-gray-200', 'bg-white');
                    container.classList.add('border-blue-300', 'bg-blue-50');
                }
            } else {
                timesDiv.style.display = 'none';
                if (period === 'am') {
                    container.classList.remove('border-yellow-300', 'bg-yellow-50');
                    container.classList.add('border-gray-200', 'bg-white');
                } else {
                    container.classList.remove('border-blue-300', 'bg-blue-50');
                    container.classList.add('border-gray-200', 'bg-white');
                }
            }
            updateWeeklySummary();
        }
        
        function updateWeeklySummary() {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            let workingDays = 0;
            let totalHours = 0;
            
            // Batch DOM reads and writes for better performance
            const updates = [];
            
            days.forEach(day => {
                const checkbox = document.getElementById(`schedule-${day}-enabled`);
                if (checkbox && checkbox.checked) {
                    let dayHours = 0;
                    let hasSchedule = false;
                    
                    // Calculate AM hours
                    const amCheckbox = document.getElementById(`schedule-${day}-am-enabled`);
                    if (amCheckbox && amCheckbox.checked) {
                        hasSchedule = true;
                        const amStart = document.getElementById(`schedule-${day}-am-start`)?.value || '08:00';
                        const amEnd = document.getElementById(`schedule-${day}-am-end`)?.value || '12:00';
                        const [startHour, startMin] = amStart.split(':').map(Number);
                        const [endHour, endMin] = amEnd.split(':').map(Number);
                        dayHours += (endHour + endMin / 60) - (startHour + startMin / 60);
                    }
                    
                    // Calculate PM hours
                    const pmCheckbox = document.getElementById(`schedule-${day}-pm-enabled`);
                    if (pmCheckbox && pmCheckbox.checked) {
                        hasSchedule = true;
                        const pmStart = document.getElementById(`schedule-${day}-pm-start`)?.value || '13:00';
                        const pmEnd = document.getElementById(`schedule-${day}-pm-end`)?.value || '17:00';
                        const [startHour, startMin] = pmStart.split(':').map(Number);
                        const [endHour, endMin] = pmEnd.split(':').map(Number);
                        dayHours += (endHour + endMin / 60) - (startHour + startMin / 60);
                    }
                    
                    if (hasSchedule) {
                        workingDays++;
                        totalHours += dayHours;
                        
                        // Prepare update for day stats
                        const appointments = Math.floor((dayHours * 60) / (selectedDuration + selectedBuffer));
                        updates.push({
                            id: `schedule-${day}-stats`,
                            html: `
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-600">üìä ${dayHours.toFixed(1)} hours</span>
                                    <span class="text-primary font-semibold">~${appointments} appointments</span>
                                </div>
                            `
                        });
                    }
                }
            });
            
            // Batch DOM writes
            requestAnimationFrame(() => {
                updates.forEach(update => {
                    const element = document.getElementById(update.id);
                    if (element) element.innerHTML = update.html;
                });
                
                const offDays = 7 - workingDays;
                const totalAppointments = Math.floor((totalHours * 60) / (selectedDuration + selectedBuffer));
                
                document.getElementById('summary-days').textContent = workingDays;
                document.getElementById('summary-hours').textContent = totalHours.toFixed(1);
                document.getElementById('summary-appointments').textContent = `~${totalAppointments}`;
                document.getElementById('summary-off').textContent = offDays;
            });
        }
        
        function copyToWeekdays() {
            const monday = {
                enabled: document.getElementById('schedule-monday-enabled').checked,
                amEnabled: document.getElementById('schedule-monday-am-enabled').checked,
                amStart: document.getElementById('schedule-monday-am-start')?.value,
                amEnd: document.getElementById('schedule-monday-am-end')?.value,
                pmEnabled: document.getElementById('schedule-monday-pm-enabled').checked,
                pmStart: document.getElementById('schedule-monday-pm-start')?.value,
                pmEnd: document.getElementById('schedule-monday-pm-end')?.value
            };
            
            const weekdays = ['tuesday', 'wednesday', 'thursday', 'friday'];
            weekdays.forEach(day => {
                // Copy main toggle
                document.getElementById(`schedule-${day}-enabled`).checked = monday.enabled;
                toggleDay(day);
                
                // Copy AM schedule
                document.getElementById(`schedule-${day}-am-enabled`).checked = monday.amEnabled;
                if (monday.amStart) document.getElementById(`schedule-${day}-am-start`).value = monday.amStart;
                if (monday.amEnd) document.getElementById(`schedule-${day}-am-end`).value = monday.amEnd;
                togglePeriod(day, 'am');
                
                // Copy PM schedule
                document.getElementById(`schedule-${day}-pm-enabled`).checked = monday.pmEnabled;
                if (monday.pmStart) document.getElementById(`schedule-${day}-pm-start`).value = monday.pmStart;
                if (monday.pmEnd) document.getElementById(`schedule-${day}-pm-end`).value = monday.pmEnd;
                togglePeriod(day, 'pm');
            });
            
            showToast('Schedule copied to weekdays', 'success');
            updateWeeklySummary();
        }
        
        function copyToAll() {
            const monday = {
                enabled: document.getElementById('schedule-monday-enabled').checked,
                amEnabled: document.getElementById('schedule-monday-am-enabled').checked,
                amStart: document.getElementById('schedule-monday-am-start')?.value,
                amEnd: document.getElementById('schedule-monday-am-end')?.value,
                pmEnabled: document.getElementById('schedule-monday-pm-enabled').checked,
                pmStart: document.getElementById('schedule-monday-pm-start')?.value,
                pmEnd: document.getElementById('schedule-monday-pm-end')?.value
            };
            
            const allDays = ['tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            allDays.forEach(day => {
                // Copy main toggle
                document.getElementById(`schedule-${day}-enabled`).checked = monday.enabled;
                toggleDay(day);
                
                // Copy AM schedule
                document.getElementById(`schedule-${day}-am-enabled`).checked = monday.amEnabled;
                if (monday.amStart) document.getElementById(`schedule-${day}-am-start`).value = monday.amStart;
                if (monday.amEnd) document.getElementById(`schedule-${day}-am-end`).value = monday.amEnd;
                togglePeriod(day, 'am');
                
                // Copy PM schedule
                document.getElementById(`schedule-${day}-pm-enabled`).checked = monday.pmEnabled;
                if (monday.pmStart) document.getElementById(`schedule-${day}-pm-start`).value = monday.pmStart;
                if (monday.pmEnd) document.getElementById(`schedule-${day}-pm-end`).value = monday.pmEnd;
                togglePeriod(day, 'pm');
            });
            
            showToast('Schedule copied to all days', 'success');
            updateWeeklySummary();
        }
        
        async function saveWeeklySchedule() {
            // Show loading spinner
            const btn = document.getElementById('save-schedule-btn');
            const btnText = document.getElementById('save-schedule-text');
            const btnSpinner = document.getElementById('save-schedule-spinner');
            btn.disabled = true;
            btnText.classList.add('hidden');
            btnSpinner.classList.remove('hidden');
            
            try {
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                const schedule = {};
                
                console.log('üîç Starting to build schedule...');
                
                days.forEach(day => {
                    const isEnabled = document.getElementById(`schedule-${day}-enabled`).checked;
                    console.log(`üìÖ ${day}: Main toggle = ${isEnabled}`);
                    
                    if (isEnabled) {
                        const daySchedule = [];
                        
                        // Check AM period
                        const amEnabled = document.getElementById(`schedule-${day}-am-enabled`)?.checked;
                        console.log(`   üåÖ AM enabled: ${amEnabled}`);
                        if (amEnabled) {
                            const amStart = document.getElementById(`schedule-${day}-am-start`)?.value;
                            const amEnd = document.getElementById(`schedule-${day}-am-end`)?.value;
                            console.log(`   üåÖ AM times: ${amStart} - ${amEnd}`);
                            if (amStart && amEnd) {
                                daySchedule.push({ period: 'am', start: amStart, end: amEnd });
                                console.log(`   ‚úÖ Added AM period`);
                            }
                        }
                        
                        // Check PM period
                        const pmEnabled = document.getElementById(`schedule-${day}-pm-enabled`)?.checked;
                        console.log(`   üåÜ PM enabled: ${pmEnabled}`);
                        if (pmEnabled) {
                            const pmStart = document.getElementById(`schedule-${day}-pm-start`)?.value;
                            const pmEnd = document.getElementById(`schedule-${day}-pm-end`)?.value;
                            console.log(`   üåÜ PM times: ${pmStart} - ${pmEnd}`);
                            if (pmStart && pmEnd) {
                                daySchedule.push({ period: 'pm', start: pmStart, end: pmEnd });
                                console.log(`   ‚úÖ Added PM period`);
                            }
                        }
                        
                        schedule[day] = daySchedule;
                        console.log(`   üìä ${day} final schedule:`, daySchedule);
                    } else {
                        schedule[day] = [];
                        console.log(`   ‚ùå ${day} is OFF`);
                    }
                });
                
                console.log('üì¶ Final schedule object:', schedule);
                
                // Save to clinic-specific profile (doctorClinicProfiles)
                const profileId = `${currentUser.id}_${CLINIC_ID}`;
                console.log('üíæ Saving to doctorClinicProfiles, doc ID:', profileId);
                await db.collection('doctorClinicProfiles').doc(profileId).update({
                    weeklySchedule: schedule,
                    appointmentDuration: selectedDuration,
                    bufferTime: selectedBuffer,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('‚úÖ Saved to doctorClinicProfiles');
                
                doctorProfile.weeklySchedule = schedule;
                doctorProfile.appointmentDuration = selectedDuration;
                doctorProfile.bufferTime = selectedBuffer;
                
                // Hide loading spinner
                btn.disabled = false;
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
                
                showToast('Schedule saved successfully! üéâ', 'success');
            } catch (error) {
                console.error('Error saving schedule:', error);
                showToast('Error saving schedule', 'error');
                
                // Hide loading spinner on error
                btn.disabled = false;
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
            }
        }
        
        async function loadOffDates() {
            if (!doctorProfile) return;
            const offDates = doctorProfile.offDates || [];
            const list = document.getElementById('off-dates-list');
            
            if (offDates.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-calendar-check text-4xl mb-2"></i>
                        <p>No off dates scheduled</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = offDates.map(item => {
                const date = typeof item === 'string' ? item : item.date;
                const reason = typeof item === 'object' ? item.reason : '';
                const dateObj = new Date(date + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                return `
                    <div class="flex items-center justify-between bg-gradient-to-r from-red-50 to-orange-50 p-4 rounded-lg border-l-4 border-red-500 hover:shadow-md transition">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-calendar-times text-red-500"></i>
                                <span class="font-semibold text-gray-800">${formattedDate}</span>
                            </div>
                            ${reason ? `<p class="text-sm text-gray-600 mt-1 ml-6">${reason}</p>` : ''}
                        </div>
                        <button onclick="removeOffDate('${date}')" class="text-red-500 hover:text-red-700 p-2 hover:bg-red-100 rounded-lg transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        async function addOffDate() {
            const dateInput = document.getElementById('off-date-input');
            const reasonInput = document.getElementById('off-date-reason');
            const date = dateInput.value;
            const reason = reasonInput.value.trim();
            
            if (!date) {
                showToast('Please select a date', 'warning');
                return;
            }
            
            try {
                const offDates = doctorProfile.offDates || [];
                
                // Check if date already exists
                const dateExists = offDates.some(item => {
                    const existingDate = typeof item === 'string' ? item : item.date;
                    return existingDate === date;
                });
                
                if (dateExists) {
                    showToast('Date already added', 'warning');
                    return;
                }
                
                // Add with reason if provided
                const newEntry = reason ? { date, reason } : date;
                offDates.push(newEntry);
                
                await db.collection('doctors').doc(doctorProfile.id).update({ offDates });
                doctorProfile.offDates = offDates;
                
                dateInput.value = '';
                reasonInput.value = '';
                loadOffDates();
                showToast('Off date added successfully! üö´', 'success');
            } catch (error) {
                console.error('Error adding off date:', error);
                showToast('Error adding off date', 'error');
            }
        }
        
        async function removeOffDate(date) {
            const confirmed = await showConfirmDialog(
                'Remove Off Date',
                'Are you sure you want to remove this off date?',
                'Remove',
                'Cancel'
            );
            
            if (!confirmed) return;
            
            try {
                const offDates = (doctorProfile.offDates || []).filter(item => {
                    const itemDate = typeof item === 'string' ? item : item.date;
                    return itemDate !== date;
                });
                
                await db.collection('doctors').doc(doctorProfile.id).update({ offDates });
                doctorProfile.offDates = offDates;
                loadOffDates();
                showToast('Off date removed successfully', 'success');
            } catch (error) {
                console.error('Error removing off date:', error);
                showToast('Error removing off date', 'error');
            }
        }
        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
        }
        
        // Modern confirmation dialog
        function showConfirmDialog(title, message, confirmText = 'Confirm', cancelText = 'Cancel') {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all">
                        <div class="text-center">
                            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                                <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">${title}</h3>
                            <p class="text-gray-600 mb-6">${message}</p>
                        </div>
                        <div class="flex space-x-3">
                            <button id="confirm-cancel" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition font-semibold">
                                ${cancelText}
                            </button>
                            <button id="confirm-ok" class="flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-lg hover:from-red-600 hover:to-red-700 transition font-semibold shadow-md">
                                ${confirmText}
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('modal-container').appendChild(modal);
                
                document.getElementById('confirm-ok').onclick = () => {
                    modal.remove();
                    resolve(true);
                };
                
                document.getElementById('confirm-cancel').onclick = () => {
                    modal.remove();
                    resolve(false);
                };
            });
        }
        
        // Transfer Doctor Functions
        async function showTransferModal(appointmentId) {
            try {
                currentTransferAppointmentId = appointmentId;
                
                // Get appointment details
                const aptDoc = await db.collection('appointments').doc(appointmentId).get();
                if (!aptDoc.exists) {
                    showToast('Appointment not found', 'error');
                    return;
                }
                
                currentTransferAppointment = { id: aptDoc.id, ...aptDoc.data() };
                
                // Populate modal with appointment info
                document.getElementById('transfer-patient-name').textContent = currentTransferAppointment.patientName || currentTransferAppointment.name || 'N/A';
                document.getElementById('transfer-date').textContent = formatDateReadable(currentTransferAppointment.date);
                document.getElementById('transfer-time').textContent = formatTime12h(currentTransferAppointment.startTime || currentTransferAppointment.time);
                document.getElementById('transfer-current-doctor').textContent = currentTransferAppointment.doctorName || 'Unknown';
                
                // Load ALL active doctors (exclude current doctor)
                await loadAvailableDoctorsForTransfer(currentUser.id);
                
                // Show modal
                document.getElementById('transfer-modal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error showing transfer modal:', error);
                showToast('Failed to load transfer options', 'error');
            }
        }
        
        async function loadAvailableDoctorsForTransfer(currentDoctorId) {
            try {
                const select = document.getElementById('transfer-new-doctor');
                select.innerHTML = '<option value="">Select a doctor...</option>';
                
                // Get ALL active doctors
                const doctorsSnap = await db.collection('users')
                    .where('role', '==', 'doctor')
                    .where('active', '==', true)
                    .get();
                
                let count = 0;
                doctorsSnap.docs.forEach(doc => {
                    // Exclude current doctor
                    if (doc.id !== currentDoctorId) {
                        const doctor = doc.data();
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = doctor.name;
                        option.dataset.email = doctor.email;
                        select.appendChild(option);
                        count++;
                    }
                });
                
                if (count === 0) {
                    select.innerHTML = '<option value="">No other doctors available</option>';
                    showToast('No other doctors available to transfer to', 'warning');
                }
                
            } catch (error) {
                console.error('Error loading doctors:', error);
                showToast('Failed to load doctors', 'error');
            }
        }
        
        function closeTransferModal() {
            document.getElementById('transfer-modal').classList.add('hidden');
            document.getElementById('transfer-new-doctor').value = '';
            document.getElementById('transfer-reason').value = '';
            currentTransferAppointmentId = null;
            currentTransferAppointment = null;
        }
        
        async function confirmTransferDoctor() {
            try {
                const newDoctorId = document.getElementById('transfer-new-doctor').value;
                const reason = document.getElementById('transfer-reason').value.trim();
                
                if (!newDoctorId) {
                    showToast('Please select a doctor', 'warning');
                    return;
                }
                
                // Show loading state
                const confirmBtn = document.querySelector('#transfer-modal button[onclick*="confirmTransferDoctor"]');
                const originalText = confirmBtn.innerHTML;
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Transferring...';
                
                // 1. Get new doctor details from Firebase
                const newDoctorDoc = await db.collection('users').doc(newDoctorId).get();
                if (!newDoctorDoc.exists) {
                    throw new Error('New doctor not found');
                }
                const newDoctor = newDoctorDoc.data();
                
                // Get doctor phone from doctors collection
                const doctorProfileSnap = await db.collection('doctors')
                    .where('userId', '==', newDoctorId)
                    .get();
                const doctorPhone = doctorProfileSnap.docs[0]?.data()?.phone || '';
                
                // 2. Update Firebase appointment
                await db.collection('appointments').doc(currentTransferAppointmentId).update({
                    doctorId: newDoctorId,
                    doctorName: newDoctor.name,
                    transferHistory: firebase.firestore.FieldValue.arrayUnion({
                        fromDoctorId: currentTransferAppointment.doctorId || '',
                        fromDoctorName: currentTransferAppointment.doctorName || '',
                        toDoctorId: newDoctorId || '',
                        toDoctorName: newDoctor.name || '',
                        reason: reason || 'Not specified',
                        transferredAt: new Date().toISOString(),
                        transferredBy: currentUser?.id || currentUser?.email || 'unknown',
                        transferredByName: currentUser?.name || 'Unknown Doctor',
                        transferredByRole: 'doctor'
                    }),
                    updatedAt: new Date().toISOString()
                });
                
                // 3. Upsert to GHL with new doctor info
                const customFields = [
                    {
                        key: 'appointment_date',
                        value: currentTransferAppointment.date || ''
                    },
                    {
                        key: 'appointment_time',
                        value: currentTransferAppointment.startTime || currentTransferAppointment.time || ''
                    },
                    {
                        key: 'booking_time',
                        value: currentTransferAppointment.startTime || currentTransferAppointment.time || ''
                    },
                    {
                        key: 'booking_date_and_time',
                        value: `${currentTransferAppointment.date || ''} at ${currentTransferAppointment.startTime || currentTransferAppointment.time || ''}`
                    },
                    {
                        key: 'patient_phone_number',
                        value: currentTransferAppointment.patientPhone || currentTransferAppointment.phone || ''
                    },
                    {
                        key: 'doctor',
                        value: newDoctor.name
                    },
                    {
                        key: 'doctor_email',
                        value: newDoctor.email
                    },
                    {
                        key: 'doctor_phone',
                        value: doctorPhone
                    }
                ];
                
                // Add optional fields
                if (reason) {
                    customFields.push({
                        key: 'transfer_reason',
                        value: reason
                    });
                }
                
                customFields.push({
                    key: 'last_updated',
                    value: new Date().toISOString()
                });
                
                await upsertGHLContact({
                    email: currentTransferAppointment.patientEmail || currentTransferAppointment.email || '',
                    phone: currentTransferAppointment.patientPhone || currentTransferAppointment.phone || '',
                    name: currentTransferAppointment.patientName || currentTransferAppointment.name,
                    tags: ['Doctor Update', 'booking'],
                    customFields: customFields
                });
                
                showToast(`Appointment transferred to ${newDoctor.name}. This appointment will no longer appear in your view.`, 'success');
                closeTransferModal();
                loadKanban(); // Refresh Kanban board - appointment will disappear
                
            } catch (error) {
                console.error('Error transferring doctor:', error);
                showToast('Failed to transfer doctor. Please try again.', 'error');
                
                // Reset button
                const confirmBtn = document.querySelector('#transfer-modal button[onclick*="confirmTransferDoctor"]');
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Confirm Transfer';
                }
            }
        }
        
        function formatDateReadable(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
        
        function formatTime12h(time24) {
            if (!time24) return 'N/A';
            const [hours, minutes] = time24.split(':').map(Number);
            const period = hours >= 12 ? 'PM' : 'AM';
            const hour12 = hours === 0 ? 12 : hours > 12 ? hours - 12 : hours;
            return `${hour12}:${minutes.toString().padStart(2, '0')} ${period}`;
        }
        
        // ========== PATIENT DATABASE ==========
        
        let allPatients = [];
        let currentPatient = null;
        
        // ========== PATIENT ACTIVITY LOGGING ==========
        async function logPatientChange(patientId, { action, category, details, previousValue = null, newValue = null, source = 'doctor_portal' }) {
            try {
                const log = {
                    patientId: patientId,
                    action: action,
                    category: category,
                    details: details,
                    previousValue: previousValue,
                    newValue: newValue,
                    changedBy: {
                        userId: currentUser?.id || 'unknown',
                        name: currentUser?.name || 'Unknown',
                        role: currentUser?.role || 'doctor',
                        clinicId: CLINIC_ID || null,
                        clinicName: CLINIC_NAME || null
                    },
                    source: source,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('patientLogs').add(log);
                console.log('üìù Patient log added:', action, details);
            } catch (error) {
                console.error('Error logging patient change:', error);
                // Don't throw - logging failure shouldn't break the main operation
            }
        }
        
        let allActivityLogs = [];
        
        async function loadPatientActivityLogs() {
            if (!currentPatient?.firestoreId) return;
            
            try {
                const logsSnap = await db.collection('patientLogs')
                    .where('patientId', '==', currentPatient.firestoreId)
                    .orderBy('timestamp', 'desc')
                    .limit(100)
                    .get();
                
                allActivityLogs = logsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayActivityLogs(allActivityLogs);
            } catch (error) {
                console.error('Error loading activity logs:', error);
                document.getElementById('activity-log-list').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-exclamation-circle text-2xl mb-2 text-red-400"></i>
                        <p>Error loading activity log. The index may need to be created.</p>
                        <p class="text-xs mt-2">Check browser console for details.</p>
                    </div>
                `;
            }
        }
        
        function filterActivityLogs() {
            const filter = document.getElementById('activity-filter').value;
            if (filter === 'all') {
                displayActivityLogs(allActivityLogs);
            } else {
                const filtered = allActivityLogs.filter(log => log.category === filter);
                displayActivityLogs(filtered);
            }
        }
        
        function displayActivityLogs(logs) {
            const container = document.getElementById('activity-log-list');
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-clipboard-list text-4xl mb-3 text-gray-300"></i>
                        <p>No activity recorded yet.</p>
                        <p class="text-sm mt-1">Changes to this patient's profile will appear here.</p>
                    </div>
                `;
                return;
            }
            
            const categoryIcons = {
                'medical_history': 'fa-notes-medical text-red-500',
                'dental_chart': 'fa-tooth text-blue-500',
                'treatment_plan': 'fa-procedures text-green-500',
                'blood_profile': 'fa-tint text-red-600',
                'files': 'fa-file-upload text-purple-500',
                'profile': 'fa-user-edit text-gray-500',
                'appointment': 'fa-calendar-check text-indigo-500'
            };
            
            const sourceLabels = {
                'doctor_portal': 'Doctor Portal',
                'admin_portal': 'Admin Portal',
                'superadmin': 'Super Admin',
                'api': 'API',
                'patient_form': 'Patient Form'
            };
            
            container.innerHTML = logs.map(log => {
                const timestamp = log.timestamp?.toDate ? log.timestamp.toDate() : new Date(log.timestamp);
                const dateStr = timestamp.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const timeStr = timestamp.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                const icon = categoryIcons[log.category] || 'fa-edit text-gray-500';
                const sourceLabel = sourceLabels[log.source] || log.source || 'Unknown';
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-3">
                                <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center flex-shrink-0">
                                    <i class="fas ${icon}"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800">${log.action}</p>
                                    <p class="text-sm text-gray-600">${log.details}</p>
                                    <div class="flex items-center space-x-2 mt-2 text-xs text-gray-500">
                                        <span><i class="fas fa-user mr-1"></i>${log.changedBy?.name || 'Unknown'}</span>
                                        <span>‚Ä¢</span>
                                        <span class="px-2 py-0.5 rounded-full bg-gray-100">${log.changedBy?.role || 'unknown'}</span>
                                        ${log.changedBy?.clinicName ? `<span>‚Ä¢</span><span><i class="fas fa-hospital mr-1"></i>${log.changedBy.clinicName}</span>` : ''}
                                        <span>‚Ä¢</span>
                                        <span class="px-2 py-0.5 rounded-full bg-blue-50 text-blue-700">${sourceLabel}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right text-xs text-gray-500 flex-shrink-0">
                                <p>${dateStr}</p>
                                <p>${timeStr}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function loadDoctorPatients() {
            try {
                // PATIENT-FIRST APPROACH: Get patients and filter by doctor's appointments
                const patientsSnap = await db.collection('patients').get();
                
                // Get ALL this doctor's appointments across ALL clinics (for patient journey)
                const appointmentsSnap = await db.collection('appointments')
                    .where('doctorId', '==', currentUser.id)
                    .get();
                
                // Build appointments lookup by patientId and email
                const appointmentsByPatientId = {};
                const appointmentsByEmail = {};
                const doctorPatientIds = new Set();
                const doctorPatientEmails = new Set();
                
                appointmentsSnap.docs.forEach(doc => {
                    const apt = { id: doc.id, ...doc.data() };
                    // Track which patients this doctor has seen
                    if (apt.patientId) {
                        doctorPatientIds.add(apt.patientId);
                        if (!appointmentsByPatientId[apt.patientId]) appointmentsByPatientId[apt.patientId] = [];
                        appointmentsByPatientId[apt.patientId].push(apt);
                    }
                    if (apt.patientEmail) {
                        doctorPatientEmails.add(apt.patientEmail);
                        if (!appointmentsByEmail[apt.patientEmail]) appointmentsByEmail[apt.patientEmail] = [];
                        appointmentsByEmail[apt.patientEmail].push(apt);
                    }
                });
                
                // Build patients array - only include patients this doctor has seen
                allPatients = patientsSnap.docs
                    .filter(doc => {
                        const data = doc.data();
                        return doctorPatientIds.has(doc.id) || doctorPatientEmails.has(data.email);
                    })
                    .map(doc => {
                        const data = doc.data();
                        const firestoreId = doc.id;
                        
                        // Get visits from appointments (by patientId or email)
                        const visits = [
                            ...(appointmentsByPatientId[firestoreId] || []),
                            ...(appointmentsByEmail[data.email] || [])
                        ];
                        // Remove duplicates
                        const uniqueVisits = visits.filter((v, i, arr) => arr.findIndex(x => x.id === v.id) === i);
                        
                        // Calculate metrics
                        const sortedVisits = uniqueVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
                        const lastVisit = sortedVisits[0];
                        const daysSinceLastVisit = lastVisit ? Math.floor((new Date() - new Date(lastVisit.date)) / (1000 * 60 * 60 * 24)) : 999;
                        
                        let status = 'Active';
                        if (daysSinceLastVisit > 180) status = 'Inactive';
                        else if (uniqueVisits.length === 1) status = 'New';
                        
                        return {
                            id: firestoreId,
                            firestoreId: firestoreId,
                            name: data.name,
                            email: data.email,
                            phone: data.phone,
                            visits: uniqueVisits,
                            totalVisits: uniqueVisits.length,
                            lastVisit: lastVisit ? lastVisit.date : 'Never',
                            status: status,
                            daysSinceLastVisit: daysSinceLastVisit,
                            // Load saved data
                            medicalHistory: data.medicalHistory || {},
                            bloodProfile: data.bloodProfile || {},
                            dentalChart: data.dentalChart || {},
                            treatmentPlans: data.treatmentPlans || [],
                            files: data.files || {}
                        };
                    });
                
                displayPatients(allPatients);
                
            } catch (error) {
                console.error('Error loading patients:', error);
                showToast('Error loading patients', 'error');
            }
        }
        
        function displayPatients(patients) {
            const tbody = document.getElementById('patients-table-body');
            tbody.innerHTML = '';
            
            if (patients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500">No patients found</td></tr>';
                return;
            }
            
            patients.forEach(patient => {
                const statusColors = {
                    'Active': 'bg-green-100 text-green-800',
                    'Inactive': 'bg-red-100 text-red-800',
                    'New': 'bg-blue-100 text-blue-800'
                };
                
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm text-gray-600">${patient.id}</td>
                        <td class="px-6 py-4 font-semibold text-gray-800">${patient.name || 'N/A'}</td>
                        <td class="px-6 py-4 text-sm">
                            <div class="text-gray-600">${patient.phone || 'N/A'}</div>
                            <div class="text-xs text-gray-500">${patient.email || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 font-semibold text-gray-800">${patient.totalVisits}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${patient.lastVisit}</td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColors[patient.status]}">${patient.status}</span>
                        </td>
                        <td class="px-6 py-4">
                            <button onclick='viewPatientProfile(${JSON.stringify(patient).replace(/'/g, "&#39;")})' class="text-purple-600 hover:text-purple-800 font-semibold text-sm">
                                <i class="fas fa-eye mr-1"></i> View
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        function searchPatients() {
            const query = document.getElementById('patient-search').value.toLowerCase();
            const filtered = allPatients.filter(p => 
                (p.name && p.name.toLowerCase().includes(query)) ||
                (p.email && p.email.toLowerCase().includes(query)) ||
                (p.phone && p.phone.includes(query))
            );
            displayPatients(filtered);
        }
        
        function filterPatients() {
            const statusFilter = document.getElementById('patient-filter-status').value;
            
            let filtered = allPatients;
            
            if (statusFilter) {
                filtered = filtered.filter(p => p.status.toLowerCase() === statusFilter);
            }
            
            displayPatients(filtered);
        }
        
        function clearPatientFilters() {
            document.getElementById('patient-search').value = '';
            document.getElementById('patient-filter-status').value = '';
            displayPatients(allPatients);
        }
        
        function viewPatientProfile(patient) {
            currentPatient = patient;
            document.getElementById('patient-list-view').classList.add('hidden');
            document.getElementById('patient-profile-view').classList.remove('hidden');
            
            // Set patient header
            document.getElementById('profile-patient-name').textContent = patient.name || 'Unknown Patient';
            document.getElementById('profile-patient-id').textContent = `Patient ID: ${patient.id}`;
            
            const statusColors = {
                'Active': 'bg-green-500',
                'Inactive': 'bg-red-500',
                'New': 'bg-blue-500'
            };
            document.getElementById('profile-patient-status').innerHTML = `
                <span class="px-4 py-2 rounded-full text-sm font-semibold ${statusColors[patient.status]} text-white">
                    ${patient.status}
                </span>
            `;
            
            // Show overview tab by default
            showPatientTab('overview');
        }
        
        function closePatientProfile() {
            document.getElementById('patient-list-view').classList.remove('hidden');
            document.getElementById('patient-profile-view').classList.add('hidden');
            currentPatient = null;
        }
        
        async function showPatientTab(tabName) {
            // Update tab buttons - highlight the active tab
            document.querySelectorAll('.patient-tab-btn').forEach(btn => {
                btn.classList.remove('border-purple-600', 'text-purple-600');
                btn.classList.add('border-transparent', 'text-gray-500');
                // Find the button that matches the tabName and highlight it
                if (btn.getAttribute('onclick')?.includes(`'${tabName}'`)) {
                    btn.classList.remove('border-transparent', 'text-gray-500');
                    btn.classList.add('border-purple-600', 'text-purple-600');
                }
            });
            
            const content = document.getElementById('patient-tab-content');
            
            if (tabName === 'overview') {
                content.innerHTML = `
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Contact Information</h3>
                            <div class="space-y-3">
                                <div><span class="text-gray-600">Email:</span> <span class="font-semibold">${currentPatient.email || 'N/A'}</span></div>
                                <div><span class="text-gray-600">Phone:</span> <span class="font-semibold">${currentPatient.phone || 'N/A'}</span></div>
                                <div><span class="text-gray-600">Patient ID:</span> <span class="font-semibold">${currentPatient.id}</span></div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Visit Summary</h3>
                            <div class="space-y-3">
                                <div><span class="text-gray-600">Total Visits:</span> <span class="font-semibold">${currentPatient.totalVisits}</span></div>
                                <div><span class="text-gray-600">Last Visit:</span> <span class="font-semibold">${currentPatient.lastVisit}</span></div>
                                <div><span class="text-gray-600">Status:</span> <span class="font-semibold">${currentPatient.status}</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Recent Visits</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Doctor</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Service</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${currentPatient.visits.slice(0, 5).map(visit => `
                                        <tr>
                                            <td class="px-4 py-3 text-sm">${visit.date}</td>
                                            <td class="px-4 py-3 text-sm">${visit.doctorName || 'N/A'}</td>
                                            <td class="px-4 py-3 text-sm">${visit.service || visit.patientService || 'N/A'}</td>
                                            <td class="px-4 py-3 text-sm"><span class="px-2 py-1 rounded-full text-xs bg-gray-100">${visit.status}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else if (tabName === 'visits') {
                content.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Complete Visit History (All Clinics)</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Clinic</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Doctor</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Service</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${currentPatient.visits.map(visit => `
                                        <tr>
                                            <td class="px-4 py-3 text-sm">${visit.date}</td>
                                            <td class="px-4 py-3 text-sm">${visit.startTime || 'N/A'}</td>
                                            <td class="px-4 py-3 text-sm"><span class="px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-800">${visit.branch || visit.clinicId || 'N/A'}</span></td>
                                            <td class="px-4 py-3 text-sm">${visit.doctorName || 'N/A'}</td>
                                            <td class="px-4 py-3 text-sm">${visit.service || visit.patientService || 'N/A'}</td>
                                            <td class="px-4 py-3 text-sm"><span class="px-2 py-1 rounded-full text-xs bg-gray-100">${visit.status}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else if (tabName === 'activity') {
                // Activity Log Tab - Load from patientLogs collection
                content.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-800 flex items-center">
                                <i class="fas fa-history text-purple-600 mr-2"></i>Activity Log
                            </h3>
                            <select id="activity-filter" onchange="filterActivityLogs()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="all">All Activities</option>
                                <option value="medical_history">Medical History</option>
                                <option value="dental_chart">Dental Chart</option>
                                <option value="treatment_plan">Treatment Plans</option>
                                <option value="blood_profile">Blood Profile</option>
                                <option value="files">Files</option>
                            </select>
                        </div>
                        <div id="activity-log-list" class="space-y-3">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Loading activity log...</p>
                            </div>
                        </div>
                    </div>
                `;
                // Load activity logs
                loadPatientActivityLogs();
            } else if (tabName === 'medical') {
                // Medical History Tab - Load saved data
                const allergies = currentPatient.medicalHistory?.allergies || [];
                const medications = currentPatient.medicalHistory?.medications || [];
                const conditions = currentPatient.medicalHistory?.conditions || [];
                const bloodType = currentPatient.medicalHistory?.bloodType || '';
                const bloodPressure = currentPatient.medicalHistory?.bloodPressure || '';
                const emergencyContact = currentPatient.medicalHistory?.emergencyContact || '';
                
                content.innerHTML = `
                    <div class="space-y-6">
                        ${allergies.length === 0 && medications.length === 0 ? `
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg">
                            <div class="flex items-start">
                                <i class="fas fa-exclamation-triangle text-yellow-600 text-xl mr-3 mt-1"></i>
                                <div class="flex-1">
                                    <h4 class="font-bold text-yellow-800 mb-2">‚ö†Ô∏è Incomplete Medical Profile</h4>
                                    <p class="text-sm text-yellow-700 mb-3">Critical information is missing. Send a form to the patient to complete their medical history.</p>
                                    <button onclick="sendMedicalForm('${currentPatient.phone || currentPatient.email}')" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition text-sm font-semibold">
                                        <i class="fas fa-paper-plane mr-2"></i>Send Medical History Form
                                    </button>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-red-600 flex items-center"><i class="fas fa-allergies mr-2"></i>‚ö†Ô∏è ALLERGIES (${allergies.length})</h3>
                                <button onclick="addAllergy()" class="text-red-600 hover:text-red-700 text-sm font-semibold"><i class="fas fa-plus mr-1"></i>Add</button>
                            </div>
                            <div id="allergies-list" class="space-y-2">
                                ${allergies.length > 0 ? allergies.map(a => `
                                    <div class="flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-3">
                                        <span class="text-sm text-red-800 font-semibold">‚ö†Ô∏è ${a}</span>
                                        <button onclick="removeAllergy('${a}')" class="text-red-600 hover:text-red-800"><i class="fas fa-times"></i></button>
                                    </div>
                                `).join('') : `
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-sm text-red-800">
                                        <i class="fas fa-info-circle mr-2"></i>No allergies recorded.
                                    </div>
                                `}
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center"><i class="fas fa-pills mr-2 text-blue-600"></i>üíä Current Medications (${medications.length})</h3>
                                <button onclick="addMedication()" class="text-blue-600 hover:text-blue-700 text-sm font-semibold"><i class="fas fa-plus mr-1"></i>Add</button>
                            </div>
                            <div id="medications-list" class="space-y-2">
                                ${medications.length > 0 ? medications.map(m => `
                                    <div class="flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-3">
                                        <span class="text-sm text-blue-800">üíä ${m}</span>
                                        <button onclick="removeMedication('${m}')" class="text-blue-600 hover:text-blue-800"><i class="fas fa-times"></i></button>
                                    </div>
                                `).join('') : `
                                    <div class="text-sm text-gray-500 italic">No medications recorded</div>
                                `}
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-hospital mr-2 text-green-600"></i>üè• Medical Conditions</h3>
                            <div id="medical-conditions-list" class="grid md:grid-cols-2 gap-3">
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" value="Diabetes" class="form-checkbox text-purple-600" ${conditions.includes('Diabetes') ? 'checked' : ''}>
                                    <span class="text-sm">Diabetes</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" value="High Blood Pressure" class="form-checkbox text-purple-600" ${conditions.includes('High Blood Pressure') ? 'checked' : ''}>
                                    <span class="text-sm">High Blood Pressure</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" value="Heart Disease" class="form-checkbox text-purple-600" ${conditions.includes('Heart Disease') ? 'checked' : ''}>
                                    <span class="text-sm">Heart Disease</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" value="Asthma" class="form-checkbox text-purple-600" ${conditions.includes('Asthma') ? 'checked' : ''}>
                                    <span class="text-sm">Asthma</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" value="Pregnancy" class="form-checkbox text-purple-600" ${conditions.includes('Pregnancy') ? 'checked' : ''}>
                                    <span class="text-sm">Pregnancy</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" value="Bleeding Disorder" class="form-checkbox text-purple-600" ${conditions.includes('Bleeding Disorder') ? 'checked' : ''}>
                                    <span class="text-sm">Bleeding Disorder</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-heartbeat mr-2 text-purple-600"></i>Vital Information</h3>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Blood Pressure</label>
                                    <input type="text" id="vital-blood-pressure" value="${bloodPressure}" placeholder="120/80" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Emergency Contact</label>
                                    <input type="text" id="vital-emergency-contact" value="${emergencyContact}" placeholder="09123456789" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end">
                            <button id="btn-save-medical" onclick="saveMedicalHistory()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition font-semibold">
                                <i class="fas fa-save mr-2"></i>Save Medical History
                            </button>
                        </div>
                    </div>
                `;
            } else if (tabName === 'blood') {
                // Blood Profile Tab - Load saved data
                const bp = currentPatient.bloodProfile || {};
                const donations = bp.donations || [];
                const bpReadings = bp.bpReadings || [];
                const sugarReadings = bp.sugarReadings || [];
                const totalVolume = donations.reduce((sum, d) => sum + (d.volume || 0), 0);
                
                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-tint mr-2 text-red-600"></i>üî¥ Blood Type & RH Factor</h3>
                            <div class="grid md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Blood Type</label>
                                    <select id="blood-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="">Not specified</option>
                                        <option value="A" ${bp.bloodType === 'A' ? 'selected' : ''}>A</option>
                                        <option value="B" ${bp.bloodType === 'B' ? 'selected' : ''}>B</option>
                                        <option value="AB" ${bp.bloodType === 'AB' ? 'selected' : ''}>AB</option>
                                        <option value="O" ${bp.bloodType === 'O' ? 'selected' : ''}>O</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">RH Factor</label>
                                    <select id="rh-factor" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="">Not specified</option>
                                        <option value="positive" ${bp.rhFactor === 'positive' ? 'selected' : ''}>Positive (+)</option>
                                        <option value="negative" ${bp.rhFactor === 'negative' ? 'selected' : ''}>Negative (-)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Verified</label>
                                    <label class="flex items-center space-x-2 mt-2">
                                        <input type="checkbox" id="blood-verified" class="form-checkbox text-purple-600" ${bp.verified ? 'checked' : ''}>
                                        <span class="text-sm">Lab confirmed</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Last Updated</label>
                                    <input type="date" id="blood-last-updated" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="${bp.lastDonation || ''}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center"><i class="fas fa-hand-holding-heart mr-2 text-red-600"></i>ü©∏ Blood Donation History (${donations.length})</h3>
                                <button onclick="addDonationRecord()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition text-sm font-semibold"><i class="fas fa-plus mr-2"></i>Add Donation</button>
                            </div>
                            <div id="donation-history" class="space-y-2 mb-4">
                                ${donations.length > 0 ? donations.map(d => `
                                    <div class="flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-3">
                                        <div>
                                            <span class="font-semibold text-red-800">ü©∏ ${d.date}</span>
                                            <span class="text-sm text-gray-600 ml-2">${d.location || 'Unknown location'}</span>
                                        </div>
                                        <span class="text-sm font-semibold text-red-600">${d.volume || 450}ml - ${d.type || 'Whole Blood'}</span>
                                    </div>
                                `).join('') : `<p class="text-sm text-gray-500 italic">No donation records yet</p>`}
                            </div>
                            <div class="mt-4 grid md:grid-cols-2 gap-4">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                    <p class="text-sm text-gray-600">Total Donations</p>
                                    <p class="text-2xl font-bold text-blue-600">${donations.length}</p>
                                </div>
                                <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                    <p class="text-sm text-gray-600">Total Volume</p>
                                    <p class="text-2xl font-bold text-purple-600">${totalVolume} ml</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center"><i class="fas fa-heartbeat mr-2 text-red-600"></i>üìà Blood Pressure (${bpReadings.length})</h3>
                                <button onclick="addBPReading()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition text-sm font-semibold"><i class="fas fa-plus mr-2"></i>Add Reading</button>
                            </div>
                            ${bp.latestBP ? `<p class="text-lg mb-3">Latest: <span class="font-bold text-green-600">${bp.latestBP}</span></p>` : ''}
                            <div id="bp-history" class="space-y-2">
                                ${bpReadings.length > 0 ? bpReadings.slice(-5).reverse().map(r => `
                                    <div class="flex items-center justify-between bg-green-50 border border-green-200 rounded-lg p-3">
                                        <span class="text-sm text-gray-600">${new Date(r.datetime || r.createdAt).toLocaleString()}</span>
                                        <span class="font-bold text-green-600">${r.systolic}/${r.diastolic}</span>
                                    </div>
                                `).join('') : `<p class="text-sm text-gray-500 italic">No blood pressure readings yet</p>`}
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center"><i class="fas fa-candy-cane mr-2 text-pink-600"></i>üç¨ Blood Sugar (${sugarReadings.length})</h3>
                                <button onclick="addBloodSugar()" class="bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700 transition text-sm font-semibold"><i class="fas fa-plus mr-2"></i>Add Reading</button>
                            </div>
                            ${bp.latestSugar ? `<p class="text-lg mb-3">Latest: <span class="font-bold text-pink-600">${bp.latestSugar} mg/dL</span></p>` : ''}
                            <div id="sugar-history" class="space-y-2">
                                ${sugarReadings.length > 0 ? sugarReadings.slice(-5).reverse().map(r => `
                                    <div class="flex items-center justify-between bg-pink-50 border border-pink-200 rounded-lg p-3">
                                        <div>
                                            <span class="text-sm text-gray-600">${new Date(r.datetime || r.createdAt).toLocaleString()}</span>
                                            <span class="text-xs text-gray-500 ml-2">(${r.type})</span>
                                        </div>
                                        <span class="font-bold text-pink-600">${r.value} mg/dL</span>
                                    </div>
                                `).join('') : `<p class="text-sm text-gray-500 italic">No blood sugar readings yet</p>`}
                            </div>
                        </div>
                        
                        <div class="flex justify-end">
                            <button id="btn-save-blood" onclick="saveBloodProfile()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition font-semibold">
                                <i class="fas fa-save mr-2"></i>Save Blood Profile
                            </button>
                        </div>
                    </div>
                `;
            } else if (tabName === 'dental') {
                // Dental Chart Tab
                const teeth = currentPatient?.dentalChart?.teeth || {};
                const getToothColor = (toothNum) => {
                    const condition = teeth[toothNum]?.condition || '';
                    const colors = {
                        '': { icon: 'text-gray-400', border: 'border-gray-300', bg: 'bg-white' },
                        'missing': { icon: 'text-red-500', border: 'border-red-400', bg: 'bg-red-50' },
                        'cavity': { icon: 'text-yellow-500', border: 'border-yellow-400', bg: 'bg-yellow-50' },
                        'filling': { icon: 'text-blue-500', border: 'border-blue-400', bg: 'bg-blue-50' },
                        'crown': { icon: 'text-purple-500', border: 'border-purple-400', bg: 'bg-purple-50' },
                        'root-canal': { icon: 'text-green-500', border: 'border-green-400', bg: 'bg-green-50' },
                        'implant': { icon: 'text-gray-600', border: 'border-gray-500', bg: 'bg-gray-100' },
                        'bridge': { icon: 'text-orange-500', border: 'border-orange-400', bg: 'bg-orange-50' },
                        'attention': { icon: 'text-pink-500', border: 'border-pink-400', bg: 'bg-pink-50' }
                    };
                    return colors[condition] || colors[''];
                };
                
                const renderTooth = (toothNum) => {
                    const color = getToothColor(toothNum);
                    const hasData = teeth[toothNum]?.condition;
                    return `
                        <button onclick="selectTooth(${toothNum})" class="tooth-btn w-12 h-16 ${color.bg} border-2 ${color.border} rounded-lg hover:border-purple-500 hover:shadow-md transition flex flex-col items-center justify-center text-xs font-semibold relative">
                            <i class="fas fa-tooth text-2xl ${color.icon} mb-1"></i>
                            <span class="text-gray-600">${toothNum}</span>
                            ${hasData ? '<div class="absolute -top-1 -right-1 w-3 h-3 bg-purple-500 rounded-full"></div>' : ''}
                        </button>
                    `;
                };
                
                content.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">ü¶∑ Interactive Dental Chart</h3>
                        
                        <div class="mb-8">
                            <h4 class="text-lg font-semibold text-gray-700 mb-4 text-center">Upper Teeth</h4>
                            <div class="flex justify-center space-x-1 md:space-x-2 mb-2 flex-wrap">
                                ${[18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28].map(tooth => renderTooth(tooth)).join('')}
                            </div>
                            
                            <h4 class="text-lg font-semibold text-gray-700 mb-4 mt-8 text-center">Lower Teeth</h4>
                            <div class="flex justify-center space-x-1 md:space-x-2 flex-wrap">
                                ${[48,47,46,45,44,43,42,41,31,32,33,34,35,36,37,38].map(tooth => renderTooth(tooth)).join('')}
                            </div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-6">
                            <h4 class="font-bold text-gray-800 mb-3">Legend:</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                <div class="flex items-center space-x-2"><i class="fas fa-tooth text-gray-400"></i><span>Healthy</span></div>
                                <div class="flex items-center space-x-2"><i class="fas fa-tooth text-red-500"></i><span>Missing</span></div>
                                <div class="flex items-center space-x-2"><i class="fas fa-tooth text-yellow-500"></i><span>Cavity</span></div>
                                <div class="flex items-center space-x-2"><i class="fas fa-tooth text-blue-500"></i><span>Filling</span></div>
                                <div class="flex items-center space-x-2"><i class="fas fa-tooth text-purple-500"></i><span>Crown</span></div>
                                <div class="flex items-center space-x-2"><i class="fas fa-tooth text-green-500"></i><span>Root Canal</span></div>
                                <div class="flex items-center space-x-2"><i class="fas fa-tooth text-gray-600"></i><span>Implant</span></div>
                                <div class="flex items-center space-x-2"><i class="fas fa-tooth text-orange-500"></i><span>Bridge</span></div>
                                <div class="flex items-center space-x-2"><i class="fas fa-tooth text-pink-500"></i><span>Needs Attention</span></div>
                            </div>
                        </div>
                        
                        <!-- Tooth Details Panel -->
                        <div id="tooth-details" class="bg-blue-50 border border-blue-200 rounded-lg p-4 hidden">
                            <h4 class="font-bold text-blue-800 mb-3">Tooth #<span id="selected-tooth-number"></span> Details</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Condition</label>
                                    <select id="tooth-condition" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="">Healthy</option>
                                        <option value="missing">Missing</option>
                                        <option value="cavity">Cavity</option>
                                        <option value="filling">Filling</option>
                                        <option value="crown">Crown</option>
                                        <option value="root-canal">Root Canal</option>
                                        <option value="implant">Implant</option>
                                        <option value="bridge">Bridge</option>
                                        <option value="attention">Needs Attention</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Notes</label>
                                    <textarea id="tooth-notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Add notes about this tooth..."></textarea>
                                </div>
                                <div class="flex space-x-2">
                                    <button id="btn-save-tooth" onclick="saveToothData()" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition font-semibold"><i class="fas fa-save mr-2"></i>Save</button>
                                    <button onclick="closeToothDetails()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition font-semibold">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (tabName === 'files') {
                // Files & Images Tab
                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center"><i class="fas fa-x-ray mr-2 text-blue-600"></i>üî¨ X-Rays</h3>
                                <button onclick="uploadFile('xray')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm font-semibold"><i class="fas fa-upload mr-2"></i>Upload X-Ray</button>
                            </div>
                            <div id="xrays-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 flex flex-col items-center justify-center text-gray-400 hover:border-blue-500 hover:text-blue-500 cursor-pointer transition">
                                    <i class="fas fa-plus text-3xl mb-2"></i>
                                    <span class="text-sm">Upload X-Ray</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center"><i class="fas fa-camera mr-2 text-green-600"></i>üì∑ Intraoral Photos</h3>
                                <button onclick="uploadFile('photo')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm font-semibold"><i class="fas fa-upload mr-2"></i>Upload Photo</button>
                            </div>
                            <div id="photos-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 flex flex-col items-center justify-center text-gray-400 hover:border-green-500 hover:text-green-500 cursor-pointer transition">
                                    <i class="fas fa-plus text-3xl mb-2"></i>
                                    <span class="text-sm">Upload Photo</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center"><i class="fas fa-file-pdf mr-2 text-red-600"></i>üìÑ Documents</h3>
                                <button onclick="uploadFile('document')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition text-sm font-semibold"><i class="fas fa-upload mr-2"></i>Upload Document</button>
                            </div>
                            <div id="documents-list" class="space-y-2">
                                <div class="text-sm text-gray-500 italic">No documents uploaded yet</div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center"><i class="fas fa-id-card mr-2 text-purple-600"></i>üí≥ Insurance Cards</h3>
                                <button onclick="uploadFile('insurance')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition text-sm font-semibold"><i class="fas fa-upload mr-2"></i>Upload Card</button>
                            </div>
                            <div id="insurance-grid" class="grid grid-cols-2 gap-4">
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 flex flex-col items-center justify-center text-gray-400 hover:border-purple-500 hover:text-purple-500 cursor-pointer transition">
                                    <i class="fas fa-plus text-3xl mb-2"></i>
                                    <span class="text-sm">Front</span>
                                </div>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 flex flex-col items-center justify-center text-gray-400 hover:border-purple-500 hover:text-purple-500 cursor-pointer transition">
                                    <i class="fas fa-plus text-3xl mb-2"></i>
                                    <span class="text-sm">Back</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (tabName === 'treatment') {
                // Treatment Plans Tab
                const plans = currentPatient?.treatmentPlans || [];
                const activePlans = plans.filter(p => p.status === 'active');
                const completedPlans = plans.filter(p => p.status === 'completed');
                
                const getProcedureIcon = (status) => {
                    const icons = {
                        'pending': '<i class="fas fa-clock text-gray-400"></i>',
                        'scheduled': '<i class="fas fa-calendar text-blue-500"></i>',
                        'in-progress': '<i class="fas fa-spinner text-yellow-500"></i>',
                        'success': '<i class="fas fa-check-circle text-green-500"></i>',
                        'failed': '<i class="fas fa-times-circle text-red-500"></i>',
                        'cancelled': '<i class="fas fa-ban text-gray-500"></i>'
                    };
                    return icons[status] || icons['pending'];
                };
                
                const renderProcedure = (proc, planId) => `
                    <div class="flex items-center justify-between bg-gray-50 rounded-lg p-3 border border-gray-200">
                        <div class="flex items-center space-x-3">
                            ${getProcedureIcon(proc.status)}
                            <div>
                                <p class="font-semibold text-gray-800">${proc.name}</p>
                                <p class="text-xs text-gray-500">${proc.date ? new Date(proc.date).toLocaleDateString() : 'No date set'} ${proc.notes ? '‚Ä¢ ' + proc.notes : ''}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <select onchange="updateProcedureStatus('${planId}', '${proc.id}', this.value)" class="text-xs border border-gray-300 rounded px-2 py-1">
                                <option value="pending" ${proc.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="scheduled" ${proc.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
                                <option value="in-progress" ${proc.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                <option value="success" ${proc.status === 'success' ? 'selected' : ''}>Success</option>
                                <option value="failed" ${proc.status === 'failed' ? 'selected' : ''}>Failed</option>
                                <option value="cancelled" ${proc.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                            <button onclick="deleteProcedure('${planId}', '${proc.id}')" class="text-red-500 hover:text-red-700 text-sm"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
                
                const renderPlan = (plan, isCompleted = false) => {
                    const procedures = plan.procedures || [];
                    const successCount = procedures.filter(p => p.status === 'success').length;
                    const totalCount = procedures.length;
                    const progress = totalCount > 0 ? Math.round((successCount / totalCount) * 100) : 0;
                    
                    return `
                        <div class="border-2 ${isCompleted ? 'border-green-200 bg-green-50' : 'border-purple-200 bg-purple-50'} rounded-xl p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <h4 class="font-bold text-gray-800 text-lg">${plan.title}</h4>
                                    <p class="text-xs text-gray-500">Created: ${new Date(plan.createdAt).toLocaleDateString()} ${plan.tooth ? '‚Ä¢ Tooth #' + plan.tooth : ''}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    ${!isCompleted ? `
                                        <button onclick="addProcedure('${plan.id}')" class="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition text-xs font-semibold"><i class="fas fa-plus mr-1"></i>Add Procedure</button>
                                        <button onclick="completePlan('${plan.id}')" class="bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 transition text-xs font-semibold"><i class="fas fa-check mr-1"></i>Complete</button>
                                    ` : `
                                        <button onclick="reopenPlan('${plan.id}')" class="bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 transition text-xs font-semibold"><i class="fas fa-redo mr-1"></i>Reopen</button>
                                    `}
                                    <button onclick="deletePlan('${plan.id}')" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition text-xs font-semibold"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="mb-3">
                                <div class="flex justify-between text-xs text-gray-600 mb-1">
                                    <span>Progress</span>
                                    <span>${successCount}/${totalCount} procedures (${progress}%)</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full transition-all" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            
                            <!-- Procedures List -->
                            <div class="space-y-2">
                                ${procedures.length > 0 ? procedures.map(proc => renderProcedure(proc, plan.id)).join('') : '<p class="text-sm text-gray-500 italic text-center py-2">No procedures added yet</p>'}
                            </div>
                        </div>
                    `;
                };
                
                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center"><i class="fas fa-procedures mr-2 text-green-600"></i>üìã Active Treatment Plans (${activePlans.length})</h3>
                                <button onclick="createTreatmentPlan()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm font-semibold"><i class="fas fa-plus mr-2"></i>New Plan</button>
                            </div>
                            <div id="active-plans" class="space-y-4">
                                ${activePlans.length > 0 ? activePlans.map(plan => renderPlan(plan, false)).join('') : '<div class="text-sm text-gray-500 italic text-center py-8">No active treatment plans</div>'}
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-check-circle mr-2 text-blue-600"></i>‚úÖ Completed Treatment Plans (${completedPlans.length})</h3>
                            <div id="completed-plans" class="space-y-4">
                                ${completedPlans.length > 0 ? completedPlans.map(plan => renderPlan(plan, true)).join('') : '<div class="text-sm text-gray-500 italic">No completed treatment plans</div>'}
                            </div>
                        </div>
                    </div>
                `;
            } else if (tabName === 'forms') {
                // Forms & Documents Tab
                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                            <h3 class="text-xl font-bold mb-4">üì§ Send Form to Patient</h3>
                            <p class="mb-4 opacity-90">Generate a unique link and send it to the patient via SMS or Email.</p>
                            <div class="grid md:grid-cols-2 gap-4">
                                <button onclick="sendFormLink('medical', '${currentPatient.id}', '${currentPatient.phone || currentPatient.email}', '${currentPatient.name}')" class="bg-white text-purple-600 px-6 py-3 rounded-lg hover:bg-gray-100 transition font-semibold"><i class="fas fa-heartbeat mr-2"></i>Medical History Form</button>
                                <button onclick="sendFormLink('consent', '${currentPatient.id}', '${currentPatient.phone || currentPatient.email}', '${currentPatient.name}')" class="bg-white text-purple-600 px-6 py-3 rounded-lg hover:bg-gray-100 transition font-semibold"><i class="fas fa-file-signature mr-2"></i>Consent Form</button>
                                <button onclick="sendFormLink('insurance', '${currentPatient.id}', '${currentPatient.phone || currentPatient.email}', '${currentPatient.name}')" class="bg-white text-purple-600 px-6 py-3 rounded-lg hover:bg-gray-100 transition font-semibold"><i class="fas fa-id-card mr-2"></i>Insurance Form</button>
                                <button onclick="sendFormLink('feedback', '${currentPatient.id}', '${currentPatient.phone || currentPatient.email}', '${currentPatient.name}')" class="bg-white text-purple-600 px-6 py-3 rounded-lg hover:bg-gray-100 transition font-semibold"><i class="fas fa-star mr-2"></i>Feedback Survey</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-check-circle mr-2 text-green-600"></i>‚úÖ Completed Forms</h3>
                            <div id="completed-forms" class="space-y-2"><div class="text-sm text-gray-500 italic">No forms completed yet</div></div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-clock mr-2 text-yellow-600"></i>‚è≥ Pending Forms</h3>
                            <div id="pending-forms" class="space-y-2"><div class="text-sm text-gray-500 italic">No pending forms</div></div>
                        </div>
                    </div>
                `;
            }
        }
        
        // ========== PATIENT PROFILE HELPER FUNCTIONS ==========
        
        // Modern Modal Input (replaces browser prompt)
        function showInputModal(title, placeholder, buttonText, callback) {
            // Remove focus from any currently focused element
            if (document.activeElement) document.activeElement.blur();
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.id = 'input-modal';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden transform transition-all">
                    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-6 py-4">
                        <h3 class="text-xl font-bold text-white">${title}</h3>
                    </div>
                    <div class="p-6">
                        <input type="text" id="modal-input-value" placeholder="${placeholder}" 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all outline-none text-gray-700">
                        <div class="flex space-x-3 mt-6">
                            <button id="modal-submit-btn" onclick="submitModalInput()" class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-xl hover:from-purple-700 hover:to-indigo-700 transition-all font-semibold shadow-lg">
                                <i class="fas fa-check mr-2"></i>${buttonText}
                            </button>
                            <button id="modal-cancel-btn" onclick="closeInputModal()" class="flex-1 bg-gray-100 text-gray-700 px-6 py-3 rounded-xl hover:bg-gray-200 transition-all font-semibold">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => {
                const input = document.getElementById('modal-input-value');
                if (input) input.focus();
            }, 50);
            window.modalInputCallback = callback;
            document.getElementById('modal-input-value').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') submitModalInput();
            });
        }
        
        async function submitModalInput() {
            const value = document.getElementById('modal-input-value').value.trim();
            if (!value) {
                closeInputModal();
                return;
            }
            
            // Show loading state
            const btn = document.getElementById('modal-submit-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            btn.disabled = true;
            cancelBtn.disabled = true;
            
            const callback = window.modalInputCallback;
            try {
                if (callback) await callback(value);
            } finally {
                closeInputModal();
            }
        }
        
        function closeInputModal() {
            const modal = document.getElementById('input-modal');
            if (modal) modal.remove();
            window.modalInputCallback = null;
        }
        
        // Helper: Ensure patient exists in Firestore
        async function ensurePatientInFirestore() {
            if (!currentPatient) {
                showToast('‚ùå No patient selected', 'error');
                return null;
            }
            if (currentPatient.firestoreId) return currentPatient.firestoreId;
            
            try {
                // Try to find existing patient by phone or email first
                let existingPatient = null;
                
                if (currentPatient.phone) {
                    const phoneQuery = await db.collection('patients').where('phone', '==', currentPatient.phone).limit(1).get();
                    if (!phoneQuery.empty) existingPatient = phoneQuery.docs[0];
                }
                
                if (!existingPatient && currentPatient.email) {
                    const emailQuery = await db.collection('patients').where('email', '==', currentPatient.email).limit(1).get();
                    if (!emailQuery.empty) existingPatient = emailQuery.docs[0];
                }
                
                if (existingPatient) {
                    currentPatient.firestoreId = existingPatient.id;
                    const data = existingPatient.data();
                    currentPatient.medicalHistory = data.medicalHistory || {};
                    currentPatient.bloodProfile = data.bloodProfile || {};
                    currentPatient.dentalChart = data.dentalChart || {};
                    currentPatient.treatmentPlans = data.treatmentPlans || [];
                    currentPatient.files = data.files || {};
                    
                    const idx = allPatients.findIndex(p => p.id === currentPatient.id);
                    if (idx !== -1) allPatients[idx].firestoreId = existingPatient.id;
                    
                    console.log('‚úÖ Found existing patient in Firestore:', existingPatient.id);
                    return existingPatient.id;
                }
                
                // Create new patient record
                const newPatientRef = await db.collection('patients').add({
                    name: currentPatient.name,
                    email: currentPatient.email,
                    phone: currentPatient.phone,
                    medicalHistory: {},
                    bloodProfile: {},
                    dentalChart: { teeth: {} },
                    treatmentPlans: [],
                    files: { xrays: [], photos: [], documents: [], insurance: [] },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                currentPatient.firestoreId = newPatientRef.id;
                const idx = allPatients.findIndex(p => p.id === currentPatient.id);
                if (idx !== -1) allPatients[idx].firestoreId = newPatientRef.id;
                
                console.log('‚úÖ Created new patient in Firestore:', newPatientRef.id);
                return newPatientRef.id;
            } catch (error) {
                console.error('Error creating patient:', error);
                showToast('‚ùå Error creating patient record', 'error');
                return null;
            }
        }
        
        // Medical History Functions
        function sendMedicalForm(contact) {
            const formId = Math.random().toString(36).substr(2, 9);
            const formLink = `https://clinic-one-zeta.vercel.app/form/?type=medical&id=${formId}&contact=${encodeURIComponent(contact)}`;
            showToast(`üì§ Form link generated: ${formLink}`, 'success');
        }
        
        function addAllergy() {
            showInputModal('‚ö†Ô∏è Add Allergy', 'Enter allergy name (e.g., Penicillin, Peanuts)', 'Add Allergy', async (allergy) => {
                const patientId = await ensurePatientInFirestore();
                if (!patientId) return;
                try {
                    await db.collection('patients').doc(patientId).update({
                        'medicalHistory.allergies': firebase.firestore.FieldValue.arrayUnion(allergy),
                        'medicalHistory.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                    });
                    // Log the change
                    await logPatientChange(patientId, {
                        action: 'Added Allergy',
                        category: 'medical_history',
                        details: allergy,
                        newValue: allergy
                    });
                    // Update local state
                    if (!currentPatient.medicalHistory) currentPatient.medicalHistory = {};
                    if (!currentPatient.medicalHistory.allergies) currentPatient.medicalHistory.allergies = [];
                    currentPatient.medicalHistory.allergies.push(allergy);
                    showPatientTab('medical');
                    showToast(`‚úÖ Added allergy: ${allergy}`, 'success');
                } catch (error) {
                    console.error('Error adding allergy:', error);
                    showToast('‚ùå Error adding allergy', 'error');
                }
            });
        }
        
        async function removeAllergy(allergy) {
            const patientId = currentPatient?.firestoreId;
            if (!patientId) return;
            try {
                await db.collection('patients').doc(patientId).update({
                    'medicalHistory.allergies': firebase.firestore.FieldValue.arrayRemove(allergy)
                });
                // Log the change
                await logPatientChange(patientId, {
                    action: 'Removed Allergy',
                    category: 'medical_history',
                    details: allergy,
                    previousValue: allergy
                });
                currentPatient.medicalHistory.allergies = currentPatient.medicalHistory.allergies.filter(a => a !== allergy);
                showPatientTab('medical');
                showToast(`üóëÔ∏è Removed allergy: ${allergy}`, 'success');
            } catch (error) {
                showToast('‚ùå Error removing allergy', 'error');
            }
        }
        
        function addMedication() {
            showInputModal('üíä Add Medication', 'Enter medication name and dosage (e.g., Metformin 500mg)', 'Add Medication', async (medication) => {
                const patientId = await ensurePatientInFirestore();
                if (!patientId) return;
                try {
                    await db.collection('patients').doc(patientId).update({
                        'medicalHistory.medications': firebase.firestore.FieldValue.arrayUnion(medication),
                        'medicalHistory.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                    });
                    // Log the change
                    await logPatientChange(patientId, {
                        action: 'Added Medication',
                        category: 'medical_history',
                        details: medication,
                        newValue: medication
                    });
                    // Update local state
                    if (!currentPatient.medicalHistory) currentPatient.medicalHistory = {};
                    if (!currentPatient.medicalHistory.medications) currentPatient.medicalHistory.medications = [];
                    currentPatient.medicalHistory.medications.push(medication);
                    showPatientTab('medical');
                    showToast(`‚úÖ Added medication: ${medication}`, 'success');
                } catch (error) {
                    console.error('Error adding medication:', error);
                    showToast('‚ùå Error adding medication', 'error');
                }
            });
        }
        
        async function removeMedication(medication) {
            const patientId = currentPatient?.firestoreId;
            if (!patientId) return;
            try {
                await db.collection('patients').doc(patientId).update({
                    'medicalHistory.medications': firebase.firestore.FieldValue.arrayRemove(medication)
                });
                // Log the change
                await logPatientChange(patientId, {
                    action: 'Removed Medication',
                    category: 'medical_history',
                    details: medication,
                    previousValue: medication
                });
                currentPatient.medicalHistory.medications = currentPatient.medicalHistory.medications.filter(m => m !== medication);
                showPatientTab('medical');
                showToast(`üóëÔ∏è Removed medication: ${medication}`, 'success');
            } catch (error) {
                showToast('‚ùå Error removing medication', 'error');
            }
        }
        
        async function saveMedicalHistory() {
            const btn = document.getElementById('btn-save-medical');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            btn.disabled = true;
            
            const patientId = await ensurePatientInFirestore();
            if (!patientId) {
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }
            try {
                const conditions = [];
                document.querySelectorAll('#medical-conditions-list input[type="checkbox"]:checked').forEach(cb => conditions.push(cb.value));
                const bloodPressure = document.getElementById('vital-blood-pressure')?.value || '';
                const emergencyContact = document.getElementById('vital-emergency-contact')?.value || '';
                const dentalConcerns = [];
                document.querySelectorAll('#dental-concerns-list input[type="checkbox"]:checked').forEach(cb => dentalConcerns.push(cb.value));
                
                await db.collection('patients').doc(patientId).update({
                    'medicalHistory.conditions': conditions,
                    'medicalHistory.bloodPressure': bloodPressure,
                    'medicalHistory.emergencyContact': emergencyContact,
                    'medicalHistory.dentalConcerns': dentalConcerns,
                    'medicalHistory.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Log the change
                await logPatientChange(patientId, {
                    action: 'Updated Medical History',
                    category: 'medical_history',
                    details: `Conditions: ${conditions.length}, BP: ${bloodPressure || 'N/A'}, Emergency: ${emergencyContact || 'N/A'}`
                });
                
                // Update local currentPatient object so tab switching reflects changes immediately
                if (!currentPatient.medicalHistory) currentPatient.medicalHistory = {};
                currentPatient.medicalHistory.conditions = conditions;
                currentPatient.medicalHistory.bloodPressure = bloodPressure;
                currentPatient.medicalHistory.emergencyContact = emergencyContact;
                currentPatient.medicalHistory.dentalConcerns = dentalConcerns;
                
                showToast('üíæ Medical history saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving medical history:', error);
                showToast('‚ùå Error saving medical history', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        // Dental Chart Functions
        let selectedToothNumber = null;
        
        function selectTooth(toothNumber) {
            selectedToothNumber = toothNumber;
            document.getElementById('selected-tooth-number').textContent = toothNumber;
            document.getElementById('tooth-details').classList.remove('hidden');
            const toothData = currentPatient?.dentalChart?.teeth?.[toothNumber];
            if (toothData) {
                document.getElementById('tooth-condition').value = toothData.condition || '';
                document.getElementById('tooth-notes').value = toothData.notes || '';
            } else {
                document.getElementById('tooth-condition').value = '';
                document.getElementById('tooth-notes').value = '';
            }
        }
        
        async function saveToothData() {
            const condition = document.getElementById('tooth-condition').value;
            const notes = document.getElementById('tooth-notes').value;
            
            // Show loading
            const btn = document.getElementById('btn-save-tooth');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            btn.disabled = true;
            
            const patientId = await ensurePatientInFirestore();
            if (!patientId) {
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }
            try {
                const previousCondition = currentPatient?.dentalChart?.teeth?.[selectedToothNumber]?.condition;
                await db.collection('patients').doc(patientId).update({
                    [`dentalChart.teeth.${selectedToothNumber}`]: { condition, notes, updatedAt: new Date().toISOString() },
                    'dentalChart.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
                // Log the change
                await logPatientChange(patientId, {
                    action: 'Updated Dental Chart',
                    category: 'dental_chart',
                    details: `Tooth #${selectedToothNumber}: ${condition || 'No condition'}${notes ? ' - ' + notes : ''}`,
                    previousValue: previousCondition,
                    newValue: condition
                });
                if (!currentPatient.dentalChart) currentPatient.dentalChart = { teeth: {} };
                if (!currentPatient.dentalChart.teeth) currentPatient.dentalChart.teeth = {};
                currentPatient.dentalChart.teeth[selectedToothNumber] = { condition, notes };
                showToast(`‚úÖ Saved data for tooth #${selectedToothNumber}`, 'success');
                // Refresh dental chart to show updated colors
                showPatientTab('dental');
            } catch (error) {
                console.error('Error saving tooth data:', error);
                showToast('‚ùå Error saving tooth data', 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        function closeToothDetails() {
            document.getElementById('tooth-details').classList.add('hidden');
            document.getElementById('tooth-condition').value = '';
            document.getElementById('tooth-notes').value = '';
            selectedToothNumber = null;
        }
        
        // File Upload Functions (Placeholder)
        function uploadFile(fileType) {
            showToast(`üìÅ File upload requires Firebase Storage (Pro feature). File type: ${fileType}`, 'info');
        }
        
        // Treatment Plan Functions
        function createTreatmentPlan() {
            showInputModal('üìã Create Treatment Plan', 'Enter treatment plan title (e.g., Root Canal Treatment)', 'Create Plan', async (title) => {
                const patientId = await ensurePatientInFirestore();
                if (!patientId) return;
                try {
                    const newPlan = { id: `plan-${Date.now()}`, title, status: 'active', createdAt: new Date().toISOString(), procedures: [] };
                    await db.collection('patients').doc(patientId).update({
                        treatmentPlans: firebase.firestore.FieldValue.arrayUnion(newPlan)
                    });
                    // Log the change
                    await logPatientChange(patientId, {
                        action: 'Created Treatment Plan',
                        category: 'treatment_plan',
                        details: title,
                        newValue: title
                    });
                    if (!currentPatient.treatmentPlans) currentPatient.treatmentPlans = [];
                    currentPatient.treatmentPlans.push(newPlan);
                    showPatientTab('treatment');
                    showToast(`‚úÖ Created treatment plan: ${title}`, 'success');
                } catch (error) {
                    showToast('‚ùå Error creating treatment plan', 'error');
                }
            });
        }
        
        function addProcedure(planId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.id = 'procedure-modal';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">‚ûï Add Procedure</h3>
                        <button onclick="closeProcedureModal()" class="text-gray-400 hover:text-gray-600 text-2xl"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Procedure Name</label>
                            <input type="text" id="proc-name" placeholder="e.g., X-Ray, Cleaning, Extraction" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Scheduled Date (Optional)</label>
                            <input type="date" id="proc-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Notes (Optional)</label>
                            <input type="text" id="proc-notes" placeholder="Additional notes..." class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Initial Status</label>
                            <select id="proc-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="pending">Pending</option>
                                <option value="scheduled">Scheduled</option>
                                <option value="in-progress">In Progress</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex space-x-2 mt-6">
                        <button id="proc-save-btn" onclick="saveProcedure('${planId}')" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-semibold"><i class="fas fa-save mr-2"></i>Add Procedure</button>
                        <button onclick="closeProcedureModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition font-semibold">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeProcedureModal() {
            const modal = document.getElementById('procedure-modal');
            if (modal) modal.remove();
        }
        
        async function saveProcedure(planId) {
            const name = document.getElementById('proc-name').value.trim();
            if (!name) { showToast('‚ùå Please enter procedure name', 'error'); return; }
            
            const date = document.getElementById('proc-date').value;
            const notes = document.getElementById('proc-notes').value.trim();
            const status = document.getElementById('proc-status').value;
            
            // Show loading
            const btn = document.getElementById('proc-save-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            btn.disabled = true;
            
            const patientId = await ensurePatientInFirestore();
            if (!patientId) { closeProcedureModal(); return; }
            
            try {
                const newProcedure = { id: `proc-${Date.now()}`, name, date, notes, status, createdAt: new Date().toISOString() };
                
                // Find and update the plan
                const planIndex = currentPatient.treatmentPlans.findIndex(p => p.id === planId);
                if (planIndex === -1) throw new Error('Plan not found');
                
                if (!currentPatient.treatmentPlans[planIndex].procedures) {
                    currentPatient.treatmentPlans[planIndex].procedures = [];
                }
                currentPatient.treatmentPlans[planIndex].procedures.push(newProcedure);
                
                // Save to Firestore
                await db.collection('patients').doc(patientId).update({
                    treatmentPlans: currentPatient.treatmentPlans,
                    'treatmentPlans.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
                // Log the change
                const planTitle = currentPatient.treatmentPlans[planIndex].title;
                await logPatientChange(patientId, {
                    action: 'Added Procedure',
                    category: 'treatment_plan',
                    details: `${name} to "${planTitle}"`,
                    newValue: name
                });
                
                closeProcedureModal();
                showPatientTab('treatment');
                showToast(`‚úÖ Added procedure: ${name}`, 'success');
            } catch (error) {
                console.error('Error adding procedure:', error);
                showToast('‚ùå Error adding procedure', 'error');
                closeProcedureModal();
            }
        }
        
        async function updateProcedureStatus(planId, procId, newStatus) {
            const patientId = await ensurePatientInFirestore();
            if (!patientId) return;
            
            try {
                const planIndex = currentPatient.treatmentPlans.findIndex(p => p.id === planId);
                if (planIndex === -1) return;
                
                const procIndex = currentPatient.treatmentPlans[planIndex].procedures.findIndex(p => p.id === procId);
                if (procIndex === -1) return;
                
                const procName = currentPatient.treatmentPlans[planIndex].procedures[procIndex].name;
                const oldStatus = currentPatient.treatmentPlans[planIndex].procedures[procIndex].status;
                
                currentPatient.treatmentPlans[planIndex].procedures[procIndex].status = newStatus;
                currentPatient.treatmentPlans[planIndex].procedures[procIndex].updatedAt = new Date().toISOString();
                
                await db.collection('patients').doc(patientId).update({
                    treatmentPlans: currentPatient.treatmentPlans
                });
                // Log the change
                await logPatientChange(patientId, {
                    action: 'Updated Procedure Status',
                    category: 'treatment_plan',
                    details: `${procName}: ${oldStatus} ‚Üí ${newStatus}`,
                    previousValue: oldStatus,
                    newValue: newStatus
                });
                
                showPatientTab('treatment');
                showToast(`‚úÖ Status updated to: ${newStatus}`, 'success');
            } catch (error) {
                console.error('Error updating procedure status:', error);
                showToast('‚ùå Error updating status', 'error');
            }
        }
        
        function deleteProcedure(planId, procId) {
            showConfirmModal('Delete Procedure', 'Are you sure you want to delete this procedure?', async () => {
                const patientId = await ensurePatientInFirestore();
                if (!patientId) return;
                
                try {
                    const planIndex = currentPatient.treatmentPlans.findIndex(p => p.id === planId);
                    if (planIndex === -1) return;
                    
                    const proc = currentPatient.treatmentPlans[planIndex].procedures.find(p => p.id === procId);
                    const procName = proc?.name || 'Unknown';
                    const planTitle = currentPatient.treatmentPlans[planIndex].title;
                    
                    currentPatient.treatmentPlans[planIndex].procedures = currentPatient.treatmentPlans[planIndex].procedures.filter(p => p.id !== procId);
                    
                    await db.collection('patients').doc(patientId).update({
                        treatmentPlans: currentPatient.treatmentPlans
                    });
                    // Log the change
                    await logPatientChange(patientId, {
                        action: 'Deleted Procedure',
                        category: 'treatment_plan',
                        details: `${procName} from "${planTitle}"`,
                        previousValue: procName
                    });
                    
                    showPatientTab('treatment');
                    showToast('üóëÔ∏è Procedure deleted', 'success');
                } catch (error) {
                    console.error('Error deleting procedure:', error);
                    showToast('‚ùå Error deleting procedure', 'error');
                }
            }, 'Delete', 'red');
        }
        
        function completePlan(planId) {
            showConfirmModal('Complete Plan', 'Mark this treatment plan as completed?', async () => {
                const patientId = await ensurePatientInFirestore();
                if (!patientId) return;
                
                try {
                    const planIndex = currentPatient.treatmentPlans.findIndex(p => p.id === planId);
                    if (planIndex === -1) return;
                    
                    const planTitle = currentPatient.treatmentPlans[planIndex].title;
                    currentPatient.treatmentPlans[planIndex].status = 'completed';
                    currentPatient.treatmentPlans[planIndex].completedAt = new Date().toISOString();
                    
                    await db.collection('patients').doc(patientId).update({
                        treatmentPlans: currentPatient.treatmentPlans
                    });
                    // Log the change
                    await logPatientChange(patientId, {
                        action: 'Completed Treatment Plan',
                        category: 'treatment_plan',
                        details: planTitle,
                        previousValue: 'active',
                        newValue: 'completed'
                    });
                    
                    showPatientTab('treatment');
                    showToast('‚úÖ Treatment plan completed!', 'success');
                } catch (error) {
                    console.error('Error completing plan:', error);
                    showToast('‚ùå Error completing plan', 'error');
                }
            }, 'Complete', 'green');
        }
        
        function reopenPlan(planId) {
            showConfirmModal('Reopen Plan', 'Reopen this treatment plan?', async () => {
                const patientId = await ensurePatientInFirestore();
                if (!patientId) return;
                
                try {
                    const planIndex = currentPatient.treatmentPlans.findIndex(p => p.id === planId);
                    if (planIndex === -1) return;
                    
                    const planTitle = currentPatient.treatmentPlans[planIndex].title;
                    currentPatient.treatmentPlans[planIndex].status = 'active';
                    delete currentPatient.treatmentPlans[planIndex].completedAt;
                    
                    await db.collection('patients').doc(patientId).update({
                        treatmentPlans: currentPatient.treatmentPlans
                    });
                    // Log the change
                    await logPatientChange(patientId, {
                        action: 'Reopened Treatment Plan',
                        category: 'treatment_plan',
                        details: planTitle,
                        previousValue: 'completed',
                        newValue: 'active'
                    });
                    
                    showPatientTab('treatment');
                    showToast('üîÑ Treatment plan reopened', 'success');
                } catch (error) {
                    console.error('Error reopening plan:', error);
                    showToast('‚ùå Error reopening plan', 'error');
                }
            }, 'Reopen', 'yellow');
        }
        
        function deletePlan(planId) {
            showConfirmModal('Delete Treatment Plan', 'Delete this entire treatment plan? This cannot be undone.', async () => {
                const patientId = await ensurePatientInFirestore();
                if (!patientId) return;
                
                try {
                    const plan = currentPatient.treatmentPlans.find(p => p.id === planId);
                    const planTitle = plan?.title || 'Unknown';
                    
                    currentPatient.treatmentPlans = currentPatient.treatmentPlans.filter(p => p.id !== planId);
                    
                    await db.collection('patients').doc(patientId).update({
                        treatmentPlans: currentPatient.treatmentPlans
                    });
                    // Log the change
                    await logPatientChange(patientId, {
                        action: 'Deleted Treatment Plan',
                        category: 'treatment_plan',
                        details: planTitle,
                        previousValue: planTitle
                    });
                    
                    showPatientTab('treatment');
                    showToast('üóëÔ∏è Treatment plan deleted', 'success');
                } catch (error) {
                    console.error('Error deleting plan:', error);
                    showToast('‚ùå Error deleting plan', 'error');
                }
            }, 'Delete', 'red');
        }
        
        // Form Link Functions
        function sendFormLink(formType, patientId, contact, patientName) {
            const formId = Math.random().toString(36).substr(2, 9);
            const formLink = `https://clinic-one-zeta.vercel.app/form/?type=${formType}&id=${formId}&patientId=${patientId}&contact=${encodeURIComponent(contact)}&name=${encodeURIComponent(patientName)}`;
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">üì§ Send ${formType.charAt(0).toUpperCase() + formType.slice(1)} Form</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-2xl"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Form Link</label>
                        <div class="flex space-x-2">
                            <input type="text" value="${formLink}" readonly class="flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm">
                            <button onclick="navigator.clipboard.writeText('${formLink}'); showToast('üìã Link copied!', 'success')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                    <button onclick="this.closest('.fixed').remove()" class="w-full mt-3 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition font-semibold">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Blood Profile Functions
        function addDonationRecord() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.id = 'blood-modal';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">ü©∏ Add Donation Record</h3>
                        <button onclick="closeBloodModal()" class="text-gray-400 hover:text-gray-600 text-2xl"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="space-y-3">
                        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Donation Date</label><input type="date" id="donation-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Location</label><input type="text" id="donation-location" placeholder="e.g., Red Cross" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Volume (ml)</label><input type="number" id="donation-volume" value="450" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></div>
                    </div>
                    <div class="flex space-x-2 mt-6">
                        <button id="blood-modal-save" onclick="saveDonationRecord()" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition font-semibold"><i class="fas fa-save mr-2"></i>Save</button>
                        <button onclick="closeBloodModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition font-semibold">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function saveDonationRecord() {
            const date = document.getElementById('donation-date').value;
            const location = document.getElementById('donation-location').value;
            const volume = document.getElementById('donation-volume').value;
            if (!date) { showToast('‚ùå Please enter donation date', 'error'); return; }
            
            // Show loading
            const btn = document.getElementById('blood-modal-save');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            btn.disabled = true;
            
            const patientId = await ensurePatientInFirestore();
            if (!patientId) { closeBloodModal(); return; }
            try {
                const donation = { id: `donation-${Date.now()}`, date, location, volume: parseInt(volume) || 450, createdAt: new Date().toISOString() };
                await db.collection('patients').doc(patientId).update({
                    'bloodProfile.donations': firebase.firestore.FieldValue.arrayUnion(donation),
                    'bloodProfile.lastDonation': date,
                    'bloodProfile.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
                // Log the change
                await logPatientChange(patientId, {
                    action: 'Added Blood Donation',
                    category: 'blood_profile',
                    details: `${date} at ${location} (${volume}ml)`,
                    newValue: `${date} - ${location}`
                });
                if (!currentPatient.bloodProfile) currentPatient.bloodProfile = {};
                if (!currentPatient.bloodProfile.donations) currentPatient.bloodProfile.donations = [];
                currentPatient.bloodProfile.donations.push(donation);
                closeBloodModal();
                showPatientTab('blood');
                showToast('ü©∏ Donation record saved!', 'success');
            } catch (error) {
                console.error('Error saving donation:', error);
                showToast('‚ùå Error saving donation record', 'error');
                closeBloodModal();
            }
        }
        
        function addBPReading() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.id = 'blood-modal';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">üìà Add Blood Pressure</h3>
                        <button onclick="closeBloodModal()" class="text-gray-400 hover:text-gray-600 text-2xl"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="block text-sm font-semibold text-gray-700 mb-2">Systolic</label><input type="number" id="bp-systolic" placeholder="120" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></div>
                            <div><label class="block text-sm font-semibold text-gray-700 mb-2">Diastolic</label><input type="number" id="bp-diastolic" placeholder="80" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></div>
                        </div>
                    </div>
                    <div class="flex space-x-2 mt-6">
                        <button id="blood-modal-save" onclick="saveBPReading()" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition font-semibold"><i class="fas fa-save mr-2"></i>Save</button>
                        <button onclick="closeBloodModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition font-semibold">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function saveBPReading() {
            const systolic = document.getElementById('bp-systolic').value;
            const diastolic = document.getElementById('bp-diastolic').value;
            if (!systolic || !diastolic) { showToast('‚ùå Please enter both values', 'error'); return; }
            
            // Show loading
            const btn = document.getElementById('blood-modal-save');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            btn.disabled = true;
            
            const patientId = await ensurePatientInFirestore();
            if (!patientId) { closeBloodModal(); return; }
            try {
                const reading = { id: `bp-${Date.now()}`, datetime: new Date().toISOString(), systolic: parseInt(systolic), diastolic: parseInt(diastolic) };
                await db.collection('patients').doc(patientId).update({
                    'bloodProfile.bpReadings': firebase.firestore.FieldValue.arrayUnion(reading),
                    'bloodProfile.latestBP': `${systolic}/${diastolic}`,
                    'bloodProfile.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
                // Log the change
                await logPatientChange(patientId, {
                    action: 'Added Blood Pressure Reading',
                    category: 'blood_profile',
                    details: `${systolic}/${diastolic} mmHg`,
                    newValue: `${systolic}/${diastolic}`
                });
                if (!currentPatient.bloodProfile) currentPatient.bloodProfile = {};
                if (!currentPatient.bloodProfile.bpReadings) currentPatient.bloodProfile.bpReadings = [];
                currentPatient.bloodProfile.bpReadings.push(reading);
                closeBloodModal();
                showPatientTab('blood');
                showToast(`üìà Blood pressure ${systolic}/${diastolic} saved!`, 'success');
            } catch (error) {
                console.error('Error saving BP:', error);
                showToast('‚ùå Error saving blood pressure', 'error');
                closeBloodModal();
            }
        }
        
        function addBloodSugar() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.id = 'blood-modal';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">üç¨ Add Blood Sugar</h3>
                        <button onclick="closeBloodModal()" class="text-gray-400 hover:text-gray-600 text-2xl"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="space-y-3">
                        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Reading Type</label>
                            <select id="sugar-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="Fasting">Fasting</option>
                                <option value="Before Meal">Before Meal</option>
                                <option value="After Meal">After Meal (2hrs)</option>
                                <option value="Random">Random</option>
                            </select>
                        </div>
                        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Value (mg/dL)</label><input type="number" id="sugar-value" placeholder="100" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></div>
                    </div>
                    <div class="flex space-x-2 mt-6">
                        <button id="blood-modal-save" onclick="saveBloodSugar()" class="flex-1 bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700 transition font-semibold"><i class="fas fa-save mr-2"></i>Save</button>
                        <button onclick="closeBloodModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition font-semibold">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function saveBloodSugar() {
            const type = document.getElementById('sugar-type').value;
            const value = document.getElementById('sugar-value').value;
            if (!value) { showToast('‚ùå Please enter blood sugar value', 'error'); return; }
            
            // Show loading
            const btn = document.getElementById('blood-modal-save');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            btn.disabled = true;
            
            const patientId = await ensurePatientInFirestore();
            if (!patientId) { closeBloodModal(); return; }
            try {
                const reading = { id: `sugar-${Date.now()}`, datetime: new Date().toISOString(), type, value: parseInt(value) };
                await db.collection('patients').doc(patientId).update({
                    'bloodProfile.sugarReadings': firebase.firestore.FieldValue.arrayUnion(reading),
                    'bloodProfile.latestSugar': parseInt(value),
                    'bloodProfile.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
                // Log the change
                await logPatientChange(patientId, {
                    action: 'Added Blood Sugar Reading',
                    category: 'blood_profile',
                    details: `${value} mg/dL (${type})`,
                    newValue: `${value} mg/dL`
                });
                if (!currentPatient.bloodProfile) currentPatient.bloodProfile = {};
                if (!currentPatient.bloodProfile.sugarReadings) currentPatient.bloodProfile.sugarReadings = [];
                currentPatient.bloodProfile.sugarReadings.push(reading);
                closeBloodModal();
                showPatientTab('blood');
                showToast(`üç¨ Blood sugar ${value} mg/dL saved!`, 'success');
            } catch (error) {
                console.error('Error saving blood sugar:', error);
                showToast('‚ùå Error saving blood sugar', 'error');
                closeBloodModal();
            }
        }
        
        function closeBloodModal() {
            const modal = document.getElementById('blood-modal');
            if (modal) modal.remove();
        }
        
        async function saveBloodProfile() {
            const btn = document.getElementById('btn-save-blood');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            btn.disabled = true;
            
            const patientId = await ensurePatientInFirestore();
            if (!patientId) {
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }
            try {
                const bloodType = document.getElementById('blood-type')?.value || '';
                const rhFactor = document.getElementById('rh-factor')?.value || '';
                const verified = document.getElementById('blood-verified')?.checked || false;
                await db.collection('patients').doc(patientId).update({
                    'bloodProfile.bloodType': bloodType,
                    'bloodProfile.rhFactor': rhFactor,
                    'bloodProfile.verified': verified,
                    'bloodProfile.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
                // Log the change
                await logPatientChange(patientId, {
                    action: 'Updated Blood Profile',
                    category: 'blood_profile',
                    details: `Blood Type: ${bloodType}${rhFactor}, Verified: ${verified ? 'Yes' : 'No'}`,
                    newValue: `${bloodType}${rhFactor}`
                });
                
                // Update local currentPatient object
                if (!currentPatient.bloodProfile) currentPatient.bloodProfile = {};
                currentPatient.bloodProfile.bloodType = bloodType;
                currentPatient.bloodProfile.rhFactor = rhFactor;
                currentPatient.bloodProfile.verified = verified;
                
                showToast('üíæ Blood profile saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving blood profile:', error);
                showToast('‚ùå Error saving blood profile', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        // Check on page load - MUST BE AT THE END after all functions are defined
        checkAuth();
    </script>
</body>
</html>
