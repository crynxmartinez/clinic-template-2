<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - MyMedPH</title>
    
    <!-- Clinic Configuration -->
    <script src="config.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0066cc',
                        secondary: '#00cc66',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast { animation: slideIn 0.3s ease-out; }
        .sidebar { transition: transform 0.3s ease-out; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
        }
        
        /* Flatpickr Custom Styles */
        .flatpickr-calendar {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            border: none;
        }
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange {
            background: #0066cc !important;
            border-color: #0066cc !important;
        }
        .flatpickr-day.inRange {
            background: rgba(0, 102, 204, 0.1);
            border-color: rgba(0, 102, 204, 0.2);
        }
        .flatpickr-day:hover {
            background: rgba(0, 102, 204, 0.2);
        }
        .flatpickr-months .flatpickr-month {
            background: #0066cc;
            color: white;
        }
        .flatpickr-current-month .flatpickr-monthDropdown-months {
            background: #0066cc;
        }
        .flatpickr-weekdays {
            background: #f3f4f6;
        }
        .nav-btn.active { background-color: rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="bg-gray-100">
    <div class="bg-white shadow-md sticky top-0 z-40">
        <div class="flex items-center justify-between px-6 py-4">
            <div class="flex items-center space-x-4">
                <button onclick="toggleSidebar()" class="md:hidden text-gray-700 text-2xl"><i class="fas fa-bars"></i></button>
                <div class="flex items-center space-x-3">
                    <i class="fas fa-heartbeat text-primary text-2xl"></i>
                    <div>
                        <h1 id="clinic-header-name" class="text-xl font-bold text-gray-800">Loading...</h1>
                        <p class="text-xs text-gray-600">Admin Portal</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-gray-700 font-semibold hidden md:inline" id="user-name">Administrator</span>
                
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">
                    <i class="fas fa-sign-out-alt mr-2"></i><span class="hidden md:inline">Logout</span>
                </button>
            </div>        </div>
    </div>
    
    <div class="flex">
        <div id="sidebar" class="sidebar fixed md:static inset-y-0 left-0 z-50 w-64 bg-gray-800 text-white md:block h-screen overflow-y-auto">
            <nav class="p-4 space-y-2 mt-16 md:mt-4">
                <button onclick="showSection('dashboard')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition active">
                    <i class="fas fa-chart-line mr-3"></i><span>Dashboard</span>
                </button>
                <button onclick="showSection('doctors')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-user-md mr-3"></i><span>Doctors</span>
                </button>
                <button onclick="showSection('staff')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-users mr-3"></i><span>Staff</span>
                </button>
                <button onclick="showSection('globalservices')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-briefcase-medical mr-3"></i><span>Global Services</span>
                </button>
                <button onclick="showSection('appointments')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-calendar-check mr-3"></i><span>Appointments</span>
                </button>
                <button onclick="showSection('calendar')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-calendar mr-3"></i><span>Calendar View</span>
                </button>
                <button onclick="showSection('analytics')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-chart-bar mr-3"></i><span>Analytics</span>
                </button>
            </nav>
        </div>
        
        <div class="flex-1 p-6 overflow-y-auto">
            <!-- Dashboard -->
            <div id="section-dashboard" class="section">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h2>
                
                <div class="grid md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Total Doctors</p>
                                <p id="stat-doctors" class="text-3xl font-bold text-primary">0</p>
                            </div>
                            <i class="fas fa-user-md text-primary text-4xl opacity-20"></i>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Total Staff</p>
                                <p id="stat-staff" class="text-3xl font-bold text-green-600">0</p>
                            </div>
                            <i class="fas fa-users text-green-600 text-4xl opacity-20"></i>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Total Appointments</p>
                                <p id="stat-appointments" class="text-3xl font-bold text-blue-600">0</p>
                            </div>
                            <i class="fas fa-calendar-check text-blue-600 text-4xl opacity-20"></i>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Today's Appointments</p>
                                <p id="stat-today" class="text-3xl font-bold text-purple-600">0</p>
                            </div>
                            <i class="fas fa-clock text-purple-600 text-4xl opacity-20"></i>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Recent Appointments</h3>
                    <div id="recent-appointments" class="space-y-2"></div>
                </div>
            </div>
            
            <!-- Doctors Section -->
            <div id="section-doctors" class="section hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Manage Doctors</h2>
                    <div class="flex space-x-3">
                        <button onclick="showAddDoctorModal()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
                            <i class="fas fa-plus mr-2"></i><span>Create New Doctor</span>
                        </button>
                        <button onclick="showAddExistingDoctorModal()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
                            <i class="fas fa-user-plus mr-2"></i><span>Add Existing Doctor</span>
                        </button>
                    </div>
                </div>
                
                <!-- Search Bar -->
                <div class="mb-6">
                    <div class="relative">
                        <input type="text" id="doctor-search" placeholder="Search doctors by name, email, or specialty..." 
                            class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                            oninput="filterDoctors()">
                        <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                
                <div id="doctors-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
            
            <!-- Staff Section -->
            <div id="section-staff" class="section hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Manage Staff</h2>
                    <button onclick="showAddStaffModal()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-plus mr-2"></i><span>Add Staff</span>
                    </button>
                </div>
                
                <!-- Search Bar -->
                <div class="mb-6">
                    <div class="relative">
                        <input type="text" id="staff-search" placeholder="Search staff by name, email, or position..." 
                            class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                            oninput="filterStaff()">
                        <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                
                <div id="staff-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
            
            <!-- Global Services Section -->
            <div id="section-globalservices" class="section hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Global Services</h2>
                    <button onclick="showAddGlobalServiceModal()" class="bg-gradient-to-r from-primary to-blue-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition">
                        <i class="fas fa-plus mr-2"></i><span>Add Global Service</span>
                    </button>
                </div>
                <div class="bg-blue-50 border-l-4 border-primary p-4 mb-6 rounded-lg">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-primary text-xl mr-3 mt-1"></i>
                        <div>
                            <h4 class="font-bold text-gray-800 mb-1">About Global Services</h4>
                            <p class="text-sm text-gray-700">
                                Global services are clinic-wide service templates that all doctors can use. Doctors can add these services to their profile and customize pricing or duration as needed.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Search Bar -->
                <div class="mb-6">
                    <div class="relative">
                        <input type="text" id="globalservice-search" placeholder="Search services by name or description..." 
                            class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                            oninput="filterGlobalServices()">
                        <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                
                <div id="global-services-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
            
            <!-- Analytics Section -->
            <div id="section-analytics" class="section hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Analytics & Reports</h2>
                
                <!-- Date Range Selector -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="grid md:grid-cols-12 gap-4 items-end">
                        <!-- Date Range Picker -->
                        <div class="md:col-span-6">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm">
                                <i class="fas fa-calendar-alt text-primary mr-2"></i><span>Select Date Range</span>
                            </label>
                            <input type="text" id="analytics-date-range" data-placeholder="Click to select date range" placeholder="Click to select date range" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition cursor-pointer" readonly>
                        </div>
                        
                        <!-- Quick Range Buttons -->
                        <div class="md:col-span-4 flex space-x-2">
                            <button onclick="setQuickRange('week')" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2.5 rounded-lg hover:from-blue-600 hover:to-blue-700 transition font-semibold text-sm shadow-md">
                                <i class="fas fa-calendar-week mr-2"></i><span>Last 7 Days</span>
                            </button>
                            <button onclick="setQuickRange('month')" class="flex-1 bg-gradient-to-r from-purple-500 to-purple-600 text-white px-4 py-2.5 rounded-lg hover:from-purple-600 hover:to-purple-700 transition font-semibold text-sm shadow-md">
                                <i class="fas fa-calendar-alt mr-2"></i><span>Last 30 Days</span>
                            </button>
                        </div>
                        
                        <!-- Export Button -->
                        <div class="md:col-span-2">
                            <button onclick="exportAnalyticsToCSV()" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2.5 rounded-lg hover:from-green-600 hover:to-green-700 transition font-semibold shadow-md">
                                <i class="fas fa-download mr-2"></i><span>Export</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Overview Cards -->
                <div class="grid md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">Total Appointments</p>
                                <p id="analytics-total" class="text-4xl font-bold mt-2">0</p>
                            </div>
                            <i class="fas fa-calendar-check text-blue-200 text-4xl opacity-50"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm font-medium">Completed</p>
                                <p id="analytics-completed" class="text-4xl font-bold mt-2">0</p>
                                <p id="analytics-completed-rate" class="text-green-100 text-xs mt-1">0%</p>
                            </div>
                            <i class="fas fa-check-circle text-green-200 text-4xl opacity-50"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-100 text-sm font-medium">Missed</p>
                                <p id="analytics-missed" class="text-4xl font-bold mt-2">0</p>
                                <p id="analytics-missed-rate" class="text-orange-100 text-xs mt-1">0%</p>
                            </div>
                            <i class="fas fa-times-circle text-orange-200 text-4xl opacity-50"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm font-medium">Avg per Day</p>
                                <p id="analytics-avg-day" class="text-4xl font-bold mt-2">0</p>
                            </div>
                            <i class="fas fa-chart-line text-purple-200 text-4xl opacity-50"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Status Breakdown -->
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-chart-pie text-primary mr-2"></i>Status Breakdown
                        </h3>
                        <div class="space-y-3" id="status-breakdown"></div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-user-md text-primary mr-2"></i>Doctor Performance
                        </h3>
                        <div class="space-y-3" id="doctor-performance"></div>
                    </div>
                </div>
                
                <!-- Detailed Report Table -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-table text-primary mr-2"></i><span id="report-title">Weekly Report</span>
                        </h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Booked</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Approve</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Appointment</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Missed</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cancelled</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Completed</th>
                                </tr>
                            </thead>
                            <tbody id="analytics-report-table" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Appointments Section -->
            <div id="section-appointments" class="section hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">All Appointments</h2>
                
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="grid md:grid-cols-12 gap-4 items-end">
                        <div class="md:col-span-3">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm">Status</label>
                            <select id="filter-status" onchange="filterAppointments()" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition">
                                <option value="">All Status</option>
                                <option value="booked">Booked</option>
                                <option value="approve">Approve</option>
                                <option value="appointment">Appointment</option>
                                <option value="missed">Missed</option>
                                <option value="cancelled">Cancelled</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div class="md:col-span-4">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm">
                                <i class="fas fa-calendar-alt text-primary mr-2"></i>Date Range
                            </label>
                            <input type="text" id="filter-date-range" placeholder="Select date range (optional)" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition cursor-pointer" readonly>
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm">Doctor</label>
                            <select id="filter-doctor" onchange="filterAppointments()" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition">
                                <option value="">All Doctors</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <button onclick="clearFilters()" class="w-full bg-gradient-to-r from-gray-500 to-gray-600 text-white px-4 py-2.5 rounded-lg hover:from-gray-600 hover:to-gray-700 transition font-semibold shadow-md">
                                <i class="fas fa-times mr-2"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Patient</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Doctor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date & Time</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="appointments-table" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Calendar View Section -->
            <div id="section-calendar" class="section hidden">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-calendar text-primary mr-3"></i>
                        Calendar View
                    </h2>
                    <div class="relative">
                        <i class="fas fa-user-md absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 z-10"></i>
                        <select id="calendar-doctor-filter" onchange="loadCalendar()" class="pl-10 pr-4 py-2.5 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary bg-white font-semibold text-gray-700 hover:border-primary transition w-full md:w-56">
                            <option value="">All Doctors</option>
                        </select>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <!-- Calendar Navigation -->
                    <div class="flex items-center justify-between mb-6">
                        <button onclick="previousMonth()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition font-semibold text-gray-700">
                            <i class="fas fa-chevron-left mr-2"></i>Previous
                        </button>
                        <div class="text-center">
                            <h3 class="text-2xl font-bold text-gray-800" id="calendar-month-year"></h3>
                            <button onclick="goToToday()" class="text-sm text-primary hover:underline mt-1">
                                <i class="fas fa-calendar-day mr-1"></i>Today
                            </button>
                        </div>
                        <button onclick="nextMonth()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition font-semibold text-gray-700">
                            Next<i class="fas fa-chevron-right ml-2"></i>
                        </button>
                    </div>
                    
                    <!-- Calendar Grid -->
                    <div class="grid grid-cols-7 gap-2">
                        <!-- Day Headers -->
                        <div class="text-center font-bold text-gray-600 py-2">Sun</div>
                        <div class="text-center font-bold text-gray-600 py-2">Mon</div>
                        <div class="text-center font-bold text-gray-600 py-2">Tue</div>
                        <div class="text-center font-bold text-gray-600 py-2">Wed</div>
                        <div class="text-center font-bold text-gray-600 py-2">Thu</div>
                        <div class="text-center font-bold text-gray-600 py-2">Fri</div>
                        <div class="text-center font-bold text-gray-600 py-2">Sat</div>
                    </div>
                    
                    <!-- Calendar Days -->
                    <div id="calendar-grid" class="grid grid-cols-7 gap-2 mt-2"></div>
                </div>
                
                <!-- Selected Day Appointments -->
                <div id="day-appointments" class="mt-6 hidden">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-800" id="selected-day-title"></h3>
                            <button onclick="closeDayView()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div id="day-appointments-list" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="modal-container"></div>
    <div id="toast-container" class="fixed top-4 right-4 z-50"></div>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCjJLE_Mgrv3HONhkkgApmUNVlGdnAIcvI",
            authDomain: "clinic-a17bc.firebaseapp.com",
            projectId: "clinic-a17bc",
            storageBucket: "clinic-a17bc.firebasestorage.app",
            messagingSenderId: "5214960983",
            appId: "1:5214960983:web:4da52f47c510a50b3cd212",
            measurementId: "G-7YM2Z0BY98"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Current user
        let currentUser = null;
        
        // Set clinic name in header
        document.getElementById('clinic-header-name').textContent = CLINIC_NAME;
        
        // Check if user is logged in
        async function checkAuth() {
            const currentUserStr = localStorage.getItem('currentUser');
            
            if (!currentUserStr) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const userData = JSON.parse(currentUserStr);
                
                // CHECK: User belongs to THIS clinic
                if (userData.clinicId !== CLINIC_ID) {
                    alert(`Access denied. You do not have access to ${CLINIC_NAME}`);
                    localStorage.removeItem('currentUser');
                    window.location.href = 'login.html';
                    return;
                }
                
                // CHECK: User is admin
                if (userData.role !== 'admin') {
                    alert('Access denied. Admin access required.');
                    localStorage.removeItem('currentUser');
                    window.location.href = 'login.html';
                    return;
                }
                
                currentUser = userData;
                document.getElementById('user-name').textContent = userData.name || 'Admin';
                
                console.log('âœ… Admin authenticated:', userData.name, '- Clinic:', CLINIC_NAME);
                
                // Load dashboard
                loadDashboard();
                
            } catch (error) {
                console.error('Error:', error);
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            }
        }
        
        // Check on page load
        checkAuth();
        
        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            }
        }
        
        // GoHighLevel API v2 Configuration
        const GHL_API_KEY = 'pit-5b612d16-1609-43c6-a669-322e9197a9a9';
        const GHL_LOCATION_ID = 'xzA6eU8kOYmBuwFdr3CF';
        const GHL_API_BASE_URL = 'https://services.leadconnectorhq.com';
        
        // Helper function to upsert (create or update) contact in GoHighLevel
        async function upsertGHLContact(contactData) {
            try {
                // Prepare contact payload
                const payload = {
                    locationId: GHL_LOCATION_ID,
                    email: contactData.email || '',
                    phone: contactData.phone || '',
                    tags: contactData.tags || [],
                    customFields: contactData.customFields || []
                };
                
                // Split name into first and last name if provided
                if (contactData.name) {
                    const nameParts = contactData.name.trim().split(' ');
                    payload.firstName = nameParts[0] || '';
                    payload.lastName = nameParts.slice(1).join(' ') || '';
                    payload.name = contactData.name;
                }
                
                console.log('Upserting GHL Contact:', payload);
                
                const response = await fetch(`${GHL_API_BASE_URL}/contacts/upsert`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${GHL_API_KEY}`,
                        'Content-Type': 'application/json',
                        'Version': '2021-07-28'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('GHL API Error:', response.status, errorText);
                    throw new Error(`GHL API Error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('GHL Contact Upserted Successfully:', data);
                return data;
            } catch (error) {
                console.error('Error upserting GHL contact:', error);
                // Don't throw - we don't want to break the main flow if GHL fails
                showToast('Contact synced to system, but GHL sync failed', 'warning');
                return null;
            }
        }
        
        let allDoctors = [];
        let allStaff = [];
        let allAppointments = [];
        let allGlobalServices = [];
        let currentStaffAssignedDoctors = [];
        let currentCalendarDate = new Date();
        let calendarAppointments = [];
        
        // Logout function is already defined above (line 539-544)
        // protectPage() removed - using Firebase auth instead
        
        // Simple translation helper - just returns the text as-is (no translation)
        function t(text) {
            return text;
        }
        
        // Re-login modal for admin after creating doctor/staff
        function showReLoginModal(adminEmail) {
            return new Promise((resolve, reject) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                        <div class="text-center mb-6">
                            <i class="fas fa-lock text-primary text-5xl mb-4"></i>
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">Re-authenticate</h3>
                            <p class="text-gray-600">Please enter your admin password to continue</p>
                            <p class="text-sm text-gray-500 mt-2">${adminEmail}</p>
                        </div>
                        <form id="relogin-form" class="space-y-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Password *</label>
                                <input type="password" id="admin-relogin-password" required autofocus class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                            </div>
                            <button type="submit" class="w-full bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
                                <i class="fas fa-sign-in-alt mr-2"></i>Continue
                            </button>
                        </form>
                    </div>
                `;
                document.getElementById('modal-container').appendChild(modal);
                
                document.getElementById('relogin-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const password = document.getElementById('admin-relogin-password').value;
                    modal.remove();
                    resolve(password);
                });
            });
        }
        
        function showToast(message, type = 'success') {
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
            const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
            const toast = document.createElement('div');
            toast.className = `toast ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg mb-2`;
            toast.innerHTML = `<div class="flex items-center space-x-2"><i class="fas ${icons[type]}"></i><span>${message}</span></div>`;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
        
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${section}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.nav-btn').classList.add('active');
            
            if (section === 'dashboard') loadDashboard();
            if (section === 'doctors') loadDoctors();
            if (section === 'staff') loadStaff();
            if (section === 'globalservices') loadGlobalServices();
            if (section === 'appointments') loadAppointments();
            if (section === 'calendar') loadCalendar();
            if (section === 'analytics') loadAnalytics();
        }
        
        async function loadDashboard() {
            try {
                const [allDoctorsSnap, staffSnap, appointmentsSnap] = await Promise.all([
                    db.collection('users').where('role', '==', 'doctor').get(),
                    db.collection('users').where('role', '==', 'staff').where('clinicId', '==', CLINIC_ID).get(),
                    db.collection('appointments').where('clinicId', '==', CLINIC_ID).get()
                ]);
                
                // Filter doctors: check both clinicId (single) and clinicIds (array)
                const clinicDoctors = allDoctorsSnap.docs.filter(doc => {
                    const data = doc.data();
                    if (data.clinicId === CLINIC_ID) return true;
                    if (data.clinicIds && data.clinicIds.includes(CLINIC_ID)) return true;
                    return false;
                });
                
                const today = new Date().toISOString().split('T')[0];
                const todayAppointments = appointmentsSnap.docs.filter(doc => doc.data().date === today);
                
                document.getElementById('stat-doctors').textContent = clinicDoctors.length;
                document.getElementById('stat-staff').textContent = staffSnap.size;
                document.getElementById('stat-appointments').textContent = appointmentsSnap.size;
                document.getElementById('stat-today').textContent = todayAppointments.length;
                
                const recentAppointments = appointmentsSnap.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0))
                    .slice(0, 10);
                
                const recentDiv = document.getElementById('recent-appointments');
                recentDiv.innerHTML = recentAppointments.map(apt => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <p class="font-semibold text-gray-800">${apt.patientName}</p>
                            <p class="text-sm text-gray-600">${apt.date} - ${apt.startTime || 'N/A'}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${getStatusColor(apt.status)}">${apt.status.toUpperCase()}</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showToast('Error loading dashboard', 'error');
            }
        }
        
        function getStatusColor(status) {
            const colors = {
                'booked': 'bg-blue-100 text-blue-800',
                'approve': 'bg-purple-100 text-purple-800',
                'appointment': 'bg-green-100 text-green-800',
                'missed': 'bg-orange-100 text-orange-800',
                'cancelled': 'bg-red-100 text-red-800',
                'completed': 'bg-gray-100 text-gray-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }
        
        async function loadDoctors() {
            try {
                // Get all doctors
                const snapshot = await db.collection('users').where('role', '==', 'doctor').get();
                
                // Filter doctors assigned to this clinic (support both clinicId and clinicIds)
                allDoctors = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(doctor => {
                        if (doctor.clinicId === CLINIC_ID) return true;
                        if (doctor.clinicIds && doctor.clinicIds.includes(CLINIC_ID)) return true;
                        return false;
                    });
                
                const grid = document.getElementById('doctors-grid');
                grid.innerHTML = allDoctors.map(doctor => {
                    const isActive = doctor.active !== false;
                    
                    // Check if doctor is in multiple clinics
                    const clinics = doctor.clinicIds || (doctor.clinicId ? [doctor.clinicId] : []);
                    const isMultiClinic = clinics.length > 1;
                    
                    return `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer hover:shadow-2xl transition-all duration-300 border border-gray-100" onclick="showDoctorDetailsModal('${doctor.id}')">
                        <!-- Status Badge -->
                        <div class="${isActive ? 'bg-gradient-to-r from-green-500 to-green-600' : 'bg-gradient-to-r from-red-500 to-red-600'} px-4 py-2">
                            <div class="flex items-center justify-between">
                                <span class="text-white text-xs font-semibold uppercase tracking-wide">
                                    <i class="fas ${isActive ? 'fa-check-circle' : 'fa-times-circle'} mr-1"></i>
                                    ${isActive ? 'Active' : 'Inactive'}
                                </span>
                                ${isMultiClinic ? '<span class="bg-white text-blue-600 text-xs font-bold px-2 py-1 rounded"><i class="fas fa-hospital mr-1"></i>Multi-Clinic</span>' : '<span class="text-white text-xs opacity-75">Doctor</span>'}
                            </div>
                        </div>
                        
                        <!-- Card Content -->
                        <div class="p-6">
                            <div class="flex items-start space-x-4 mb-4">
                                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl flex items-center justify-center text-2xl shadow-lg flex-shrink-0">
                                    <i class="fas fa-user-md"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-xl font-bold text-gray-800 mb-1 truncate">${doctor.name}</h3>
                                    <p class="text-sm text-gray-600 truncate">
                                        <i class="fas fa-envelope text-gray-400 mr-1"></i>${doctor.email}
                                    </p>
                                    <p class="text-sm text-gray-600 mt-1">
                                        <i class="fas fa-phone text-gray-400 mr-1"></i>${doctor.phone || 'N/A'}
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Doctor UID -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs text-blue-600 font-semibold mb-1">Doctor UID</p>
                                        <code class="text-xs text-gray-700 font-mono block truncate">${doctor.id}</code>
                                    </div>
                                    <button onclick="event.stopPropagation(); copyDoctorUID('${doctor.id}')" class="ml-2 bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700 transition text-xs">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <button onclick="event.stopPropagation(); deleteDoctor('${doctor.id}')" class="w-full bg-red-500 text-white px-4 py-2.5 rounded-lg hover:bg-red-600 transition font-semibold shadow-md hover:shadow-lg">
                                <i class="fas fa-trash mr-2"></i> ${isMultiClinic ? 'Remove from Clinic' : 'Delete Doctor'}
                            </button>
                        </div>
                    </div>
                `;
                }).join('');
            } catch (error) {
                console.error('Error loading doctors:', error);
                showToast('Error loading doctors', 'error');
            }
        }
        
        function filterDoctors() {
            const searchTerm = document.getElementById('doctor-search').value.toLowerCase().trim();
            const grid = document.getElementById('doctors-grid');
            
            const filteredDoctors = allDoctors.filter(doctor => {
                const name = (doctor.name || '').toLowerCase();
                const email = (doctor.email || '').toLowerCase();
                const specialty = (doctor.specialty || '').toLowerCase();
                
                return name.includes(searchTerm) || 
                       email.includes(searchTerm) || 
                       specialty.includes(searchTerm);
            });
            
            if (filteredDoctors.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-search text-gray-300 text-6xl mb-4"></i>
                        <p class="text-gray-500 text-lg">No doctors found matching "${searchTerm}"</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = filteredDoctors.map(doctor => {
                const isActive = doctor.active !== false;
                const clinics = doctor.clinicIds || (doctor.clinicId ? [doctor.clinicId] : []);
                const isMultiClinic = clinics.length > 1;
                
                return `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer hover:shadow-2xl transition-all duration-300 border border-gray-100" onclick="showDoctorDetailsModal('${doctor.id}')">
                    <!-- Status Badge -->
                    <div class="${isActive ? 'bg-gradient-to-r from-green-500 to-green-600' : 'bg-gradient-to-r from-red-500 to-red-600'} px-4 py-2">
                        <div class="flex items-center justify-between">
                            <span class="text-white text-xs font-semibold uppercase tracking-wide">
                                <i class="fas ${isActive ? 'fa-check-circle' : 'fa-times-circle'} mr-1"></i>
                                ${isActive ? 'Active' : 'Inactive'}
                            </span>
                            ${isMultiClinic ? '<span class="bg-white text-blue-600 text-xs font-bold px-2 py-1 rounded"><i class="fas fa-hospital mr-1"></i>Multi-Clinic</span>' : '<span class="text-white text-xs opacity-75">Doctor</span>'}
                        </div>
                    </div>
                    
                    <!-- Card Content -->
                    <div class="p-6">
                        <div class="flex items-start space-x-4 mb-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl flex items-center justify-center text-2xl shadow-lg flex-shrink-0">
                                <i class="fas fa-user-md"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-xl font-bold text-gray-800 mb-1 truncate">${doctor.name}</h3>
                                <p class="text-sm text-gray-600 truncate">
                                    <i class="fas fa-envelope text-gray-400 mr-1"></i>${doctor.email}
                                </p>
                                <p class="text-sm text-gray-600 mt-1">
                                    <i class="fas fa-phone text-gray-400 mr-1"></i>${doctor.phone || 'N/A'}
                                </p>
                            </div>
                        </div>
                        
                        <!-- Doctor UID -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs text-blue-600 font-semibold mb-1">Doctor UID</p>
                                    <code class="text-xs text-gray-700 font-mono block truncate">${doctor.id}</code>
                                </div>
                                <button onclick="event.stopPropagation(); copyDoctorUID('${doctor.id}')" class="ml-2 bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700 transition text-xs">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        
                        <button onclick="event.stopPropagation(); deleteDoctor('${doctor.id}')" class="w-full bg-red-500 text-white px-4 py-2.5 rounded-lg hover:bg-red-600 transition font-semibold shadow-md hover:shadow-lg">
                            <i class="fas fa-trash mr-2"></i> ${isMultiClinic ? 'Remove from Clinic' : 'Delete Doctor'}
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        function showAddDoctorModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Create New Doctor</h3>
                    
                    <!-- Email Exists Warning (Hidden by default) -->
                    <div id="email-exists-warning" class="hidden bg-red-50 border-l-4 border-red-500 p-4 mb-4 rounded">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-circle text-red-600 text-xl mr-3 mt-0.5"></i>
                            <div class="flex-1">
                                <h4 class="font-bold text-red-800 mb-1">Doctor Already Exists!</h4>
                                <p class="text-sm text-red-700 mb-2">A doctor with this email already exists in the system.</p>
                                <button onclick="switchToAddExisting()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition text-sm font-semibold">
                                    <i class="fas fa-user-plus mr-2"></i>Add Existing Doctor Instead
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <form id="doctor-form" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Name *</label>
                            <input type="text" id="doctor-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Email *</label>
                            <input type="email" id="doctor-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Phone *</label>
                            <input type="tel" id="doctor-phone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Password *</label>
                            <input type="password" id="doctor-password" required minlength="6" placeholder="Min 6 characters" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Specialty</label>
                            <input type="text" id="doctor-specialty" placeholder="e.g., Orthodontist" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        </div>
                        <div class="flex space-x-2">
                            <button type="submit" class="flex-1 bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
                                <i class="fas fa-save mr-2"></i>Create Doctor
                            </button>
                            <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition font-semibold">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            
            document.getElementById('doctor-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
                
                try {
                    const name = document.getElementById('doctor-name').value;
                    const email = document.getElementById('doctor-email').value.toLowerCase();
                    const phone = document.getElementById('doctor-phone').value;
                    const password = document.getElementById('doctor-password').value;
                    const specialty = document.getElementById('doctor-specialty').value;
                    
                    // Check if email already exists
                    const existingUser = await db.collection('users')
                        .where('email', '==', email)
                        .where('role', '==', 'doctor')
                        .get();
                    
                    if (!existingUser.empty) {
                        // Show warning banner
                        const warning = document.getElementById('email-exists-warning');
                        warning.classList.remove('hidden');
                        
                        // Highlight email field
                        const emailInput = document.getElementById('doctor-email');
                        emailInput.classList.add('border-red-500', 'bg-red-50');
                        emailInput.classList.remove('border-gray-300');
                        
                        // Scroll to warning
                        warning.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        return;
                    }
                    
                    // Create Firestore user document (basic info only - NO schedule/services)
                    const userRef = await db.collection('users').add({
                        name: name,
                        email: email,
                        password: password,
                        phone: phone,
                        specialty: specialty,
                        role: 'doctor',
                        clinicId: CLINIC_ID,           // Primary clinic
                        clinicIds: [CLINIC_ID],        // All clinics (array)
                        active: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Create clinic-specific profile (services & schedule per clinic)
                    await db.collection('doctorClinicProfiles').doc(`${userRef.id}_${CLINIC_ID}`).set({
                        doctorId: userRef.id,
                        clinicId: CLINIC_ID,
                        doctorName: name,
                        services: [],                  // Empty - doctor will add from Global Services
                        weeklySchedule: {
                            monday: [],
                            tuesday: [],
                            wednesday: [],
                            thursday: [],
                            friday: [],
                            saturday: [],
                            sunday: []
                        },
                        appointmentDuration: 30,
                        bufferTime: 10,
                        offDates: [],
                        active: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Create contact in GoHighLevel
                    await upsertGHLContact({
                        name: name,
                        email: email,
                        phone: phone,
                        tags: ['Doctor']
                    });
                    
                    // Show UID modal
                    closeModal();
                    showDoctorUIDModal(userRef.id, name);
                    loadDoctors(); // Just refresh the doctor list
                    
                } catch (error) {
                    console.error('Error adding doctor:', error);
                    showToast(error.message || 'Error adding doctor', 'error');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            });
        }
        
        function switchToAddExisting() {
            closeModal();
            showAddExistingDoctorModal();
        }
        
        function showDoctorUIDModal(doctorId, doctorName) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-8">
                    <div class="text-center mb-6">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-check-circle text-green-600 text-4xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Doctor Created Successfully!</h3>
                        <p class="text-gray-600">${doctorName} has been added to ${CLINIC_NAME}</p>
                    </div>
                    
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded mb-6">
                        <h4 class="font-bold text-blue-800 mb-2">
                            <i class="fas fa-key mr-2"></i>Doctor UID
                        </h4>
                        <div class="flex items-center space-x-2 bg-white p-3 rounded border border-blue-200">
                            <code id="doctor-uid-display" class="flex-1 text-lg font-mono text-gray-800">${doctorId}</code>
                            <button onclick="copyDoctorUID('${doctorId}')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                                <i class="fas fa-copy mr-2"></i>Copy
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded mb-6">
                        <p class="text-sm text-yellow-800">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <strong>Important:</strong> Share this UID with ${doctorName}. They will need it if they want to join other clinics in the future.
                        </p>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="printDoctorUID('${doctorId}', '${doctorName}')" class="w-full bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition font-semibold">
                            <i class="fas fa-print mr-2"></i>Print UID
                        </button>
                        <button onclick="closeModal()" class="w-full bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
                            <i class="fas fa-check mr-2"></i>Done
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
        }
        
        function copyDoctorUID(uid) {
            navigator.clipboard.writeText(uid).then(() => {
                showToast('UID copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showToast('Failed to copy UID', 'error');
            });
        }
        
        function printDoctorUID(uid, name) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Doctor UID - ${name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 40px; }
                        .container { max-width: 600px; margin: 0 auto; border: 2px solid #333; padding: 30px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .uid-box { background: #f0f0f0; padding: 20px; border: 2px dashed #666; text-align: center; margin: 20px 0; }
                        .uid { font-size: 24px; font-weight: bold; font-family: monospace; }
                        .note { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-top: 20px; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>Doctor UID</h1>
                            <h2>${name}</h2>
                            <p>Clinic: ${CLINIC_NAME}</p>
                        </div>
                        <div class="uid-box">
                            <p style="margin: 0 0 10px 0;">Your Doctor UID:</p>
                            <div class="uid">${uid}</div>
                        </div>
                        <div class="note">
                            <strong>Important:</strong> Keep this UID private. Share it only with clinic administrators you trust. You will need this UID to join additional clinics.
                        </div>
                        <p style="text-align: center; margin-top: 30px; color: #666;">
                            Generated on ${new Date().toLocaleDateString()}
                        </p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        function showAddExistingDoctorModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 max-h-screen overflow-y-auto">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-user-plus text-green-600 mr-2"></i>Add Existing Doctor
                    </h3>
                    
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Note:</strong> To add a doctor who already exists in another clinic, you'll need their Doctor UID for verification.
                        </p>
                    </div>
                    
                    <!-- Search Methods -->
                    <div class="mb-6">
                        <div class="flex space-x-2 mb-4">
                            <button onclick="switchSearchMethod('email')" id="search-email-tab" class="flex-1 px-4 py-2 rounded-lg font-semibold bg-primary text-white">
                                <i class="fas fa-envelope mr-2"></i>Search by Email
                            </button>
                            <button onclick="switchSearchMethod('uid')" id="search-uid-tab" class="flex-1 px-4 py-2 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300">
                                <i class="fas fa-id-card mr-2"></i>Search by UID
                            </button>
                        </div>
                        
                        <!-- Email Search -->
                        <div id="email-search-section">
                            <label class="block text-gray-700 font-semibold mb-2">Doctor's Email Address</label>
                            <div class="flex space-x-2">
                                <input type="email" id="search-doctor-email" placeholder="doctor@example.com" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg">
                                <button onclick="searchDoctorByEmail()" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition font-semibold">
                                    <i class="fas fa-search mr-2"></i>Search
                                </button>
                            </div>
                        </div>
                        
                        <!-- UID Search -->
                        <div id="uid-search-section" class="hidden">
                            <label class="block text-gray-700 font-semibold mb-2">Doctor UID</label>
                            <div class="flex space-x-2">
                                <input type="text" id="search-doctor-uid" placeholder="Enter doctor's UID" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg">
                                <button onclick="searchDoctorByUID()" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition font-semibold">
                                    <i class="fas fa-search mr-2"></i>Search
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search Results -->
                    <div id="doctor-search-results" class="hidden">
                        <!-- Results will be populated here -->
                    </div>
                    
                    <div class="flex justify-end space-x-2 mt-6">
                        <button onclick="closeModal()" class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition font-semibold">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
        }
        
        function switchSearchMethod(method) {
            const emailTab = document.getElementById('search-email-tab');
            const uidTab = document.getElementById('search-uid-tab');
            const emailSection = document.getElementById('email-search-section');
            const uidSection = document.getElementById('uid-search-section');
            const resultsSection = document.getElementById('doctor-search-results');
            
            if (method === 'email') {
                emailTab.className = 'flex-1 px-4 py-2 rounded-lg font-semibold bg-primary text-white';
                uidTab.className = 'flex-1 px-4 py-2 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300';
                emailSection.classList.remove('hidden');
                uidSection.classList.add('hidden');
            } else {
                uidTab.className = 'flex-1 px-4 py-2 rounded-lg font-semibold bg-primary text-white';
                emailTab.className = 'flex-1 px-4 py-2 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300';
                uidSection.classList.remove('hidden');
                emailSection.classList.add('hidden');
            }
            
            // Hide results when switching
            resultsSection.classList.add('hidden');
            resultsSection.innerHTML = '';
        }
        
        async function searchDoctorByEmail() {
            const email = document.getElementById('search-doctor-email').value.trim().toLowerCase();
            
            if (!email) {
                showToast('Please enter an email address', 'warning');
                return;
            }
            
            try {
                const resultsSection = document.getElementById('doctor-search-results');
                resultsSection.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-2xl text-primary"></i><p class="mt-2 text-gray-600">Searching...</p></div>';
                resultsSection.classList.remove('hidden');
                
                // Search for doctor by email
                const doctorSnap = await db.collection('users')
                    .where('email', '==', email)
                    .where('role', '==', 'doctor')
                    .get();
                
                if (doctorSnap.empty) {
                    resultsSection.innerHTML = `
                        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                            <p class="text-yellow-800">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                No doctor found with email: <strong>${email}</strong>
                            </p>
                        </div>
                    `;
                    return;
                }
                
                const doctorData = doctorSnap.docs[0];
                const doctor = { id: doctorData.id, ...doctorData.data() };
                
                // Check if already in this clinic
                const currentClinics = doctor.clinicIds || (doctor.clinicId ? [doctor.clinicId] : []);
                if (currentClinics.includes(CLINIC_ID)) {
                    resultsSection.innerHTML = `
                        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                            <p class="text-yellow-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                This doctor is already assigned to your clinic.
                            </p>
                        </div>
                    `;
                    return;
                }
                
                // Get clinic names
                let clinicNames = 'No clinics';
                if (currentClinics.length > 0) {
                    const clinicPromises = currentClinics.map(id => db.collection('clinics').doc(id).get());
                    const clinicDocs = await Promise.all(clinicPromises);
                    clinicNames = clinicDocs.filter(d => d.exists).map(d => d.data().name).join(', ');
                }
                
                // Show doctor found - ask for UID
                resultsSection.innerHTML = `
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded mb-4">
                        <h4 class="font-bold text-green-800 mb-2">
                            <i class="fas fa-check-circle mr-2"></i>Doctor Found!
                        </h4>
                        <div class="space-y-2 text-sm text-green-800">
                            <p><strong>Name:</strong> ${doctor.name}</p>
                            <p><strong>Email:</strong> ${doctor.email}</p>
                            <p><strong>Specialty:</strong> ${doctor.specialty || 'General'}</p>
                            <p><strong>Current Clinics:</strong> ${clinicNames} (${currentClinics.length})</p>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded mb-4">
                        <p class="text-sm text-yellow-800">
                            <i class="fas fa-shield-alt mr-2"></i>
                            <strong>Security Verification Required</strong><br>
                            To add this doctor to your clinic, please ask them for their Doctor UID and enter it below:
                        </p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">Doctor UID *</label>
                        <input type="text" id="verify-doctor-uid" placeholder="Enter UID provided by the doctor" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    
                    <button id="verify-add-btn" onclick="verifyAndAddDoctor('${doctor.id}', '${email}')" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
                        <i class="fas fa-check mr-2"></i>Verify UID & Add to Clinic
                    </button>
                `;
                
            } catch (error) {
                console.error('Error searching doctor:', error);
                showToast('Error searching for doctor', 'error');
            }
        }
        
        async function searchDoctorByUID() {
            const uid = document.getElementById('search-doctor-uid').value.trim();
            
            if (!uid) {
                showToast('Please enter a Doctor UID', 'warning');
                return;
            }
            
            try {
                const resultsSection = document.getElementById('doctor-search-results');
                resultsSection.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-2xl text-primary"></i><p class="mt-2 text-gray-600">Searching...</p></div>';
                resultsSection.classList.remove('hidden');
                
                // Search for doctor by UID (document ID)
                const doctorDoc = await db.collection('users').doc(uid).get();
                
                if (!doctorDoc.exists || doctorDoc.data().role !== 'doctor') {
                    resultsSection.innerHTML = `
                        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                            <p class="text-yellow-800">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                No doctor found with UID: <strong>${uid}</strong>
                            </p>
                        </div>
                    `;
                    return;
                }
                
                const doctor = { id: doctorDoc.id, ...doctorDoc.data() };
                
                // Check if already in this clinic
                const currentClinics = doctor.clinicIds || (doctor.clinicId ? [doctor.clinicId] : []);
                if (currentClinics.includes(CLINIC_ID)) {
                    resultsSection.innerHTML = `
                        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                            <p class="text-yellow-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                This doctor is already assigned to your clinic.
                            </p>
                        </div>
                    `;
                    return;
                }
                
                // Get clinic names
                let clinicNames = 'No clinics';
                if (currentClinics.length > 0) {
                    const clinicPromises = currentClinics.map(id => db.collection('clinics').doc(id).get());
                    const clinicDocs = await Promise.all(clinicPromises);
                    clinicNames = clinicDocs.filter(d => d.exists).map(d => d.data().name).join(', ');
                }
                
                // Show doctor found - UID already verified!
                resultsSection.innerHTML = `
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded mb-4">
                        <h4 class="font-bold text-green-800 mb-2">
                            <i class="fas fa-check-circle mr-2"></i>Doctor Found & UID Verified!
                        </h4>
                        <div class="space-y-2 text-sm text-green-800">
                            <p><strong>Name:</strong> ${doctor.name}</p>
                            <p><strong>Email:</strong> ${doctor.email}</p>
                            <p><strong>Specialty:</strong> ${doctor.specialty || 'General'}</p>
                            <p><strong>Current Clinics:</strong> ${clinicNames} (${currentClinics.length})</p>
                        </div>
                    </div>
                    
                    <button onclick="addDoctorToClinic('${doctor.id}')" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
                        <i class="fas fa-plus mr-2"></i>Add to ${CLINIC_NAME}
                    </button>
                `;
                
            } catch (error) {
                console.error('Error searching doctor:', error);
                showToast('Error searching for doctor', 'error');
            }
        }
        
        async function verifyAndAddDoctor(doctorId, email) {
            const enteredUID = document.getElementById('verify-doctor-uid').value.trim();
            
            if (!enteredUID) {
                showToast('Please enter the Doctor UID', 'warning');
                return;
            }
            
            // Verify UID matches doctor ID
            if (enteredUID !== doctorId) {
                showToast('Invalid UID. Please verify with the doctor and try again.', 'error');
                return;
            }
            
            // Show loading spinner on button
            const btn = document.getElementById('verify-add-btn');
            if (btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Adding...';
                btn.disabled = true;
            }
            
            // UID verified! Add to clinic
            await addDoctorToClinic(doctorId);
        }
        
        async function addDoctorToClinic(doctorId) {
            try {
                showToast('Adding doctor to clinic...', 'info');
                
                // Get current doctor data
                const doctorDoc = await db.collection('users').doc(doctorId).get();
                const doctor = doctorDoc.data();
                
                // Update doctor's clinic assignments
                const currentClinics = doctor.clinicIds || (doctor.clinicId ? [doctor.clinicId] : []);
                const updatedClinics = [...currentClinics, CLINIC_ID];
                
                await db.collection('users').doc(doctorId).update({
                    clinicIds: updatedClinics,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Create clinic-specific profile for this clinic (empty services & schedule)
                await db.collection('doctorClinicProfiles').doc(`${doctorId}_${CLINIC_ID}`).set({
                    doctorId: doctorId,
                    clinicId: CLINIC_ID,
                    doctorName: doctor.name,
                    services: [],                  // Empty - doctor will add from Global Services
                    weeklySchedule: {
                        monday: [],
                        tuesday: [],
                        wednesday: [],
                        thursday: [],
                        friday: [],
                        saturday: [],
                        sunday: []
                    },
                    appointmentDuration: 30,
                    bufferTime: 10,
                    offDates: [],
                    active: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Log audit trail
                await db.collection('audit_log').add({
                    action: 'doctor_added_to_clinic',
                    doctorId: doctorId,
                    doctorName: doctor.name,
                    clinicId: CLINIC_ID,
                    clinicName: CLINIC_NAME,
                    addedBy: currentUser ? currentUser.odooId || currentUser.id : 'admin',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast(`âœ… ${doctor.name} has been added to ${CLINIC_NAME}!`, 'success');
                closeModal();
                loadDoctors();
                
            } catch (error) {
                console.error('Error adding doctor to clinic:', error);
                showToast('Error adding doctor to clinic', 'error');
            }
        }
        
        async function showDoctorDetailsModal(doctorId) {
            // Show loading modal
            const loadingModal = document.createElement('div');
            loadingModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-8 flex flex-col items-center space-y-4">
                    <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full spinner"></div>
                    <p class="text-gray-700 font-semibold text-lg">Loading doctor details...</p>
                </div>
            `;
            document.getElementById('modal-container').appendChild(loadingModal);
            
            try {
                // Fetch doctor data
                const doctorDoc = await db.collection('users').doc(doctorId).get();
                const doctor = { id: doctorDoc.id, ...doctorDoc.data() };
                
                // Fetch doctor profile
                const profileSnap = await db.collection('doctors').where('userId', '==', doctorId).get();
                const profile = profileSnap.empty ? {} : profileSnap.docs[0].data();
                
                // Fetch appointment stats
                const appointmentsSnap = await db.collection('appointments').where('doctorId', '==', doctorId).get();
                const totalAppointments = appointmentsSnap.size;
                
                // Remove loading modal
                loadingModal.remove();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <!-- Header -->
                        <div class="bg-primary text-white p-6 rounded-t-xl">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="w-16 h-16 bg-white text-primary rounded-full flex items-center justify-center text-2xl">
                                        <i class="fas fa-user-md"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-2xl font-bold">Doctor Details</h3>
                                        <p class="text-blue-100 text-sm">Manage doctor information</p>
                                    </div>
                                </div>
                                <button onclick="closeModal()" class="text-white hover:text-gray-200 text-2xl">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Content -->
                        <div class="p-6 space-y-6">
                            <!-- Doctor UID -->
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                                <h4 class="font-bold text-blue-800 mb-3 flex items-center">
                                    <i class="fas fa-key text-blue-600 mr-2"></i> Doctor UID
                                </h4>
                                <div class="flex items-center space-x-2 bg-white p-3 rounded border border-blue-200">
                                    <code class="flex-1 text-sm font-mono text-gray-800">${doctor.id}</code>
                                    <button onclick="event.stopPropagation(); copyDoctorUID('${doctor.id}')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                                        <i class="fas fa-copy mr-2"></i>Copy
                                    </button>
                                </div>
                                <p class="text-xs text-blue-700 mt-2">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Share this UID with the doctor to join other clinics
                                </p>
                            </div>
                            
                            ${(() => {
                                const clinics = doctor.clinicIds || (doctor.clinicId ? [doctor.clinicId] : []);
                                if (clinics.length > 1) {
                                    return `
                                    <!-- Multi-Clinic Info -->
                                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                                        <h4 class="font-bold text-yellow-800 mb-2 flex items-center">
                                            <i class="fas fa-hospital text-yellow-600 mr-2"></i> Multi-Clinic Doctor
                                        </h4>
                                        <p class="text-sm text-yellow-700 mb-2">
                                            This doctor is assigned to <strong>${clinics.length} clinics</strong>. Deleting will only remove them from ${CLINIC_NAME}.
                                        </p>
                                    </div>
                                    `;
                                }
                                return '';
                            })()}
                            
                            <!-- Basic Information -->
                            <div>
                                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-info-circle text-primary mr-2"></i> Basic Information
                                </h4>
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Name</label>
                                        <input type="text" id="edit-name" value="${doctor.name}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Email</label>
                                        <input type="email" id="edit-email" value="${doctor.email}" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Phone</label>
                                        <input type="tel" id="edit-phone" value="${doctor.phone || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Specialty</label>
                                        <input type="text" id="edit-specialty" value="${profile.specialty || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Credentials -->
                            <div>
                                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-key text-primary mr-2"></i> Credentials
                                </h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Username</label>
                                        <input type="text" id="edit-username" value="${doctor.username || doctor.email}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Password</label>
                                        <div class="flex space-x-2">
                                            <div class="flex-1 relative">
                                                <input type="password" id="current-password" value="${doctor.password || 'defaultpass123'}" class="w-full px-4 py-2 border border-gray-300 rounded-lg pr-10" readonly>
                                                <button onclick="togglePasswordVisibility()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                                    <i id="password-eye" class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <button onclick="showChangePasswordForm()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition whitespace-nowrap">
                                                <i class="fas fa-edit mr-2"></i>Change
                                            </button>
                                        </div>
                                    </div>
                                    <div id="change-password-form" class="hidden space-y-3 p-4 bg-gray-50 rounded-lg">
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2 text-sm">New Password</label>
                                            <input type="password" id="new-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Enter new password">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2 text-sm">Confirm Password</label>
                                            <input type="password" id="confirm-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Confirm new password">
                                        </div>
                                        <div class="flex space-x-2">
                                            <button onclick="saveNewPassword('${doctorId}')" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">
                                                <i class="fas fa-check mr-2"></i>Save Password
                                            </button>
                                            <button onclick="cancelChangePassword()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Status & Stats -->
                            <div class="grid md:grid-cols-2 gap-6">
                                <!-- Status -->
                                <div>
                                    <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                        <i class="fas fa-toggle-on text-primary mr-2"></i> Status
                                    </h4>
                                    <div class="flex items-center space-x-3">
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="doctor-active" ${profile.active !== false ? 'checked' : ''} class="sr-only peer">
                                            <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                                        </label>
                                        <span class="text-gray-700 font-semibold" id="status-text">${profile.active !== false ? 'Active' : 'Inactive'}</span>
                                    </div>
                                </div>
                                
                                <!-- Quick Stats -->
                                <div>
                                    <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                        <i class="fas fa-chart-bar text-primary mr-2"></i> Quick Stats
                                    </h4>
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <p class="text-gray-600 text-sm">Total Appointments</p>
                                        <p class="text-3xl font-bold text-primary">${totalAppointments}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Admin Notes -->
                            <div>
                                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-sticky-note text-primary mr-2"></i> Admin Notes
                                </h4>
                                <textarea id="edit-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Internal notes about this doctor...">${profile.notes || ''}</textarea>
                            </div>
                        </div>
                        
                        <!-- Footer Actions -->
                        <div class="bg-gray-50 p-6 rounded-b-xl flex flex-wrap gap-3">
                            <button onclick="saveDoctorChanges('${doctorId}')" class="flex-1 bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
                                <i class="fas fa-save mr-2"></i>Save Changes
                            </button>
                            <button onclick="deleteDoctorFromModal('${doctorId}')" class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition font-semibold">
                                <i class="fas fa-trash mr-2"></i>Delete
                            </button>
                            <button onclick="closeModal()" class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition font-semibold">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('modal-container').appendChild(modal);
                
                // Add event listener for active toggle
                document.getElementById('doctor-active').addEventListener('change', function() {
                    document.getElementById('status-text').textContent = this.checked ? 'Active' : 'Inactive';
                });
                
            } catch (error) {
                // Remove loading modal on error
                loadingModal.remove();
                console.error('Error loading doctor details:', error);
                showToast('Error loading doctor details', 'error');
            }
        }
        
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('current-password');
            const eyeIcon = document.getElementById('password-eye');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                eyeIcon.className = 'fas fa-eye';
            }
        }
        
        function showChangePasswordForm() {
            document.getElementById('change-password-form').classList.remove('hidden');
        }
        
        function cancelChangePassword() {
            document.getElementById('change-password-form').classList.add('hidden');
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
        }
        
        async function saveNewPassword(doctorId) {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (!newPassword || !confirmPassword) {
                showToast('Please fill in both password fields', 'warning');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showToast('Password must be at least 6 characters', 'warning');
                return;
            }
            
            try {
                await db.collection('users').doc(doctorId).update({
                    password: newPassword
                });
                
                showToast('Password updated successfully', 'success');
                cancelChangePassword();
                
                // Update the displayed password
                document.getElementById('current-password').value = newPassword;
            } catch (error) {
                console.error('Error updating password:', error);
                showToast('Error updating password', 'error');
            }
        }
        
        async function saveDoctorChanges(doctorId) {
            try {
                const name = document.getElementById('edit-name').value;
                const phone = document.getElementById('edit-phone').value;
                const username = document.getElementById('edit-username').value;
                const specialty = document.getElementById('edit-specialty').value;
                const notes = document.getElementById('edit-notes').value;
                const active = document.getElementById('doctor-active').checked;
                
                if (!name || !phone) {
                    showToast('Name and phone are required', 'warning');
                    return;
                }
                
                // Update user document (including specialty)
                await db.collection('users').doc(doctorId).update({
                    name: name,
                    phone: phone,
                    username: username,
                    specialty: specialty, // âœ… ADD SPECIALTY HERE
                    active: active // âœ… Also sync active status
                });
                
                // Update or create doctor profile
                const profileSnap = await db.collection('doctors').where('userId', '==', doctorId).get();
                
                const profileData = {
                    specialty: specialty,
                    notes: notes,
                    active: active
                };
                
                if (profileSnap.empty) {
                    await db.collection('doctors').add({
                        userId: doctorId,
                        name: name,
                        ...profileData,
                        appointmentDuration: 30,
                        bufferTime: 10,
                        weeklySchedule: {},
                        offDates: []
                    });
                } else {
                    await profileSnap.docs[0].ref.update(profileData);
                }
                
                showToast('Doctor updated successfully', 'success');
                closeModal();
                loadDoctors();
            } catch (error) {
                console.error('Error saving doctor changes:', error);
                showToast('Error saving changes', 'error');
            }
        }
        
        async function deleteDoctorFromModal(doctorId) {
            // Get doctor data to check clinics
            const doctorDoc = await db.collection('users').doc(doctorId).get();
            const doctor = doctorDoc.data();
            const clinics = doctor.clinicIds || (doctor.clinicId ? [doctor.clinicId] : []);
            const isMultiClinic = clinics.length > 1;
            
            const confirmed = await showConfirmDialog(
                isMultiClinic ? 'Remove from Clinic' : 'Delete Doctor',
                isMultiClinic 
                    ? `This doctor is in ${clinics.length} clinics. This will only remove them from ${CLINIC_NAME}.`
                    : 'Are you sure you want to delete this doctor? This will also delete their profile and services.',
                isMultiClinic ? 'Remove' : 'Delete',
                'Cancel'
            );
            
            if (!confirmed) return;
            
            closeModal(); // Close details modal first
            
            // Show loading spinner
            const loadingModal = document.createElement('div');
            loadingModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-8 flex flex-col items-center space-y-4">
                    <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                    <p class="text-gray-700 font-semibold text-lg">${isMultiClinic ? 'Removing from clinic...' : 'Deleting doctor...'}</p>
                </div>
            `;
            document.body.appendChild(loadingModal);
            
            try {
                if (isMultiClinic) {
                    // Remove from this clinic only
                    const updatedClinics = clinics.filter(id => id !== CLINIC_ID);
                    await db.collection('users').doc(doctorId).update({
                        clinicIds: updatedClinics,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    loadingModal.remove();
                    showToast(`âœ… Doctor removed from ${CLINIC_NAME}!`, 'success');
                } else {
                    // Delete completely
                    await db.collection('users').doc(doctorId).delete();
                    
                    const profileSnap = await db.collection('doctors').doc(doctorId).get();
                    if (profileSnap.exists) {
                        await profileSnap.ref.delete();
                    }
                    
                    const servicesSnap = await db.collection('services').where('userId', '==', doctorId).get();
                    const deletePromises = servicesSnap.docs.map(doc => doc.ref.delete());
                    await Promise.all(deletePromises);
                    
                    loadingModal.remove();
                    showToast('âœ… Doctor deleted successfully!', 'success');
                }
                
                loadDoctors();
            } catch (error) {
                console.error('Error:', error);
                loadingModal.remove();
                showToast('âŒ Error: ' + error.message, 'error');
            }
        }
        
        async function deleteDoctor(id) {
            // Get doctor data to check clinics
            const doctorDoc = await db.collection('users').doc(id).get();
            const doctor = doctorDoc.data();
            const clinics = doctor.clinicIds || (doctor.clinicId ? [doctor.clinicId] : []);
            const isMultiClinic = clinics.length > 1;
            
            const confirmed = await showConfirmDialog(
                isMultiClinic ? 'Remove from Clinic' : 'Delete Doctor',
                isMultiClinic 
                    ? `This doctor is in ${clinics.length} clinics. This will only remove them from ${CLINIC_NAME}.`
                    : 'Are you sure you want to delete this doctor? This will also delete their profile and services.',
                isMultiClinic ? 'Remove' : 'Delete',
                'Cancel'
            );
            
            if (!confirmed) return;
            
            // Show loading spinner
            const loadingModal = document.createElement('div');
            loadingModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-8 flex flex-col items-center space-y-4">
                    <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                    <p class="text-gray-700 font-semibold text-lg">${isMultiClinic ? 'Removing from clinic...' : 'Deleting doctor...'}</p>
                </div>
            `;
            document.body.appendChild(loadingModal);
            
            try {
                if (isMultiClinic) {
                    // Remove from this clinic only
                    const updatedClinics = clinics.filter(cid => cid !== CLINIC_ID);
                    await db.collection('users').doc(id).update({
                        clinicIds: updatedClinics,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    loadingModal.remove();
                    showToast(`âœ… Doctor removed from ${CLINIC_NAME}!`, 'success');
                } else {
                    // Delete completely
                    await db.collection('users').doc(id).delete();
                    
                    // Delete doctor profile
                    const profileSnap = await db.collection('doctors').doc(id).get();
                    if (profileSnap.exists) {
                        await profileSnap.ref.delete();
                    }
                    
                    // Delete associated services
                    const servicesSnap = await db.collection('services').where('userId', '==', id).get();
                    const deletePromises = servicesSnap.docs.map(doc => doc.ref.delete());
                    await Promise.all(deletePromises);
                    
                    loadingModal.remove();
                    showToast('âœ… Doctor deleted successfully!', 'success');
                }
                
                loadDoctors();
            } catch (error) {
                console.error('Error deleting doctor:', error);
                loadingModal.remove();
                showToast('âŒ Error deleting doctor: ' + error.message, 'error');
            }
        }
        
        async function loadStaff() {
            try {
                const [staffSnap, allDoctorsSnap] = await Promise.all([
                    db.collection('users').where('role', '==', 'staff').where('clinicId', '==', CLINIC_ID).get(),
                    db.collection('users').where('role', '==', 'doctor').get()
                ]);
                
                // Filter doctors by clinic (check both clinicId and clinicIds)
                allDoctors = allDoctorsSnap.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(d => d.clinicId === CLINIC_ID || (d.clinicIds && d.clinicIds.includes(CLINIC_ID)));
                
                allStaff = staffSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const grid = document.getElementById('staff-grid');
                grid.innerHTML = allStaff.map(staff => {
                    const assignedDoctorNames = (staff.assignedDoctors || [])
                        .map(id => allDoctors.find(d => d.id === id)?.name || 'Unknown')
                        .join(', ');
                    const isActive = staff.active !== false;
                    const assignedCount = (staff.assignedDoctors || []).length;
                    
                    return `
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer hover:shadow-2xl transition-all duration-300 border border-gray-100" onclick="showStaffDetailsModal('${staff.id}')">
                            <!-- Status Badge -->
                            <div class="${isActive ? 'bg-gradient-to-r from-green-500 to-green-600' : 'bg-gradient-to-r from-red-500 to-red-600'} px-4 py-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-white text-xs font-semibold uppercase tracking-wide">
                                        <i class="fas ${isActive ? 'fa-check-circle' : 'fa-times-circle'} mr-1"></i>
                                        ${isActive ? 'Active' : 'Inactive'}
                                    </span>
                                    <span class="text-white text-xs opacity-75">Staff</span>
                                </div>
                            </div>
                            
                            <!-- Card Content -->
                            <div class="p-6">
                                <div class="flex items-start space-x-4 mb-4">
                                    <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl flex items-center justify-center text-2xl shadow-lg flex-shrink-0">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h3 class="text-xl font-bold text-gray-800 mb-1 truncate">${staff.name}</h3>
                                        <p class="text-sm text-gray-600 truncate">
                                            <i class="fas fa-envelope text-gray-400 mr-1"></i>${staff.email}
                                        </p>
                                        <p class="text-sm text-gray-600 mt-1">
                                            <i class="fas fa-phone text-gray-400 mr-1"></i>${staff.phone || 'N/A'}
                                        </p>
                                    </div>
                                </div>
                                
                                <!-- Assigned Doctors Info -->
                                <div class="bg-green-50 border border-green-200 rounded-lg px-3 py-2 mb-4">
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs text-gray-600 font-medium">
                                            <i class="fas fa-user-md text-green-600 mr-1"></i>Assigned Doctors
                                        </span>
                                        <span class="text-xs font-bold text-green-700 bg-green-200 px-2 py-0.5 rounded-full">
                                            ${assignedCount}
                                        </span>
                                    </div>
                                    ${assignedCount > 0 ? `
                                        <p class="text-xs text-gray-600 mt-1 truncate">${assignedDoctorNames}</p>
                                    ` : '<p class="text-xs text-gray-500 mt-1">No doctors assigned</p>'}
                                </div>
                                
                                <button onclick="event.stopPropagation(); deleteStaff('${staff.id}')" class="w-full bg-red-500 text-white px-4 py-2.5 rounded-lg hover:bg-red-600 transition font-semibold shadow-md hover:shadow-lg">
                                    <i class="fas fa-trash mr-2"></i> Delete Staff
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading staff:', error);
                showToast('Error loading staff', 'error');
            }
        }
        
        function filterStaff() {
            const searchTerm = document.getElementById('staff-search').value.toLowerCase().trim();
            const grid = document.getElementById('staff-grid');
            
            const filteredStaff = allStaff.filter(staff => {
                const name = (staff.name || '').toLowerCase();
                const email = (staff.email || '').toLowerCase();
                const position = (staff.position || '').toLowerCase();
                
                return name.includes(searchTerm) || 
                       email.includes(searchTerm) || 
                       position.includes(searchTerm);
            });
            
            if (filteredStaff.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-search text-gray-300 text-6xl mb-4"></i>
                        <p class="text-gray-500 text-lg">No staff found matching "${searchTerm}"</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = filteredStaff.map(staff => {
                const assignedDoctorNames = (staff.assignedDoctors || [])
                    .map(id => allDoctors.find(d => d.id === id)?.name || 'Unknown')
                    .join(', ');
                const isActive = staff.active !== false;
                const assignedCount = (staff.assignedDoctors || []).length;
                
                return `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer hover:shadow-2xl transition-all duration-300 border border-gray-100" onclick="showStaffDetailsModal('${staff.id}')">
                        <!-- Status Badge -->
                        <div class="${isActive ? 'bg-gradient-to-r from-green-500 to-green-600' : 'bg-gradient-to-r from-red-500 to-red-600'} px-4 py-2">
                            <div class="flex items-center justify-between">
                                <span class="text-white text-xs font-semibold uppercase tracking-wide">
                                    <i class="fas ${isActive ? 'fa-check-circle' : 'fa-times-circle'} mr-1"></i>
                                    ${isActive ? 'Active' : 'Inactive'}
                                </span>
                                <span class="text-white text-xs opacity-75">Staff</span>
                            </div>
                        </div>
                        
                        <!-- Card Content -->
                        <div class="p-6">
                            <div class="flex items-start space-x-4 mb-4">
                                <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl flex items-center justify-center text-2xl shadow-lg flex-shrink-0">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-xl font-bold text-gray-800 mb-1 truncate">${staff.name}</h3>
                                    <p class="text-sm text-gray-600 truncate">
                                        <i class="fas fa-envelope text-gray-400 mr-1"></i>${staff.email}
                                    </p>
                                    <p class="text-sm text-gray-600 mt-1">
                                        <i class="fas fa-phone text-gray-400 mr-1"></i>${staff.phone || 'N/A'}
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Assigned Doctors Info -->
                            <div class="bg-green-50 border border-green-200 rounded-lg px-3 py-2 mb-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-600 font-medium">
                                        <i class="fas fa-user-md text-green-600 mr-1"></i>Assigned Doctors
                                    </span>
                                    <span class="text-xs font-bold text-green-700 bg-green-200 px-2 py-0.5 rounded-full">
                                        ${assignedCount}
                                    </span>
                                </div>
                                ${assignedCount > 0 ? `
                                    <p class="text-xs text-gray-600 mt-1 truncate">${assignedDoctorNames}</p>
                                ` : '<p class="text-xs text-gray-500 mt-1">No doctors assigned</p>'}
                            </div>
                            
                            <button onclick="event.stopPropagation(); deleteStaff('${staff.id}')" class="w-full bg-red-500 text-white px-4 py-2.5 rounded-lg hover:bg-red-600 transition font-semibold shadow-md hover:shadow-lg">
                                <i class="fas fa-trash mr-2"></i> Delete Staff
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function showAddStaffModal() {
            // Fetch doctors fresh to ensure we have the latest list
            const doctorsSnap = await db.collection('users').where('role', '==', 'doctor').get();
            const clinicDoctors = doctorsSnap.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .filter(doctor => {
                    if (doctor.clinicId === CLINIC_ID) return true;
                    if (doctor.clinicIds && doctor.clinicIds.includes(CLINIC_ID)) return true;
                    return false;
                });
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Add Staff</h3>
                    <form id="staff-form" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Name *</label>
                            <input type="text" id="staff-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Email *</label>
                            <input type="email" id="staff-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Phone *</label>
                            <input type="tel" id="staff-phone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Password *</label>
                            <input type="password" id="staff-password" required minlength="6" placeholder="Min 6 characters" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Assign to Doctors</label>
                            <select id="staff-doctors" multiple class="w-full px-4 py-2 border border-gray-300 rounded-lg" style="height: 120px;">
                                ${clinicDoctors.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}
                            </select>
                            <p class="text-xs text-gray-500 mt-1">${clinicDoctors.length === 0 ? 'No doctors in this clinic yet' : 'Hold Ctrl/Cmd to select multiple'}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button type="submit" class="flex-1 bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">Save</button>
                            <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            
            document.getElementById('staff-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
                
                try {
                    const name = document.getElementById('staff-name').value;
                    const email = document.getElementById('staff-email').value.toLowerCase();
                    const phone = document.getElementById('staff-phone').value;
                    const password = document.getElementById('staff-password').value;
                    const select = document.getElementById('staff-doctors');
                    const assignedDoctors = Array.from(select.selectedOptions).map(opt => opt.value);
                    
                    // Check if email already exists
                    const existingUser = await db.collection('users')
                        .where('email', '==', email)
                        .get();
                    
                    if (!existingUser.empty) {
                        showToast('This email is already in use', 'error');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        return;
                    }
                    
                    // Create Firestore user document with CLINIC_ID (NO Firebase Auth)
                    await db.collection('users').add({
                        name: name,
                        email: email,
                        password: password, // Store password in database
                        phone: phone,
                        role: 'staff',
                        clinicId: CLINIC_ID, // âœ… THIS CLINIC ONLY
                        assignedDoctors: assignedDoctors,
                        active: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Create contact in GoHighLevel
                    await upsertGHLContact({
                        name: name,
                        email: email,
                        phone: phone,
                        tags: ['Staff']
                    });
                    
                    // Show success message and refresh list - NO LOGOUT, NO RELOAD!
                    showToast(`âœ… Staff "${name}" created for ${CLINIC_NAME}!`, 'success');
                    closeModal();
                    loadStaff(); // Just refresh the staff list
                    
                } catch (error) {
                    console.error('Error adding staff:', error);
                    showToast(error.message || 'Error adding staff', 'error');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            });
        }
        
        async function showStaffDetailsModal(staffId) {
            // Show loading modal
            const loadingModal = document.createElement('div');
            loadingModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-8 flex flex-col items-center space-y-4">
                    <div class="w-16 h-16 border-4 border-green-600 border-t-transparent rounded-full spinner"></div>
                    <p class="text-gray-700 font-semibold text-lg">Loading staff details...</p>
                </div>
            `;
            document.getElementById('modal-container').appendChild(loadingModal);
            
            try {
                // Fetch staff data
                const staffDoc = await db.collection('users').doc(staffId).get();
                const staff = { id: staffDoc.id, ...staffDoc.data() };
                
                // Fetch all doctors for assignment (check both clinicId and clinicIds)
                const allDoctorsSnap = await db.collection('users').where('role', '==', 'doctor').get();
                const doctors = allDoctorsSnap.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(d => d.clinicId === CLINIC_ID || (d.clinicIds && d.clinicIds.includes(CLINIC_ID)));
                
                // Remove loading modal
                loadingModal.remove();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <!-- Header -->
                        <div class="bg-green-600 text-white p-6 rounded-t-xl">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="w-16 h-16 bg-white text-green-600 rounded-full flex items-center justify-center text-2xl">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-2xl font-bold">Staff Details</h3>
                                        <p class="text-green-100 text-sm">Manage staff information</p>
                                    </div>
                                </div>
                                <button onclick="closeModal()" class="text-white hover:text-gray-200 text-2xl">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Content -->
                        <div class="p-6 space-y-6">
                            <!-- Basic Information -->
                            <div>
                                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-info-circle text-green-600 mr-2"></i> Basic Information
                                </h4>
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Name</label>
                                        <input type="text" id="edit-staff-name" value="${staff.name}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Email</label>
                                        <input type="email" id="edit-staff-email" value="${staff.email}" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Phone</label>
                                        <input type="tel" id="edit-staff-phone" value="${staff.phone || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Credentials -->
                            <div>
                                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-key text-green-600 mr-2"></i> Credentials
                                </h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Username</label>
                                        <input type="text" id="edit-staff-username" value="${staff.username || staff.email}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Password</label>
                                        <div class="flex space-x-2">
                                            <div class="flex-1 relative">
                                                <input type="password" id="current-staff-password" value="${staff.password || 'defaultpass123'}" class="w-full px-4 py-2 border border-gray-300 rounded-lg pr-10" readonly>
                                                <button onclick="toggleStaffPasswordVisibility()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                                    <i id="staff-password-eye" class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <button onclick="showStaffChangePasswordForm()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition whitespace-nowrap">
                                                <i class="fas fa-edit mr-2"></i>Change
                                            </button>
                                        </div>
                                    </div>
                                    <div id="staff-change-password-form" class="hidden space-y-3 p-4 bg-gray-50 rounded-lg">
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2 text-sm">New Password</label>
                                            <input type="password" id="staff-new-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Enter new password">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2 text-sm">Confirm Password</label>
                                            <input type="password" id="staff-confirm-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Confirm new password">
                                        </div>
                                        <div class="flex space-x-2">
                                            <button onclick="saveStaffNewPassword('${staffId}')" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">
                                                <i class="fas fa-check mr-2"></i>Save Password
                                            </button>
                                            <button onclick="cancelStaffChangePassword()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Doctor Assignment -->
                            <div>
                                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-user-md text-green-600 mr-2"></i> Assigned Doctors
                                </h4>
                                <div id="assigned-doctors-display" class="border border-gray-300 rounded-lg p-4 mb-3">
                                    ${(staff.assignedDoctors || []).length > 0 ? 
                                        doctors.filter(d => (staff.assignedDoctors || []).includes(d.id))
                                            .map(doctor => `
                                                <div class="flex items-center justify-between p-2 bg-green-50 rounded mb-2">
                                                    <span class="text-gray-700 font-semibold">${doctor.name}</span>
                                                    <i class="fas fa-check text-green-600"></i>
                                                </div>
                                            `).join('') 
                                        : '<p class="text-gray-500 text-sm">No doctors assigned</p>'}
                                </div>
                                <button onclick="showReassignDoctorsModal('${staffId}', ${JSON.stringify(staff.assignedDoctors || []).replace(/"/g, '&quot;')})" class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                                    <i class="fas fa-edit mr-2"></i>Reassign Doctors
                                </button>
                            </div>
                            
                            <!-- Status -->
                            <div>
                                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-toggle-on text-green-600 mr-2"></i> Status
                                </h4>
                                <div class="flex items-center space-x-3">
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="staff-active" ${staff.active !== false ? 'checked' : ''} class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                                    </label>
                                    <span class="text-gray-700 font-semibold" id="staff-status-text">${staff.active !== false ? 'Active' : 'Inactive'}</span>
                                </div>
                            </div>
                            
                            <!-- Admin Notes -->
                            <div>
                                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-sticky-note text-green-600 mr-2"></i> Admin Notes
                                </h4>
                                <textarea id="edit-staff-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Internal notes about this staff member...">${staff.notes || ''}</textarea>
                            </div>
                        </div>
                        
                        <!-- Footer Actions -->
                        <div class="bg-gray-50 p-6 rounded-b-xl flex flex-wrap gap-3">
                            <button onclick="saveStaffChanges('${staffId}')" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
                                <i class="fas fa-save mr-2"></i>Save Changes
                            </button>
                            <button onclick="deleteStaffFromModal('${staffId}')" class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition font-semibold">
                                <i class="fas fa-trash mr-2"></i>Delete
                            </button>
                            <button onclick="closeModal()" class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition font-semibold">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('modal-container').appendChild(modal);
                
                // Store current assigned doctors
                currentStaffAssignedDoctors = staff.assignedDoctors || [];
                
                // Add event listener for active toggle
                document.getElementById('staff-active').addEventListener('change', function() {
                    document.getElementById('staff-status-text').textContent = this.checked ? 'Active' : 'Inactive';
                });
                
            } catch (error) {
                // Remove loading modal on error
                loadingModal.remove();
                console.error('Error loading staff details:', error);
                showToast('Error loading staff details', 'error');
            }
        }
        
        function toggleStaffPasswordVisibility() {
            const passwordInput = document.getElementById('current-staff-password');
            const eyeIcon = document.getElementById('staff-password-eye');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                eyeIcon.className = 'fas fa-eye';
            }
        }
        
        function showStaffChangePasswordForm() {
            document.getElementById('staff-change-password-form').classList.remove('hidden');
        }
        
        function cancelStaffChangePassword() {
            document.getElementById('staff-change-password-form').classList.add('hidden');
            document.getElementById('staff-new-password').value = '';
            document.getElementById('staff-confirm-password').value = '';
        }
        
        async function saveStaffNewPassword(staffId) {
            const newPassword = document.getElementById('staff-new-password').value;
            const confirmPassword = document.getElementById('staff-confirm-password').value;
            
            if (!newPassword || !confirmPassword) {
                showToast('Please fill in both password fields', 'warning');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showToast('Password must be at least 6 characters', 'warning');
                return;
            }
            
            try {
                await db.collection('users').doc(staffId).update({
                    password: newPassword
                });
                
                showToast('Password updated successfully', 'success');
                cancelStaffChangePassword();
                
                // Update the displayed password
                document.getElementById('current-staff-password').value = newPassword;
            } catch (error) {
                console.error('Error updating password:', error);
                showToast('Error updating password', 'error');
            }
        }
        
        async function showReassignDoctorsModal(staffId, currentAssignments) {
            try {
                // Fetch all doctors (check both clinicId and clinicIds)
                const allDoctorsSnap = await db.collection('users').where('role', '==', 'doctor').get();
                const doctors = allDoctorsSnap.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(d => d.clinicId === CLINIC_ID || (d.clinicIds && d.clinicIds.includes(CLINIC_ID)));
                
                const reassignModal = document.createElement('div');
                reassignModal.id = 'reassign-modal';
                reassignModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4';
                reassignModal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                        <div class="bg-blue-500 text-white p-4 rounded-t-xl flex items-center justify-between">
                            <h3 class="text-xl font-bold"><i class="fas fa-user-md mr-2"></i>Reassign Doctors</h3>
                            <button onclick="closeReassignModal()" class="text-white hover:text-gray-200 text-xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="p-6">
                            <p class="text-gray-600 mb-4 text-sm">Select doctors to assign this staff member to:</p>
                            <div class="border border-gray-300 rounded-lg p-4 max-h-96 overflow-y-auto space-y-2">
                                ${doctors.length > 0 ? doctors.map(doctor => `
                                    <label class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded cursor-pointer border border-transparent hover:border-blue-200 transition">
                                        <input type="checkbox" value="${doctor.id}" class="reassign-doctor-checkbox w-5 h-5 text-blue-600 rounded" ${currentStaffAssignedDoctors.includes(doctor.id) ? 'checked' : ''}>
                                        <span class="text-gray-700 font-medium">${doctor.name}</span>
                                    </label>
                                `).join('') : '<p class="text-gray-500 text-sm text-center py-4">No doctors available</p>'}
                            </div>
                            <div class="flex space-x-3 mt-6">
                                <button onclick="saveReassignedDoctors()" class="flex-1 bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 transition font-semibold">
                                    <i class="fas fa-check mr-2"></i>Save
                                </button>
                                <button onclick="closeReassignModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-400 transition font-semibold">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(reassignModal);
            } catch (error) {
                console.error('Error loading reassign modal:', error);
                showToast('Error loading doctors', 'error');
            }
        }
        
        function saveReassignedDoctors() {
            const checkboxes = document.querySelectorAll('.reassign-doctor-checkbox:checked');
            currentStaffAssignedDoctors = Array.from(checkboxes).map(cb => cb.value);
            
            // Update the display in the main modal
            const displayDiv = document.getElementById('assigned-doctors-display');
            if (currentStaffAssignedDoctors.length > 0) {
                // Fetch doctor names from the checkboxes
                const assignedNames = Array.from(checkboxes).map(cb => {
                    const label = cb.closest('label');
                    return label.querySelector('span').textContent;
                });
                
                displayDiv.innerHTML = assignedNames.map(name => `
                    <div class="flex items-center justify-between p-2 bg-green-50 rounded mb-2">
                        <span class="text-gray-700 font-semibold">${name}</span>
                        <i class="fas fa-check text-green-600"></i>
                    </div>
                `).join('');
            } else {
                displayDiv.innerHTML = '<p class="text-gray-500 text-sm">No doctors assigned</p>';
            }
            
            showToast('Doctor assignments updated (click Save Changes to confirm)', 'info');
            closeReassignModal();
        }
        
        function closeReassignModal() {
            const modal = document.getElementById('reassign-modal');
            if (modal) modal.remove();
        }
        
        async function saveStaffChanges(staffId) {
            try {
                const name = document.getElementById('edit-staff-name').value;
                const phone = document.getElementById('edit-staff-phone').value;
                const username = document.getElementById('edit-staff-username').value;
                const notes = document.getElementById('edit-staff-notes').value;
                const active = document.getElementById('staff-active').checked;
                
                if (!name || !phone) {
                    showToast('Name and phone are required', 'warning');
                    return;
                }
                
                // Update user document
                await db.collection('users').doc(staffId).update({
                    name: name,
                    phone: phone,
                    username: username,
                    assignedDoctors: currentStaffAssignedDoctors,
                    notes: notes,
                    active: active
                });
                
                showToast('Staff updated successfully', 'success');
                closeModal();
                loadStaff();
            } catch (error) {
                console.error('Error saving staff changes:', error);
                showToast('Error saving changes', 'error');
            }
        }
        
        async function deleteStaffFromModal(staffId) {
            const confirmed = await showConfirmDialog(
                'Delete Staff Member',
                'Are you sure you want to delete this staff member?',
                'Delete',
                'Cancel'
            );
            
            if (!confirmed) return;
            
            closeModal(); // Close details modal first
            
            // Show loading spinner
            const loadingModal = document.createElement('div');
            loadingModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-8 flex flex-col items-center space-y-4">
                    <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                    <p class="text-gray-700 font-semibold text-lg">Deleting staff member...</p>
                </div>
            `;
            document.body.appendChild(loadingModal);
            
            try {
                await db.collection('users').doc(staffId).delete();
                loadingModal.remove();
                showToast('âœ… Staff member deleted successfully!', 'success');
                loadStaff();
            } catch (error) {
                console.error('Error deleting staff:', error);
                loadingModal.remove();
                showToast('âŒ Error deleting staff: ' + error.message, 'error');
            }
        }
        
        async function deleteStaff(id) {
            const confirmed = await showConfirmDialog(
                'Delete Staff Member',
                'Are you sure you want to delete this staff member?',
                'Delete',
                'Cancel'
            );
            
            if (!confirmed) return;
            
            // Show loading spinner
            const loadingModal = document.createElement('div');
            loadingModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-8 flex flex-col items-center space-y-4">
                    <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                    <p class="text-gray-700 font-semibold text-lg">Deleting staff member...</p>
                </div>
            `;
            document.body.appendChild(loadingModal);
            
            try {
                await db.collection('users').doc(id).delete();
                loadingModal.remove();
                showToast('âœ… Staff member deleted successfully!', 'success');
                loadStaff();
            } catch (error) {
                console.error('Error deleting staff:', error);
                loadingModal.remove();
                showToast('âŒ Error deleting staff: ' + error.message, 'error');
            }
        }
        
        async function checkAndUpdateExpiredAppointments() {
            try {
                // Get today's date in YYYY-MM-DD format
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStr = today.toISOString().split('T')[0];
                
                // Find appointments that are past due and not completed/cancelled/missed
                const expiredAppointments = allAppointments.filter(apt => {
                    return apt.date < todayStr && 
                           apt.status !== 'completed' && 
                           apt.status !== 'cancelled' &&
                           apt.status !== 'missed';
                });
                
                if (expiredAppointments.length > 0) {
                    // Batch update to 'missed' status
                    const batch = db.batch();
                    expiredAppointments.forEach(apt => {
                        const docRef = db.collection('appointments').doc(apt.id);
                        batch.update(docRef, { status: 'missed' });
                        // Update local array
                        apt.status = 'missed';
                    });
                    
                    await batch.commit();
                    console.log(`Updated ${expiredAppointments.length} expired appointments to 'missed' status`);
                }
            } catch (error) {
                console.error('Error updating expired appointments:', error);
            }
        }
        
        // ============================================
        // GLOBAL SERVICES MANAGEMENT
        // ============================================
        
        // Service category mappings
        const serviceCategories = {
            'Consultation': { icon: 'fa-stethoscope', color: 'blue', gradient: 'from-blue-500 to-blue-600' },
            'Dental': { icon: 'fa-tooth', color: 'cyan', gradient: 'from-cyan-500 to-cyan-600' },
            'Procedure': { icon: 'fa-syringe', color: 'purple', gradient: 'from-purple-500 to-purple-600' },
            'Follow-up': { icon: 'fa-calendar-check', color: 'green', gradient: 'from-green-500 to-green-600' },
            'Surgery': { icon: 'fa-user-md', color: 'red', gradient: 'from-red-500 to-red-600' },
            'Therapy': { icon: 'fa-heartbeat', color: 'pink', gradient: 'from-pink-500 to-pink-600' },
            'General Checkup': { icon: 'fa-clipboard-check', color: 'indigo', gradient: 'from-indigo-500 to-indigo-600' },
            'Emergency': { icon: 'fa-ambulance', color: 'orange', gradient: 'from-orange-500 to-orange-600' }
        };
        
        function getCategoryIcon(category) {
            return serviceCategories[category]?.icon || 'fa-briefcase-medical';
        }
        
        function getCategoryGradient(category) {
            return serviceCategories[category]?.gradient || 'from-gray-500 to-gray-600';
        }
        
        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }
        
        function formatPrice(price, currency = 'SAR') {
            if (!price) return 'Free';
            const symbols = { SAR: 'SR', USD: '$', EUR: 'â‚¬', GBP: 'Â£', AED: 'AED' };
            return `${symbols[currency] || 'SR'} ${price}`;
        }
        
        async function loadGlobalServices() {
            try {
                const snapshot = await db.collection('globalServices').get();
                allGlobalServices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const grid = document.getElementById('global-services-grid');
                const services = allGlobalServices;
                if (services.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <i class="fas fa-briefcase-medical text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 text-lg">${t('No global services yet. Add your first service!')}</p>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = services.map(service => {
                    const icon = getCategoryIcon(service.category);
                    const gradient = getCategoryGradient(service.category);
                    const description = truncateText(service.description, 80);
                    const price = formatPrice(service.price, service.currency);
                    const isActive = service.isActive !== false;
                    const translatedCategory = t(service.category);
                    
                    return `
                        <div class="bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden cursor-pointer transform hover:scale-105" onclick="viewGlobalServiceDetails('${service.id}')">
                            <!-- Header with gradient -->
                            <div class="bg-gradient-to-r ${gradient} p-4 text-white relative">
                                <div class="flex items-center justify-between">
                                    <i class="fas ${icon} text-4xl opacity-90"></i>
                                    <div class="flex space-x-2">
                                        <button onclick="event.stopPropagation(); showEditGlobalServiceModal('${service.id}')" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded-lg transition" title="${t('Edit')}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="event.stopPropagation(); deleteGlobalService('${service.id}')" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded-lg transition" title="${t('Delete')}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Content -->
                            <div class="p-6">
                                <h3 class="text-xl font-bold text-gray-800 mb-2">${service.name}</h3>
                                <div class="flex items-center text-sm text-gray-600 mb-3 space-x-3">
                                    <span><i class="fas fa-folder mr-1"></i>${translatedCategory}</span>
                                    <span><i class="fas fa-clock mr-1"></i>${service.duration} ${t('minutes')}</span>
                                    <span class="font-semibold text-primary">${price}</span>
                                </div>
                                
                                ${description ? `<p class="text-gray-600 text-sm mb-4 line-clamp-2">${description}</p>` : `<p class="text-gray-400 text-sm mb-4 italic">${t('No description')}</p>`}
                                
                                <div class="flex items-center justify-between pt-4 border-t">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                        <i class="fas fa-circle text-xs mr-1"></i>
                                        ${isActive ? t('Active') : t('Inactive')}
                                    </span>
                                    <span class="text-primary text-sm font-semibold">
                                        ${t('View Details')} <i class="fas fa-arrow-right ml-1"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading global services:', error);
                showToast('Error loading global services', 'error');
            }
        }
        
        function filterGlobalServices() {
            const searchTerm = document.getElementById('globalservice-search').value.toLowerCase().trim();
            const grid = document.getElementById('global-services-grid');
            
            const filteredServices = allGlobalServices.filter(service => {
                const name = (service.name || '').toLowerCase();
                const description = (service.description || '').toLowerCase();
                const category = (service.category || '').toLowerCase();
                
                return name.includes(searchTerm) || 
                       description.includes(searchTerm) || 
                       category.includes(searchTerm);
            });
            
            if (filteredServices.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-search text-gray-300 text-6xl mb-4"></i>
                        <p class="text-gray-500 text-lg">No services found matching "${searchTerm}"</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = filteredServices.map(service => {
                const icon = getCategoryIcon(service.category);
                const gradient = getCategoryGradient(service.category);
                const description = truncateText(service.description, 80);
                const price = formatPrice(service.price, service.currency);
                const isActive = service.isActive !== false;
                const translatedCategory = t(service.category);
                
                return `
                    <div class="bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden cursor-pointer transform hover:scale-105" onclick="viewGlobalServiceDetails('${service.id}')">
                        <!-- Header with gradient -->
                        <div class="bg-gradient-to-r ${gradient} p-4 text-white relative">
                            <div class="flex items-center justify-between">
                                <i class="fas ${icon} text-4xl opacity-90"></i>
                                <div class="flex space-x-2">
                                    <button onclick="event.stopPropagation(); showEditGlobalServiceModal('${service.id}')" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded-lg transition" title="${t('Edit')}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="event.stopPropagation(); deleteGlobalService('${service.id}')" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded-lg transition" title="${t('Delete')}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Content -->
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${service.name}</h3>
                            <div class="flex items-center text-sm text-gray-600 mb-3 space-x-3">
                                <span><i class="fas fa-folder mr-1"></i>${translatedCategory}</span>
                                <span><i class="fas fa-clock mr-1"></i>${service.duration} ${t('minutes')}</span>
                                <span class="font-semibold text-primary">${price}</span>
                            </div>
                            
                            ${description ? `<p class="text-gray-600 text-sm mb-4 line-clamp-2">${description}</p>` : `<p class="text-gray-400 text-sm mb-4 italic">${t('No description')}</p>`}
                            
                            <div class="flex items-center justify-between pt-4 border-t">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                    <i class="fas fa-circle text-xs mr-1"></i>
                                    ${isActive ? t('Active') : t('Inactive')}
                                </span>
                                <span class="text-primary text-sm font-semibold">
                                    ${t('View Details')} <i class="fas fa-arrow-right ml-1"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function showAddGlobalServiceModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">${t('Add Global Service')}</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    <form id="global-service-form" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-gray-700 font-semibold mb-2">${t('Service Name')} *</label>
                                <input type="text" id="gs-name" required placeholder="${t('e.g., Dental Cleaning')}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">${t('Category')} *</label>
                                <select id="gs-category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                    <option value="">${t('Select Category')}</option>
                                    <option value="Consultation">ðŸ©º ${t('Consultation')}</option>
                                    <option value="Dental">ðŸ¦· ${t('Dental')}</option>
                                    <option value="Procedure">ðŸ’‰ ${t('Procedure')}</option>
                                    <option value="Follow-up">ðŸ“… ${t('Follow-up')}</option>
                                    <option value="Surgery">ðŸ‘¨â€âš•ï¸ ${t('Surgery')}</option>
                                    <option value="Therapy">â¤ï¸ ${t('Therapy')}</option>
                                    <option value="General Checkup">ðŸ“‹ ${t('General Checkup')}</option>
                                    <option value="Emergency">ðŸš‘ ${t('Emergency')}</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">${t('Duration (minutes)')} *</label>
                                <input type="number" id="gs-duration" required value="30" min="5" max="480" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">${t('Price')}</label>
                                <input type="number" id="gs-price" placeholder="0.00" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">${t('Currency')}</label>
                                <select id="gs-currency" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                    <option value="SAR" selected>${t('SR Saudi Riyal')}</option>
                                    <option value="AED">${t('AED UAE Dirham')}</option>
                                    <option value="USD">${t('$ USD')}</option>
                                    <option value="EUR">${t('â‚¬ EUR')}</option>
                                    <option value="GBP">${t('Â£ GBP')}</option>
                                </select>
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-gray-700 font-semibold mb-2">${t('Description')}</label>
                                <textarea id="gs-description" rows="3" placeholder="${t('Brief description of the service...')}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"></textarea>
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" id="gs-active" checked class="w-5 h-5 text-primary rounded focus:ring-2 focus:ring-primary">
                                    <span class="text-gray-700 font-semibold">${t('Active (available for doctors)')}</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2 pt-4 border-t">
                            <button type="submit" class="flex-1 bg-gradient-to-r from-primary to-blue-600 text-white px-6 py-3 rounded-lg hover:from-blue-600 hover:to-blue-700 transition font-semibold shadow-md">
                                <i class="fas fa-save mr-2"></i>${t('Save Service')}
                            </button>
                            <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition font-semibold">
                                ${t('Cancel')}
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            
            document.getElementById('global-service-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Checking...';
                
                try {
                    const serviceName = document.getElementById('gs-name').value.trim();
                    
                    // Check for duplicate service name
                    const duplicateCheck = await db.collection('globalServices')
                        .where('name', '==', serviceName)
                        .get();
                    
                    if (!duplicateCheck.empty) {
                        showToast('âš ï¸ Duplicate service already exists with this name!', 'error');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        return;
                    }
                    
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
                    
                    const serviceData = {
                        name: serviceName,
                        category: document.getElementById('gs-category').value,
                        duration: parseInt(document.getElementById('gs-duration').value),
                        price: parseFloat(document.getElementById('gs-price').value) || 0,
                        currency: document.getElementById('gs-currency').value,
                        description: document.getElementById('gs-description').value || '',
                        isActive: document.getElementById('gs-active').checked,
                        createdBy: 'superadmin',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    await db.collection('globalServices').add(serviceData);
                    showToast('âœ… Global service added successfully!', 'success');
                    closeModal();
                    loadGlobalServices();
                } catch (error) {
                    console.error('Error adding global service:', error);
                    showToast('Error adding global service', 'error');
                }
            });
        }
        
        async function viewGlobalServiceDetails(serviceId) {
            try {
                const doc = await db.collection('globalServices').doc(serviceId).get();
                if (!doc.exists) {
                    showToast('Service not found', 'error');
                    return;
                }
                
                const service = { id: doc.id, ...doc.data() };
                const icon = getCategoryIcon(service.category);
                const gradient = getCategoryGradient(service.category);
                const price = formatPrice(service.price, service.currency);
                const isActive = service.isActive !== false;
                const createdAt = service.createdAt ? service.createdAt.toDate().toLocaleString() : 'N/A';
                const updatedAt = service.updatedAt ? service.updatedAt.toDate().toLocaleString() : 'N/A';
                const translatedCategory = t(service.category);
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <!-- Header -->
                        <div class="bg-gradient-to-r ${gradient} p-6 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-4">
                                    <i class="fas ${icon} text-5xl opacity-90"></i>
                                    <div>
                                        <h3 class="text-2xl font-bold">${service.name}</h3>
                                        <p class="text-sm opacity-90">${translatedCategory}</p>
                                    </div>
                                </div>
                                <button onclick="closeModal()" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition">
                                    <i class="fas fa-times text-2xl"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Content -->
                        <div class="p-6 space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="bg-blue-50 rounded-lg p-4">
                                    <p class="text-sm text-gray-600 mb-1">${t('Duration (minutes)')}</p>
                                    <p class="text-2xl font-bold text-primary">
                                        <i class="fas fa-clock mr-2"></i>${service.duration} ${t('minutes')}
                                    </p>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4">
                                    <p class="text-sm text-gray-600 mb-1">${t('Price')}</p>
                                    <p class="text-2xl font-bold text-green-600">
                                        <i class="fas fa-dollar-sign mr-2"></i>${price}
                                    </p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-2 font-semibold">${t('Description')}</p>
                                <p class="text-gray-700">${service.description || t('No description provided')}</p>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-2 font-semibold">${t('Status')}</p>
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold ${isActive ? 'bg-green-100 text-green-800' : 'bg-gray-200 text-gray-800'}">
                                    <i class="fas fa-circle text-xs mr-2"></i>
                                    ${isActive ? t('Active - Available for doctors') : t('Inactive')}
                                </span>
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-4 text-sm text-gray-600">
                                <div>
                                    <p class="font-semibold mb-1">${t('Created')}</p>
                                    <p>${createdAt}</p>
                                </div>
                                <div>
                                    <p class="font-semibold mb-1">${t('Last Updated')}</p>
                                    <p>${updatedAt}</p>
                                </div>
                            </div>
                            
                            <div class="flex space-x-2 pt-4 border-t">
                                <button onclick="closeModal(); showEditGlobalServiceModal('${service.id}')" class="flex-1 bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
                                    <i class="fas fa-edit mr-2"></i>${t('Edit Service')}
                                </button>
                                <button onclick="closeModal(); deleteGlobalService('${service.id}')" class="flex-1 bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition font-semibold">
                                    <i class="fas fa-trash mr-2"></i>${t('Delete')}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('modal-container').appendChild(modal);
            } catch (error) {
                console.error('Error viewing service:', error);
                showToast('Error loading service details', 'error');
            }
        }
        
        async function showEditGlobalServiceModal(serviceId) {
            try {
                const doc = await db.collection('globalServices').doc(serviceId).get();
                if (!doc.exists) {
                    showToast('Service not found', 'error');
                    return;
                }
                
                const service = doc.data();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">${t('Edit Global Service')}</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        <form id="edit-global-service-form" class="space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-gray-700 font-semibold mb-2">${t('Service Name')} *</label>
                                    <input type="text" id="edit-gs-name" required value="${service.name}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">${t('Category')} *</label>
                                    <select id="edit-gs-category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                        <option value="Consultation" ${service.category === 'Consultation' ? 'selected' : ''}>ðŸ©º ${t('Consultation')}</option>
                                        <option value="Dental" ${service.category === 'Dental' ? 'selected' : ''}>ðŸ¦· ${t('Dental')}</option>
                                        <option value="Procedure" ${service.category === 'Procedure' ? 'selected' : ''}>ðŸ’‰ ${t('Procedure')}</option>
                                        <option value="Follow-up" ${service.category === 'Follow-up' ? 'selected' : ''}>ðŸ“… ${t('Follow-up')}</option>
                                        <option value="Surgery" ${service.category === 'Surgery' ? 'selected' : ''}>ðŸ‘¨â€âš•ï¸ ${t('Surgery')}</option>
                                        <option value="Therapy" ${service.category === 'Therapy' ? 'selected' : ''}>â¤ï¸ ${t('Therapy')}</option>
                                        <option value="General Checkup" ${service.category === 'General Checkup' ? 'selected' : ''}>ðŸ“‹ ${t('General Checkup')}</option>
                                        <option value="Emergency" ${service.category === 'Emergency' ? 'selected' : ''}>ðŸš‘ ${t('Emergency')}</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">${t('Duration (minutes)')} *</label>
                                    <input type="number" id="edit-gs-duration" required value="${service.duration}" min="5" max="480" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">${t('Price')}</label>
                                    <input type="number" id="edit-gs-price" value="${service.price || ''}" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">${t('Currency')}</label>
                                    <select id="edit-gs-currency" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                        <option value="SAR" ${service.currency === 'SAR' ? 'selected' : ''}>${t('SR Saudi Riyal')}</option>
                                        <option value="AED" ${service.currency === 'AED' ? 'selected' : ''}>${t('AED UAE Dirham')}</option>
                                        <option value="USD" ${service.currency === 'USD' ? 'selected' : ''}>${t('$ USD')}</option>
                                        <option value="EUR" ${service.currency === 'EUR' ? 'selected' : ''}>${t('â‚¬ EUR')}</option>
                                        <option value="GBP" ${service.currency === 'GBP' ? 'selected' : ''}>${t('Â£ GBP')}</option>
                                    </select>
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label class="block text-gray-700 font-semibold mb-2">${t('Description')}</label>
                                    <textarea id="edit-gs-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">${service.description || ''}</textarea>
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="checkbox" id="edit-gs-active" ${service.isActive !== false ? 'checked' : ''} class="w-5 h-5 text-primary rounded focus:ring-2 focus:ring-primary">
                                        <span class="text-gray-700 font-semibold">${t('Active (available for doctors)')}</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex space-x-2 pt-4 border-t">
                                <button type="submit" class="flex-1 bg-gradient-to-r from-primary to-blue-600 text-white px-6 py-3 rounded-lg hover:from-blue-600 hover:to-blue-700 transition font-semibold shadow-md">
                                    <i class="fas fa-save mr-2"></i>${t('Update Service')}
                                </button>
                                <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition font-semibold">
                                    ${t('Cancel')}
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                document.getElementById('modal-container').appendChild(modal);
                
                document.getElementById('edit-global-service-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    try {
                        const updateData = {
                            name: document.getElementById('edit-gs-name').value,
                            category: document.getElementById('edit-gs-category').value,
                            duration: parseInt(document.getElementById('edit-gs-duration').value),
                            price: parseFloat(document.getElementById('edit-gs-price').value) || 0,
                            currency: document.getElementById('edit-gs-currency').value,
                            description: document.getElementById('edit-gs-description').value || '',
                            isActive: document.getElementById('edit-gs-active').checked,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        await db.collection('globalServices').doc(serviceId).update(updateData);
                        showToast('Global service updated successfully', 'success');
                        closeModal();
                        loadGlobalServices();
                    } catch (error) {
                        console.error('Error updating global service:', error);
                        showToast('Error updating global service', 'error');
                    }
                });
            } catch (error) {
                console.error('Error loading service:', error);
                showToast('Error loading service', 'error');
            }
        }
        
        async function deleteGlobalService(id) {
            const confirmed = confirm('Are you sure you want to delete this global service? This will not affect services already added by doctors.');
            if (!confirmed) return;
            
            try {
                await db.collection('globalServices').doc(id).delete();
                showToast('Global service deleted successfully', 'success');
                closeModal();
                loadGlobalServices();
            } catch (error) {
                console.error('Error deleting global service:', error);
                showToast('Error deleting global service', 'error');
            }
        }
        
        let appointmentDateRangePicker;
        
        async function loadAppointments() {
            try {
                const [appointmentsSnap, allDoctorsSnap] = await Promise.all([
                    db.collection('appointments').where('clinicId', '==', CLINIC_ID).get(),
                    db.collection('users').where('role', '==', 'doctor').get()
                ]);
                
                allAppointments = appointmentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Filter doctors by clinic (check both clinicId and clinicIds)
                allDoctors = allDoctorsSnap.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(d => d.clinicId === CLINIC_ID || (d.clinicIds && d.clinicIds.includes(CLINIC_ID)));
                
                // Check and update expired appointments to 'missed'
                await checkAndUpdateExpiredAppointments();
                
                const doctorFilter = document.getElementById('filter-doctor');
                doctorFilter.innerHTML = '<option value="">All Doctors</option>' + 
                    allDoctors.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                
                // Populate calendar doctor filter
                const calendarDoctorFilter = document.getElementById('calendar-doctor-filter');
                if (calendarDoctorFilter) {
                    calendarDoctorFilter.innerHTML = '<option value="">All Doctors</option>' + 
                        allDoctors.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                }
                
                // Initialize date range picker for appointments
                initializeAppointmentDateRangePicker();
                
                filterAppointments();
            } catch (error) {
                console.error('Error loading appointments:', error);
                showToast('Error loading appointments', 'error');
            }
        }
        
        function initializeAppointmentDateRangePicker() {
            appointmentDateRangePicker = flatpickr("#filter-date-range", {
                mode: "range",
                dateFormat: "M d, Y",
                showMonths: 2,
                onChange: function(selectedDates, dateStr, instance) {
                    filterAppointments();
                },
                onReady: function(selectedDates, dateStr, instance) {
                    instance.calendarContainer.classList.add('analytics-calendar');
                }
            });
        }
        
        function filterAppointments() {
            const statusFilter = document.getElementById('filter-status').value;
            const doctorFilter = document.getElementById('filter-doctor').value;
            
            let filtered = allAppointments;
            
            if (statusFilter) filtered = filtered.filter(a => a.status === statusFilter);
            if (doctorFilter) filtered = filtered.filter(a => a.doctorId === doctorFilter);
            
            // Date range filter
            if (appointmentDateRangePicker && appointmentDateRangePicker.selectedDates.length === 2) {
                const fromDate = appointmentDateRangePicker.selectedDates[0];
                const toDate = appointmentDateRangePicker.selectedDates[1];
                filtered = filtered.filter(a => {
                    const aptDate = new Date(a.date);
                    return aptDate >= fromDate && aptDate <= toDate;
                });
            }
            
            const tbody = document.getElementById('appointments-table');
            tbody.innerHTML = filtered.map(apt => {
                const doctor = allDoctors.find(d => d.id === apt.doctorId);
                return `
                    <tr class="hover:bg-gray-50 cursor-pointer" onclick="viewAppointment('${apt.id}')">
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-xs font-semibold bg-blue-100 text-blue-800">Appointment</span>
                        </td>
                        <td class="px-6 py-4">
                            <p class="font-semibold text-gray-800">${apt.patientName}</p>
                            <p class="text-sm text-gray-600">${apt.patientPhone}</p>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">${doctor ? doctor.name : 'N/A'}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">
                            <div>${apt.date}</div>
                            <div class="font-semibold">${apt.startTime || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${getStatusColor(apt.status)}">${apt.status.toUpperCase()}</span>
                        </td>
                        <td class="px-6 py-4" onclick="event.stopPropagation()">
                            <button onclick="deleteAppointment('${apt.id}')" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function clearFilters() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-doctor').value = '';
            if (appointmentDateRangePicker) {
                appointmentDateRangePicker.clear();
            }
            filterAppointments();
        }
        
        async function deleteAppointment(id) {
            const confirmed = await showConfirmDialog(
                'Delete Appointment',
                'Are you sure you want to delete this appointment?',
                'Delete',
                'Cancel'
            );
            
            if (!confirmed) return;
            
            try {
                await db.collection('appointments').doc(id).delete();
                showToast('Appointment deleted', 'success');
                loadAppointments();
            } catch (error) {
                console.error('Error deleting appointment:', error);
                showToast('Error deleting appointment', 'error');
            }
        }
        
        async function viewAppointment(id) {
            // Show loading modal
            const loadingModal = document.createElement('div');
            loadingModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingModal.innerHTML = `
                <div class="bg-white rounded-xl p-8 text-center">
                    <i class="fas fa-spinner fa-spin text-primary text-4xl mb-4"></i>
                    <p class="text-gray-700 font-semibold">Loading appointment details...</p>
                </div>
            `;
            document.getElementById('modal-container').appendChild(loadingModal);
            
            try {
                const aptDoc = await db.collection('appointments').doc(id).get();
                if (!aptDoc.exists) {
                    showToast('Appointment not found', 'error');
                    return;
                }
                
                const apt = { id: aptDoc.id, ...aptDoc.data() };
                const doctor = allDoctors.find(d => d.id === apt.doctorId);
                
                // Handle different time field formats
                const startTime = apt.startTime || apt.time || apt.slot || 'N/A';
                const endTime = apt.endTime || 'N/A';
                let duration = apt.duration || null;
                
                // Get service info if available
                let serviceInfo = '';
                let serviceDuration = null;
                
                // Check if serviceId exists (new format with linked services)
                if (apt.serviceId) {
                    try {
                        const serviceDoc = await db.collection('services').doc(apt.serviceId).get();
                        if (serviceDoc.exists) {
                            const service = serviceDoc.data();
                            serviceDuration = service.duration;
                            const priceText = service.price ? `${service.currency || 'SAR'} ${service.price}` : 'Free';
                            serviceInfo = `
                                <div class="bg-blue-50 rounded-lg p-4 mb-4">
                                    <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                                        <i class="fas fa-briefcase-medical text-primary mr-2"></i>Service Details
                                    </h4>
                                    <p class="text-sm text-gray-700"><strong>Service:</strong> ${service.name}</p>
                                    <p class="text-sm text-gray-700"><strong>Category:</strong> ${service.category}</p>
                                    <p class="text-sm text-gray-700"><strong>Duration:</strong> ${service.duration} minutes</p>
                                    <p class="text-sm text-gray-700"><strong>Price:</strong> ${priceText}</p>
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error('Error loading service:', error);
                    }
                }
                // If no serviceId but has service name (old format from booking form)
                else if (apt.service || apt.patientService) {
                    const serviceName = apt.service || apt.patientService;
                    serviceInfo = `
                        <div class="bg-blue-50 rounded-lg p-4 mb-4">
                            <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                                <i class="fas fa-briefcase-medical text-primary mr-2"></i>Service Requested
                            </h4>
                            <p class="text-sm text-gray-700">${serviceName}</p>
                            <p class="text-xs text-gray-500 mt-1"><em>Note: Duration not available for this booking</em></p>
                        </div>
                    `;
                }
                
                // Use service duration if appointment duration is not set
                if (!duration && serviceDuration) {
                    duration = serviceDuration;
                }
                
                // Calculate end time if we have start time and duration
                let calculatedEndTime = endTime;
                if (startTime !== 'N/A' && duration && endTime === 'N/A') {
                    try {
                        const [hours, minutes] = startTime.split(':');
                        const startDate = new Date();
                        startDate.setHours(parseInt(hours), parseInt(minutes), 0);
                        startDate.setMinutes(startDate.getMinutes() + parseInt(duration));
                        calculatedEndTime = startDate.toTimeString().slice(0, 5);
                    } catch (error) {
                        console.error('Error calculating end time:', error);
                    }
                }
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="bg-gradient-to-r from-primary to-blue-600 text-white p-6 rounded-t-xl">
                            <div class="flex items-center justify-between">
                                <h3 class="text-2xl font-bold flex items-center">
                                    <i class="fas fa-calendar-check mr-3"></i>Appointment Details
                                </h3>
                                <button onclick="closeModal()" class="text-white hover:text-gray-200 text-2xl">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid md:grid-cols-2 gap-4 mb-4">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                        <i class="fas fa-user text-primary mr-2"></i>Patient Information
                                    </h4>
                                    <p class="text-sm text-gray-700 mb-1"><strong>Name:</strong> ${apt.patientName}</p>
                                    <p class="text-sm text-gray-700 mb-1"><strong>Phone:</strong> ${apt.patientPhone || 'N/A'}</p>
                                    <p class="text-sm text-gray-700"><strong>Email:</strong> ${apt.patientEmail || 'N/A'}</p>
                                </div>
                                
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                        <i class="fas fa-user-md text-primary mr-2"></i>Doctor Information
                                    </h4>
                                    <p class="text-sm text-gray-700 mb-1"><strong>Doctor:</strong> ${doctor ? doctor.name : 'Unknown'}</p>
                                    <p class="text-sm text-gray-700"><strong>Email:</strong> ${doctor ? doctor.email : 'N/A'}</p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-clock text-primary mr-2"></i>Appointment Schedule
                                </h4>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <p class="text-sm text-gray-700"><strong>Date:</strong> ${apt.date}</p>
                                    <p class="text-sm text-gray-700"><strong>Time:</strong> ${startTime} - ${calculatedEndTime}</p>
                                    <p class="text-sm text-gray-700"><strong>Duration:</strong> ${duration || 'N/A'} min</p>
                                </div>
                            </div>
                            
                            ${serviceInfo}
                            
                            ${apt.symptoms ? `
                                <div class="bg-yellow-50 rounded-lg p-4 mb-4">
                                    <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                                        <i class="fas fa-notes-medical text-yellow-600 mr-2"></i>Symptoms / Reason
                                    </h4>
                                    <p class="text-sm text-gray-700">${apt.symptoms}</p>
                                </div>
                            ` : ''}
                            
                            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                                    <i class="fas fa-info-circle text-primary mr-2"></i>Status Information
                                </h4>
                                <div class="flex items-center space-x-4">
                                    <span class="px-3 py-1 rounded-full text-sm font-semibold ${getStatusColor(apt.status)}">${apt.status.toUpperCase()}</span>
                                    ${apt.checkedIn ? '<span class="text-green-600 text-sm"><i class="fas fa-check-circle mr-1"></i>Checked In</span>' : '<span class="text-gray-500 text-sm"><i class="fas fa-times-circle mr-1"></i>Not Checked In</span>'}
                                </div>
                            </div>
                            
                            ${(() => {
                                // Handle notes - could be array, string, or undefined
                                if (!apt.notes) return '';
                                
                                // If notes is an array
                                if (Array.isArray(apt.notes) && apt.notes.length > 0) {
                                    return `
                                        <div class="bg-purple-50 rounded-lg p-4">
                                            <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                                                <i class="fas fa-sticky-note text-purple-600 mr-2"></i>Notes
                                            </h4>
                                            <div class="space-y-2">
                                                ${apt.notes.map(note => `
                                                    <div class="bg-white p-2 rounded text-sm text-gray-700">
                                                        <p class="font-semibold">${note.author || 'Staff'} - ${note.timestamp ? new Date(note.timestamp).toLocaleString() : ''}</p>
                                                        <p>${note.text}</p>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                // If notes is a string
                                if (typeof apt.notes === 'string' && apt.notes.trim()) {
                                    return `
                                        <div class="bg-purple-50 rounded-lg p-4">
                                            <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                                                <i class="fas fa-sticky-note text-purple-600 mr-2"></i>Notes
                                            </h4>
                                            <div class="bg-white p-3 rounded text-sm text-gray-700">
                                                ${apt.notes}
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                return '';
                            })()}
                        </div>
                        
                        <div class="bg-gray-50 p-6 rounded-b-xl flex justify-end space-x-3">
                            <button onclick="closeModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition font-semibold">
                                Close
                            </button>
                            <button onclick="closeModal(); deleteAppointment('${apt.id}')" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition font-semibold">
                                <i class="fas fa-trash mr-2"></i>Delete
                            </button>
                        </div>
                    </div>
                `;
                
                // Remove loading modal and show appointment modal
                loadingModal.remove();
                document.getElementById('modal-container').appendChild(modal);
            } catch (error) {
                console.error('Error viewing appointment:', error);
                loadingModal.remove();
                showToast('Error loading appointment details', 'error');
            }
        }
        
        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
        }
        
        // Modern confirmation dialog
        function showConfirmDialog(title, message, confirmText = 'Confirm', cancelText = 'Cancel') {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all">
                        <div class="text-center">
                            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                                <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">${title}</h3>
                            <p class="text-gray-600 mb-6">${message}</p>
                        </div>
                        <div class="flex space-x-3">
                            <button id="confirm-cancel" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition font-semibold">
                                ${cancelText}
                            </button>
                            <button id="confirm-ok" class="flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-lg hover:from-red-600 hover:to-red-700 transition font-semibold shadow-md">
                                ${confirmText}
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('modal-container').appendChild(modal);
                
                document.getElementById('confirm-ok').onclick = () => {
                    modal.remove();
                    resolve(true);
                };
                
                document.getElementById('confirm-cancel').onclick = () => {
                    modal.remove();
                    resolve(false);
                };
            });
        }
        
        // Analytics Functions
        let analyticsData = {};
        let dateRangePicker;
        
        async function loadAnalytics() {
            try {
                // Fetch all appointments and doctors (from THIS clinic)
                const [appointmentsSnap, allDoctorsSnap] = await Promise.all([
                    db.collection('appointments').where('clinicId', '==', CLINIC_ID).get(),
                    db.collection('users').where('role', '==', 'doctor').get()
                ]);
                
                allAppointments = appointmentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Filter doctors by clinic (check both clinicId and clinicIds)
                allDoctors = allDoctorsSnap.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(d => d.clinicId === CLINIC_ID || (d.clinicIds && d.clinicIds.includes(CLINIC_ID)));
                
                // Check and update expired appointments to 'missed'
                await checkAndUpdateExpiredAppointments();
                
                // Initialize Flatpickr date range picker
                initializeDateRangePicker();
                
                // Set default date range (last 7 days)
                setQuickRange('week');
            } catch (error) {
                console.error('Error loading analytics:', error);
                showToast('Error loading analytics', 'error');
            }
        }
        
        function initializeDateRangePicker() {
            dateRangePicker = flatpickr("#analytics-date-range", {
                mode: "range",
                dateFormat: "M d, Y",
                showMonths: 2,
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length === 2) {
                        const fromDate = selectedDates[0];
                        const toDate = selectedDates[1];
                        calculateAnalytics(fromDate, toDate);
                    }
                },
                onReady: function(selectedDates, dateStr, instance) {
                    // Customize the calendar appearance
                    instance.calendarContainer.classList.add('analytics-calendar');
                }
            });
        }
        
        function setQuickRange(range) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let fromDate;
            if (range === 'week') {
                // Last 7 days
                fromDate = new Date(today);
                fromDate.setDate(today.getDate() - 6);
            } else {
                // Last 30 days
                fromDate = new Date(today);
                fromDate.setDate(today.getDate() - 29);
            }
            
            // Set the date range in Flatpickr
            if (dateRangePicker) {
                dateRangePicker.setDate([fromDate, today], true);
            }
            
            // Calculate analytics
            calculateAnalytics(fromDate, today);
        }
        
        function calculateAnalytics(startDate, endDate) {
            // Filter appointments by date range
            const filteredAppointments = allAppointments.filter(apt => {
                const aptDate = new Date(apt.date);
                return aptDate >= startDate && aptDate <= endDate;
            });
            
            // Calculate metrics
            const total = filteredAppointments.length;
            const completed = filteredAppointments.filter(a => a.status === 'completed').length;
            const missed = filteredAppointments.filter(a => a.status === 'missed').length;
            const cancelled = filteredAppointments.filter(a => a.status === 'cancelled').length;
            const booked = filteredAppointments.filter(a => a.status === 'booked').length;
            const approve = filteredAppointments.filter(a => a.status === 'approve').length;
            const appointment = filteredAppointments.filter(a => a.status === 'appointment').length;
            
            const completedRate = total > 0 ? ((completed / total) * 100).toFixed(1) : 0;
            const missedRate = total > 0 ? ((missed / total) * 100).toFixed(1) : 0;
            
            const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            const avgPerDay = (total / daysDiff).toFixed(1);
            
            // Update overview cards
            document.getElementById('analytics-total').textContent = total;
            document.getElementById('analytics-completed').textContent = completed;
            document.getElementById('analytics-completed-rate').textContent = `${completedRate}% completion rate`;
            document.getElementById('analytics-missed').textContent = missed;
            document.getElementById('analytics-missed-rate').textContent = `${missedRate}% missed rate`;
            document.getElementById('analytics-avg-day').textContent = avgPerDay;
            
            // Status breakdown
            const statusCounts = {
                'booked': booked,
                'approve': approve,
                'appointment': appointment,
                'missed': missed,
                'cancelled': cancelled,
                'completed': completed
            };
            
            const statusColors = {
                'booked': 'bg-blue-500',
                'approve': 'bg-purple-500',
                'appointment': 'bg-green-500',
                'missed': 'bg-orange-500',
                'cancelled': 'bg-red-500',
                'completed': 'bg-gray-500'
            };
            
            const statusLabels = {
                'booked': 'Booked',
                'approve': 'Approve',
                'appointment': 'Appointment',
                'missed': 'Missed',
                'cancelled': 'Cancelled',
                'completed': 'Completed'
            };
            
            const statusBreakdownDiv = document.getElementById('status-breakdown');
            statusBreakdownDiv.innerHTML = Object.keys(statusCounts).map(status => {
                const count = statusCounts[status];
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-4 h-4 ${statusColors[status]} rounded"></div>
                            <span class="text-gray-700 font-medium">${statusLabels[status]}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-gray-800 font-bold">${count}</span>
                            <span class="text-gray-500 text-sm ml-2">(${percentage}%)</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Doctor performance
            const doctorStats = {};
            allDoctors.forEach(doctor => {
                const doctorAppointments = filteredAppointments.filter(a => a.doctorId === doctor.id);
                doctorStats[doctor.id] = {
                    name: doctor.name,
                    total: doctorAppointments.length,
                    completed: doctorAppointments.filter(a => a.status === 'completed').length
                };
            });
            
            const sortedDoctors = Object.values(doctorStats).sort((a, b) => b.total - a.total);
            
            const doctorPerformanceDiv = document.getElementById('doctor-performance');
            if (sortedDoctors.length > 0) {
                doctorPerformanceDiv.innerHTML = sortedDoctors.map(doctor => {
                    const completionRate = doctor.total > 0 ? ((doctor.completed / doctor.total) * 100).toFixed(1) : 0;
                    return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div>
                                <p class="text-gray-800 font-semibold">${doctor.name}</p>
                                <p class="text-xs text-gray-500">${doctor.completed} completed</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-primary">${doctor.total}</p>
                                <p class="text-xs text-gray-500">${completionRate}%</p>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                doctorPerformanceDiv.innerHTML = '<p class="text-gray-500 text-sm">No data available</p>';
            }
            
            // Generate detailed report table
            generateReportTable(startDate, endDate, filteredAppointments);
            
            // Update report title
            const fromStr = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const toStr = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            document.getElementById('report-title').textContent = `Report: ${fromStr} - ${toStr}`;
            
            // Store data for export
            analyticsData = {
                startDate,
                endDate: endDate,
                appointments: filteredAppointments,
                statusCounts,
                doctorStats: sortedDoctors
            };
        }
        
        function generateReportTable(startDate, endDate, appointments) {
            const tbody = document.getElementById('analytics-report-table');
            const dates = [];
            
            // Generate all dates in range
            const currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                dates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            let totalRow = { total: 0, booked: 0, approve: 0, appointment: 0, missed: 0, cancelled: 0, completed: 0 };
            
            const rows = dates.map(date => {
                const dateStr = date.toISOString().split('T')[0];
                const dayAppointments = appointments.filter(a => a.date === dateStr);
                
                const stats = {
                    total: dayAppointments.length,
                    booked: dayAppointments.filter(a => a.status === 'booked').length,
                    approve: dayAppointments.filter(a => a.status === 'approve').length,
                    appointment: dayAppointments.filter(a => a.status === 'appointment').length,
                    missed: dayAppointments.filter(a => a.status === 'missed').length,
                    cancelled: dayAppointments.filter(a => a.status === 'cancelled').length,
                    completed: dayAppointments.filter(a => a.status === 'completed').length
                };
                
                // Add to totals
                totalRow.total += stats.total;
                totalRow.booked += stats.booked;
                totalRow.approve += stats.approve;
                totalRow.appointment += stats.appointment;
                totalRow.missed += stats.missed;
                totalRow.cancelled += stats.cancelled;
                totalRow.completed += stats.completed;
                
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm text-gray-800 font-medium">${dayName}, ${formattedDate}</td>
                        <td class="px-6 py-4 text-sm text-gray-800 font-bold">${stats.total}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${stats.booked}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${stats.approve}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${stats.appointment}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${stats.missed}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${stats.cancelled}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${stats.completed}</td>
                    </tr>
                `;
            }).join('');
            
            // Add summary row
            const summaryRow = `
                <tr class="bg-blue-50 font-bold">
                    <td class="px-6 py-4 text-sm text-gray-800">TOTAL</td>
                    <td class="px-6 py-4 text-sm text-primary">${totalRow.total}</td>
                    <td class="px-6 py-4 text-sm text-gray-800">${totalRow.booked}</td>
                    <td class="px-6 py-4 text-sm text-gray-800">${totalRow.approve}</td>
                    <td class="px-6 py-4 text-sm text-gray-800">${totalRow.appointment}</td>
                    <td class="px-6 py-4 text-sm text-gray-800">${totalRow.missed}</td>
                    <td class="px-6 py-4 text-sm text-gray-800">${totalRow.cancelled}</td>
                    <td class="px-6 py-4 text-sm text-gray-800">${totalRow.completed}</td>
                </tr>
            `;
            
            tbody.innerHTML = rows + summaryRow;
        }
        
        function exportAnalyticsToCSV() {
            if (!analyticsData.appointments) {
                showToast('No data to export', 'warning');
                return;
            }
            
            const period = 'Custom Range';
            const startDate = analyticsData.startDate.toLocaleDateString();
            const endDate = analyticsData.endDate.toLocaleDateString();
            
            // CSV Header
            let csv = `Clinic Analytics Report - ${period}\\n`;
            csv += `Period: ${startDate} to ${endDate}\\n\\n`;
            
            // Summary
            csv += `Summary\\n`;
            csv += `Total Appointments,${analyticsData.appointments.length}\\n`;
            csv += `Completed,${analyticsData.statusCounts.completed}\\n`;
            csv += `Missed,${analyticsData.statusCounts.missed}\\n`;
            csv += `Cancelled,${analyticsData.statusCounts.cancelled}\\n\\n`;
            
            // Doctor Performance
            csv += `Doctor Performance\\n`;
            csv += `Doctor Name,Total Appointments,Completed\\n`;
            analyticsData.doctorStats.forEach(doctor => {
                csv += `${doctor.name},${doctor.total},${doctor.completed}\\n`;
            });
            csv += `\\n`;
            
            // Detailed Appointments
            csv += `Detailed Appointments\\n`;
            csv += `Date,Patient Name,Doctor,Status\\n`;
            analyticsData.appointments.forEach(apt => {
                const doctor = allDoctors.find(d => d.id === apt.doctorId);
                csv += `${apt.date},${apt.patientName},${doctor ? doctor.name : 'N/A'},${apt.status}\\n`;
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `clinic-analytics-${period.toLowerCase()}-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast('Analytics exported successfully', 'success');
        }
        
        // Calendar Functions
        async function loadCalendar() {
            try {
                const doctorFilter = document.getElementById('calendar-doctor-filter').value;
                
                // Load doctors if not already loaded
                if (allDoctors.length === 0) {
                    const allDoctorsSnap = await db.collection('users').where('role', '==', 'doctor').get();
                    // Filter doctors by clinic (check both clinicId and clinicIds)
                    allDoctors = allDoctorsSnap.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(d => d.clinicId === CLINIC_ID || (d.clinicIds && d.clinicIds.includes(CLINIC_ID)));
                    
                    // Populate calendar doctor filter
                    const calendarDoctorFilter = document.getElementById('calendar-doctor-filter');
                    if (calendarDoctorFilter) {
                        calendarDoctorFilter.innerHTML = '<option value="">All Doctors</option>' + 
                            allDoctors.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                    }
                }
                
                // Always filter by CLINIC_ID
                let query = db.collection('appointments').where('clinicId', '==', CLINIC_ID);
                
                if (doctorFilter) {
                    query = query.where('doctorId', '==', doctorFilter);
                }
                
                const snapshot = await query.get();
                calendarAppointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                renderCalendar();
            } catch (error) {
                console.error('Error loading calendar:', error);
                showToast('Error loading calendar', 'error');
            }
        }
        
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Set month/year title
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'aspect-square';
                grid.appendChild(emptyCell);
            }
            
            // Add day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                date.setHours(0, 0, 0, 0);
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // Count appointments for this day
                const dayAppointments = calendarAppointments.filter(apt => apt.date === dateStr);
                const count = dayAppointments.length;
                
                // Determine if today
                const isToday = date.getTime() === today.getTime();
                
                // Create day cell
                const dayCell = document.createElement('div');
                dayCell.className = `aspect-square border-2 rounded-lg p-2 cursor-pointer transition-all hover:shadow-md ${
                    isToday ? 'border-primary bg-blue-50' : 'border-gray-200 hover:border-primary'
                }`;
                
                dayCell.innerHTML = `
                    <div class="text-right font-semibold ${isToday ? 'text-primary' : 'text-gray-700'}">${day}</div>
                    ${count > 0 ? `
                        <div class="mt-1 text-center">
                            <div class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-primary text-white text-xs font-bold">
                                ${count}
                            </div>
                        </div>
                    ` : ''}
                `;
                
                if (count > 0) {
                    dayCell.onclick = () => showDayAppointments(dateStr, dayAppointments);
                }
                
                grid.appendChild(dayCell);
            }
        }
        
        function showDayAppointments(dateStr, appointments) {
            const date = new Date(dateStr + 'T00:00:00');
            const formattedDate = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('selected-day-title').textContent = `${formattedDate} - ${appointments.length} Appointments`;
            
            const list = document.getElementById('day-appointments-list');
            list.innerHTML = appointments.map(apt => {
                const doctor = allDoctors.find(d => d.id === apt.doctorId);
                const statusColors = {
                    booked: 'bg-blue-100 text-blue-800',
                    approve: 'bg-purple-100 text-purple-800',
                    appointment: 'bg-green-100 text-green-800',
                    missed: 'bg-orange-100 text-orange-800',
                    cancelled: 'bg-red-100 text-red-800',
                    completed: 'bg-gray-100 text-gray-800'
                };
                
                return `
                    <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-primary transition cursor-pointer" onclick="viewAppointmentDetails('${apt.id}')">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-bold text-gray-800">${apt.patientName}</div>
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColors[apt.status] || 'bg-gray-100 text-gray-800'}">
                                ${apt.status.toUpperCase()}
                            </span>
                        </div>
                        <div class="text-sm text-gray-600">
                            <div><i class="fas fa-clock mr-2"></i>${apt.startTime || 'No time set'}</div>
                            <div><i class="fas fa-user-md mr-2"></i>${doctor ? doctor.name : 'Unknown Doctor'}</div>
                            <div><i class="fas fa-phone mr-2"></i>${apt.patientPhone}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('day-appointments').classList.remove('hidden');
            
            // Scroll to appointments
            document.getElementById('day-appointments').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function closeDayView() {
            document.getElementById('day-appointments').classList.add('hidden');
        }
        
        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        }
        
        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        }
        
        function goToToday() {
            currentCalendarDate = new Date();
            renderCalendar();
        }
        
        async function viewAppointmentDetails(id) {
            // Show loading modal
            const loadingModal = document.createElement('div');
            loadingModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingModal.innerHTML = `
                <div class="bg-white rounded-xl p-8 text-center">
                    <i class="fas fa-spinner fa-spin text-primary text-4xl mb-4"></i>
                    <p class="text-gray-700 font-semibold">Loading appointment details...</p>
                </div>
            `;
            document.getElementById('modal-container').appendChild(loadingModal);
            
            try {
                const aptDoc = await db.collection('appointments').doc(id).get();
                if (!aptDoc.exists) {
                    showToast('Appointment not found', 'error');
                    loadingModal.remove();
                    return;
                }
                
                const apt = { id: aptDoc.id, ...aptDoc.data() };
                const doctor = allDoctors.find(d => d.id === apt.doctorId);
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="bg-gradient-to-r from-primary to-blue-600 text-white p-6 rounded-t-xl">
                            <div class="flex items-center justify-between">
                                <h3 class="text-2xl font-bold flex items-center">
                                    <i class="fas fa-calendar-check mr-3"></i>Appointment Details
                                </h3>
                                <button onclick="closeModal()" class="text-white hover:text-gray-200 text-2xl">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid md:grid-cols-2 gap-4 mb-4">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                        <i class="fas fa-user text-primary mr-2"></i>Patient Information
                                    </h4>
                                    <p class="text-sm text-gray-700 mb-1"><strong>Name:</strong> ${apt.patientName}</p>
                                    <p class="text-sm text-gray-700 mb-1"><strong>Phone:</strong> ${apt.patientPhone || 'N/A'}</p>
                                    <p class="text-sm text-gray-700"><strong>Email:</strong> ${apt.patientEmail || 'N/A'}</p>
                                </div>
                                
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                        <i class="fas fa-user-md text-primary mr-2"></i>Doctor Information
                                    </h4>
                                    <p class="text-sm text-gray-700 mb-1"><strong>Doctor:</strong> ${doctor ? doctor.name : 'Unknown'}</p>
                                    <p class="text-sm text-gray-700"><strong>Email:</strong> ${doctor ? doctor.email : 'N/A'}</p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-clock text-primary mr-2"></i>Appointment Schedule
                                </h4>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <p class="text-sm text-gray-700"><strong>Date:</strong> ${apt.date}</p>
                                    <p class="text-sm text-gray-700"><strong>Time:</strong> ${apt.startTime || 'N/A'} - ${apt.endTime || 'N/A'}</p>
                                    <p class="text-sm text-gray-700"><strong>Duration:</strong> ${apt.duration || 'N/A'} min</p>
                                </div>
                            </div>
                            
                            ${apt.symptoms ? `
                                <div class="bg-yellow-50 rounded-lg p-4 mb-4">
                                    <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                                        <i class="fas fa-notes-medical text-yellow-600 mr-2"></i>Symptoms / Reason
                                    </h4>
                                    <p class="text-sm text-gray-700">${apt.symptoms}</p>
                                </div>
                            ` : ''}
                            
                            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                                    <i class="fas fa-info-circle text-primary mr-2"></i>Status Information
                                </h4>
                                <span class="px-3 py-1 rounded-full text-sm font-semibold ${getStatusColor(apt.status)}">${apt.status.toUpperCase()}</span>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-6 rounded-b-xl flex justify-end">
                            <button onclick="closeModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition font-semibold">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                // Remove loading modal and show appointment modal
                loadingModal.remove();
                document.getElementById('modal-container').appendChild(modal);
            } catch (error) {
                console.error('Error viewing appointment:', error);
                loadingModal.remove();
                showToast('Error loading appointment details', 'error');
            }
        }
        
        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
        }
    </script>
</body>
</html>
